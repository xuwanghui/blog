<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.font.im/css?family=HarmonyOS_Regular:300,300italic,400,400italic,700,700italic|JetBrains Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="uniapp直播app全栈开发 uni-app 是一个使用 Vue.js 开发所有前端应用的框架，开发者编写一套代码，可发布到iOS、Android、Web（响应式）、以及各种小程序 uni-app在手，做啥都不愁。即使不跨端，uni-app也是更好的小程序开发框架（详见）、更好的App跨平台框架、更方便的H5开发框架 一套代码编到十几个平台，这不是梦想，眼见为实，扫描以下二维码，亲自体验最全面的">
<meta property="og:type" content="article">
<meta property="og:title" content="uniapp 学习">
<meta property="og:url" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/index.html">
<meta property="og:site_name" content="老许的欢乐世界">
<meta property="og:description" content="uniapp直播app全栈开发 uni-app 是一个使用 Vue.js 开发所有前端应用的框架，开发者编写一套代码，可发布到iOS、Android、Web（响应式）、以及各种小程序 uni-app在手，做啥都不愁。即使不跨端，uni-app也是更好的小程序开发框架（详见）、更好的App跨平台框架、更方便的H5开发框架 一套代码编到十几个平台，这不是梦想，眼见为实，扫描以下二维码，亲自体验最全面的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192251944.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192329137.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192354083.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192542004.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192609468.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192631417.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240403083223403.png">
<meta property="og:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240403083253974.png">
<meta property="article:published_time" content="2024-11-27T09:08:01.520Z">
<meta property="article:modified_time" content="2024-12-27T08:17:32.961Z">
<meta property="article:author" content="老许">
<meta property="article:tag" content="uniapp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/image-20240331192251944.png">

<link rel="canonical" href="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<link rel="preconnect" href="https://s1.hdslb.com/" />
<link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" media="all" onload="this.media='all'" />
<link rel="stylesheet" href="//s1.hdslb.com/bfs/static/jinkela/long/font/medium.css" media="all" onload="this.media='all'" />

  <title>uniapp 学习 | 老许的欢乐世界</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="老许的欢乐世界" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a href="https://github.com/xuwanghui" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">老许的欢乐世界</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">愿与上善 唯望君安</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">14</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a>

  </li>
        <li class="menu-item menu-item-comments">

    <a href="/comments/" rel="section"><i class="fa fa-comments fa-fw"></i>留言板</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    <!--看板娘-->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.7.2/css/fontawesome.min.css"/>
    <script src="/live2d-widget/autoload.js"></script>
    <!--<script src="https://cdn.jsdelivr.net/gh/xuwanghui/live2d-widget/autoload.js"></script>-->

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="老许">
      <meta itemprop="description" content="当学习成为了习惯<br/>知识也就变成了常识">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老许的欢乐世界">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          uniapp 学习
        </h1>

        <div class="post-meta">
        
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-11-27 17:08:01" itemprop="dateCreated datePublished" datetime="2024-11-27T17:08:01+08:00">2024-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-27 16:17:32" itemprop="dateModified" datetime="2024-12-27T16:17:32+08:00">2024-12-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uniapp/" itemprop="url" rel="index"><span itemprop="name">uniapp</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/11/27/uniapp/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/11/27/uniapp/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>176k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2:40</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="uniapp直播app全栈开发">uniapp直播app全栈开发</h4>
<p><code>uni-app</code> 是一个使用 <a target="_blank" rel="noopener" href="https://vuejs.org/">Vue.js</a> 开发所有前端应用的框架，开发者编写一套代码，可发布到iOS、Android、Web（响应式）、以及各种小程序</p>
<p><code>uni-app</code>在手，做啥都不愁。即使不跨端，<code>uni-app</code>也是更好的小程序开发框架（<a target="_blank" rel="noopener" href="https://ask.dcloud.net.cn/article/35947">详见</a>）、更好的App跨平台框架、更方便的H5开发框架</p>
<p><a target="_blank" rel="noopener" href="https://uniapp.dcloud.net.cn/">一套代码编到十几个平台，这不是梦想，眼见为实，扫描以下二维码，亲自体验最全面的跨平台效果！</a></p>
<span id="more"></span>
<p><img data-src="image-20240331192251944.png" alt="image-20240331192251944"></p>
<p><img data-src="image-20240331192329137.png" alt="image-20240331192329137"></p>
<p><img data-src="image-20240331192354083.png" alt="image-20240331192354083"></p>
<h4 id="课程大纲">课程大纲</h4>
<p><img data-src="image-20240331192542004.png" alt="image-20240331192542004"></p>
<h4 id="课程特色">课程特色</h4>
<p><img data-src="image-20240331192609468.png" alt="image-20240331192609468"></p>
<p><img data-src="image-20240331192631417.png" alt="image-20240331192631417"></p>
<h4 id="前端项目创建">前端项目创建</h4>
<ul>
<li>新建默认模板项目</li>
<li>引入全局样式文件</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">    <span class="comment">/*每个页面公共css */</span></span><br><span class="line">    <span class="keyword">@import</span> url(<span class="string">&#x27;common/free.css&#x27;</span>);</span><br><span class="line">    <span class="keyword">@import</span> url(<span class="string">&#x27;common/common.css&#x27;</span>);</span><br><span class="line">    <span class="comment">/* #ifndef APP-NVUE */</span></span><br><span class="line">    <span class="keyword">@import</span> url(<span class="string">&#x27;common/iconfont.css&#x27;</span>);</span><br><span class="line">    <span class="comment">/* #endif */</span></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>引入图标库</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">onLaunch</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> domModule = uni.requireNativePlugin(<span class="string">&#x27;dom&#x27;</span>)</span><br><span class="line">    domModule.<span class="title function_">addRule</span>(<span class="string">&#x27;fontFace&#x27;</span>, &#123;</span><br><span class="line">        <span class="string">&#x27;fontFamily&#x27;</span>: <span class="string">&quot;iconfont&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;src&#x27;</span>: <span class="string">&quot;url(&#x27;http://at.alicdn.com/t/c/font_4489745_elaicw45h77.ttf?t=1711886201103&#x27;)&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">测试</span><br><span class="line">&lt;text <span class="keyword">class</span>=<span class="string">&quot;iconfont&quot;</span>&gt;&amp;#xe619;&lt;/text&gt;</span><br></pre></td></tr></table></figure>
<h5 id="底部导航栏配置">底部导航栏配置</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;tabBar&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;color&quot;</span>:<span class="string">&quot;#707070&quot;</span>,</span><br><span class="line">    <span class="string">&quot;selectedColor&quot;</span>:<span class="string">&quot;#8745FF&quot;</span>,</span><br><span class="line">    <span class="string">&quot;backgroundColor&quot;</span>:<span class="string">&quot;#FFFFFF&quot;</span>,</span><br><span class="line">    <span class="string">&quot;borderStyle&quot;</span>:<span class="string">&quot;black&quot;</span>,</span><br><span class="line">    <span class="string">&quot;midButton&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;iconPath&quot;</span>:<span class="string">&quot;static/tabbar/min.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iconWidth&quot;</span>:<span class="string">&quot;60px&quot;</span>,</span><br><span class="line">        <span class="string">&quot;height&quot;</span>:<span class="string">&quot;65px&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;list&quot;</span>:[&#123;</span><br><span class="line">        <span class="string">&quot;iconPath&quot;</span>:<span class="string">&quot;./static/tabbar/find.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;selectedIconPath&quot;</span>:<span class="string">&quot;static/tabbar/find-selected.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pagePath&quot;</span>:<span class="string">&quot;pages/index/index&quot;</span>,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>:<span class="string">&quot;发现&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="string">&quot;iconPath&quot;</span>:<span class="string">&quot;static/tabbar/my.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;selectedIconPath&quot;</span>:<span class="string">&quot;static/tabbar/my-selected.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;pagePath&quot;</span>:<span class="string">&quot;pages/my/my&quot;</span>,</span><br><span class="line">        <span class="string">&quot;text&quot;</span>:<span class="string">&quot;我的&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听midButton</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">onLaunch</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="comment">// 监听底部导航中间凸起按钮</span></span><br><span class="line">	uni.<span class="title function_">onTabBarMidButtonTap</span>(<span class="function">()=&gt;</span> &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;点击了中间按钮&#x27;</span>);</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h5 id="首页开发">首页开发</h5>
<p><img data-src="image-20240403083223403.png" alt="image-20240403083223403"></p>
<p>pages.json</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;pages/index/index&quot;</span>,</span><br><span class="line">    <span class="string">&quot;style&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enablePullDownRefresh&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;app-plus&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;titleNView&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;titleText&quot;</span>:<span class="string">&quot;直播&quot;</span>,</span><br><span class="line">                <span class="string">&quot;titleAlign&quot;</span>:<span class="string">&quot;left&quot;</span>,</span><br><span class="line">                <span class="string">&quot;buttons&quot;</span>:[&#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>:<span class="string">&quot;menu&quot;</span></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>轮播图</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">swiper</span> <span class="attr">:indicator-dots</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:autoplay</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:interval</span>=<span class="string">&quot;3000&quot;</span> <span class="attr">:duration</span>=<span class="string">&quot;200&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/img/banner/1.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/img/banner/2.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">swiper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>列表</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-wrap&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 375rpx; padding: 5rpx;box-sizing: border-box; position: relative;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/logo.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 365rpx; height: 365rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;aspectFill&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute;left: 15rpx;top: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont icon-bizhongguanli text-warning mr-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute;right: 15rpx;top: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-sm text-white&quot;</span>&gt;</span>人气：<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute;left: 15rpx;bottom: 15rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>标题<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute;right: 15rpx;bottom: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">style</span>=<span class="string">&quot;width: 20rpx;height: 20rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle mr-1 bg-danger&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>已结束<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="直播间开发">直播间开发</h5>
<p><img data-src="image-20240403083253974.png" alt="image-20240403083253974"></p>
<ul>
<li>引入动画</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="基础布局">基础布局</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;page&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">video</span> <span class="attr">class</span>=<span class="string">&quot;flex-1&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://qiniu-web-assets.dcloud.net.cn/unidoc/zh/uni-app-video-courses.mp4&quot;</span> <span class="attr">auto-play</span> <span class="attr">controls</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 头部 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;right: 0;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- 个人信息 观看详细信息 --&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-info&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- 金币 --&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-dark&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- 收到的礼物 --&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 500rpx;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 500rpx; width: 520rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-main&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 弹幕 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; bottom: 120rpx; left: 0; right: 0; width: 520rpx; height: 300rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-primary&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 底部 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;bottom: 0;right: 0;height: 120rpx;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">	<span class="attr">class</span>=<span class="string">&quot;flex align-center justify-between bg-danger&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">// 导航栏高度</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">// statusBarHeight: 0</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">onLoad</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// 获取导航栏高度</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// let res = uni.getSystemInfoSync()</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// this.statusBarHeight = res.statusBarHeight</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.page</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">	<span class="attribute">flex</span>: <span class="number">1</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">	<span class="comment">/* #ifdef H5 */</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">	<span class="attribute">height</span>: <span class="number">100vh</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">	<span class="comment">/* #endif */</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h6 id="个人信息和观看情况">个人信息和观看情况</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 个人信息 观看详细信息 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;px-2 flex justify-between align-center&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 左边 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-row justify-between align-center rounded-circle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p flex-row&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/tabbar/min.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>老许<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center justify-center bg-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white text-center&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 右边 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 实时在线观看用户情况 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-x</span>=<span class="string">&quot;true&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;i in 5&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;i&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/tabbar/min.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center justify-center bg-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 实时在线观看人数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>&#123;&#123; 1000 &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="金币">金币</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 金币 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;px-2 my-2&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle align-center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning&quot;</span>&gt;</span>金币<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="接收礼物组件">接收礼物组件</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 收到的礼物 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">style</span>=<span class="string">&quot;width: 520rpx;height: 500rpx;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center px-3 pt-3&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-image: linear-gradient(to right, #BCABB1 , #65AAF0);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/logo.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>哈哈哈<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>送小花<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/tabbar/find-selected.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning font-lg ml-1&quot;</span>&gt;</span>X 100<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="封装接收礼物组件">封装接收礼物组件</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">components/live/gift.<span class="property">vue</span></span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">list</span> <span class="attr">style</span>=<span class="string">&quot;height: 500rpx; width: 520rpx;&quot;</span> <span class="attr">:show-scrollbar</span>=<span class="string">&quot;false&quot;</span> <span class="attr">:bounce</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">cell</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center px-3 pt-3&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item, index) in gifts&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span> <span class="attr">:ref</span>=<span class="string">&quot;&#x27;gift&#x27;+index&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-image: linear-gradient(to right, #BCABB1 , #65AAF0);&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.avatar || defaultAvatar&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>&#123;&#123;item.username&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>送&#123;&#123;item.gift&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.giftImg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning font-lg ml-1&quot;</span>&gt;</span>X &#123;&#123;item.giftNum&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">cell</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">cell</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sendGift&quot;</span>&gt;</span>送礼<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">cell</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">list</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">const</span> dom = uni.requireNativePlugin(<span class="string">&#x27;dom&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="attr">defaultAvatar</span>: <span class="string">&#x27;/static/img/1.jpg&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="attr">gifts</span>: []</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// 送礼</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">sendGift</span>(<span class="params">gift</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.<span class="property">gifts</span>.<span class="title function_">push</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">id</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(-<span class="number">8</span>),</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">username</span>: <span class="string">&quot;小姐姐&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">avatar</span>: <span class="string">&quot;/static/img/2.jpg&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">gift</span>: <span class="string">&quot;小心心&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">giftImg</span>: <span class="string">&quot;/static/gift/7.png&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">giftNum</span>: <span class="number">100</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 调用滚动到指定位置</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="title function_">scrollTo</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 自动移除第一个元素</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.<span class="title function_">autoRemove</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// 滚动到指定位置</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">scrollTo</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> index = <span class="variable language_">this</span>.<span class="property">gifts</span>.<span class="property">length</span> - <span class="number">1</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> ref = <span class="string">&#x27;gift&#x27;</span> + index</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">$refs</span>[ref]) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        dom.<span class="title function_">scrollToElement</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>[ref][<span class="number">0</span>], &#123;&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// 自动移除第一个元素</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">autoRemove</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">gifts</span>.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;, <span class="number">5000</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">   &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最后将sendGift方法暴露给live.nvue使用即可</span></span><br></pre></td></tr></table></figure>
<h6 id="底部导航栏">底部导航栏</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 底部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;bottom: 0;right: 0;height: 120rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-between&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;px-2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn px-3&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openInput&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>说点什么...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 40px;&quot;</span>&gt;</span><span class="symbol">&amp;#xe620;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon bg-warning&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont&quot;</span>&gt;</span><span class="symbol">&amp;#xe63e;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon&quot;</span> @<span class="attr">click</span>=<span class="string">&#x27;back&#x27;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white&quot;</span>&gt;</span><span class="symbol">&amp;#xeaf2;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.btn</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">height</span>: <span class="number">80</span>rpx;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">border-radius</span>: <span class="number">100</span>rpx;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.12</span>);</span></span><br><span class="line"><span class="language-css">    <span class="attribute">align-items</span>: center;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">justify-content</span>: center;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.btn-icon</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span>: <span class="number">80</span>rpx;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">margin-right</span>: <span class="number">20</span>rpx;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 封装成组件</span><br></pre></td></tr></table></figure>
<h6 id="导航栏关闭按钮">导航栏关闭按钮</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 底部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;bottom: 0;right: 0;height: 120rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn px-5&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-right: 220rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openInput&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;b1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>说点什么...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;b2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 40px;&quot;</span>&gt;</span><span class="symbol">&amp;#xe620;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon bg-warning&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;b3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont&quot;</span>&gt;</span><span class="symbol">&amp;#xe63e;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-icon&quot;</span> @<span class="attr">click</span>=<span class="string">&#x27;clickBtn&#x27;</span> <span class="attr">ref</span>=<span class="string">&quot;main_btn&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;main_image&quot;</span>&gt;</span><span class="symbol">&amp;#xeaf2;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title class_">Binding</span> = uni.requireNativePlugin(<span class="string">&#x27;bindingx&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 控制展开收缩</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">isExpanded</span>: <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">getEl</span>: <span class="keyword">function</span>(<span class="params">el</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> el === <span class="string">&#x27;number&#x27;</span>) <span class="keyword">return</span> el;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="title class_">WXEnvironment</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> el.<span class="property">ref</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> el <span class="keyword">instanceof</span> <span class="title class_">HTMLElement</span> ? el : el.<span class="property">$el</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">collapse</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_btn = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">main_btn</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_image = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">main_image</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b1 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b1</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b2 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b2</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b3 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b3</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_binding = <span class="title class_">Binding</span>.<span class="title function_">bind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">exitExpression</span>: <span class="string">&#x27;t&gt;800&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">props</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: main_image,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.rotateZ&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&#x27;easeOutQuint(t,45,0-45,800)&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: main_btn,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;background-color&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;evaluateColor(&#x27;#607D8B&#x27;,&#x27;#ff0000&#x27;,min(t,800)/800)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;]</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (res.<span class="property">state</span> === <span class="string">&#x27;exit&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Binding</span>.<span class="title function_">unbind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">token</span>: main_binding.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> btn_binding = <span class="title class_">Binding</span>.<span class="title function_">bind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">exitExpression</span>: <span class="string">&#x27;t&gt;800&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">props</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b1,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;easeOutQuint(t,-150,150,-550)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b2,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;t&lt;=100?0:easeOutQuint(t-100,-300,300,-450)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b3,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;t&lt;=200?0:easeOutQuint(t-200,-450,450,-350)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;]</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (res.<span class="property">state</span> === <span class="string">&#x27;exit&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Binding</span>.<span class="title function_">unbind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">token</span>: btn_binding.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">expand</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_btn = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">main_btn</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_image = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">main_image</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b1 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b1</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b2 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b2</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> b3 = <span class="variable language_">this</span>.<span class="title function_">getEl</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">b3</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> main_binding = <span class="title class_">Binding</span>.<span class="title function_">bind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">exitExpression</span>: <span class="string">&#x27;t&gt;100&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">props</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: main_image,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.rotateZ&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&#x27;linear(t,0,45,100)&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: main_btn,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;background-color&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;evaluateColor(&#x27;#ff0000&#x27;,&#x27;#607D8B&#x27;,min(t,100)/100)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;]</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (res.<span class="property">state</span> === <span class="string">&#x27;exit&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Binding</span>.<span class="title function_">unbind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">token</span>: main_binding.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> btn_binding = <span class="title class_">Binding</span>.<span class="title function_">bind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">exitExpression</span>: <span class="string">&#x27;t&gt;800&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">props</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b1,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;easeOutBounce(t,0,550,800)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b2,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;t&lt;=100?0:easeOutBounce(t-100,0,450,700)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">element</span>: b3,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">property</span>: <span class="string">&#x27;transform.translateX&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">expression</span>: <span class="string">&quot;t&lt;=200?0:easeOutBounce(t-200,0,300,600)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;]</span></span><br><span class="line"><span class="language-javascript">        &#125;, <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (res.<span class="property">state</span> === <span class="string">&#x27;exit&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title class_">Binding</span>.<span class="title function_">unbind</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">token</span>: btn_binding.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">eventType</span>: <span class="string">&#x27;timing&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">clickBtn</span>: <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isExpanded</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">collapse</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="title function_">expand</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">isExpanded</span> = !<span class="variable language_">this</span>.<span class="property">isExpanded</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="弹幕组件">弹幕组件</h6>
<p><a target="_blank" rel="noopener" href="https://uniapp.dcloud.net.cn/component/uniui/uni-popup.html#uni-popup-%E5%BC%B9%E5%87%BA%E5%B1%82"><strong>popup弹出层</strong></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 底部弹出层 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">ref</span>=<span class="string">&quot;popup&quot;</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white flex align-center px-3&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;content&quot;</span> <span class="attr">class</span>=<span class="string">&quot;border rounded flex-1 px-3 font-md&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;说点什么...&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 ml-3 rounded&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;content === &#x27;&#x27; ? &#x27;bg-main-disabled&#x27; : &#x27;bg-main&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-white&quot;</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="attr">methods</span>: &#123;</span><br><span class="line">  <span class="comment">// 关闭指定的弹出层</span></span><br><span class="line">  <span class="title function_">close</span>(<span class="params">str</span>) &#123;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">$refs</span>[str].<span class="title function_">close</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">openInput</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">open</span>(<span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">submit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">content</span>.<span class="title function_">trim</span>() == <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">barrageCom</span>.<span class="title function_">sendBarrage</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(-<span class="number">8</span>),</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&#x27;河南匿名吴彦祖&#x27;</span>,</span><br><span class="line">        <span class="attr">content</span>: <span class="variable language_">this</span>.<span class="property">content</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">content</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">close</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">back</span>(<span class="params"></span>)&#123;</span><br><span class="line">    uni.<span class="title function_">navigateBack</span>(&#123;<span class="attr">delta</span>:<span class="number">1</span>&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>弹幕</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 弹幕 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; bottom: 120rpx; left: 0; right: 0; width: 520rpx; height: 300rpx;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span>=<span class="string">&quot;true&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 520rpx;height: 300rpx;&quot;</span> <span class="attr">scroll-with-animation</span> <span class="attr">class</span>=<span class="string">&quot;pl-3&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">:scroll-into-view</span>=<span class="string">&quot;scrollInToView&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>  <span class="attr">class</span>=<span class="string">&quot;flex justify-start align-start rounded p-2 mb-2&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">&quot;background-color: rgba(255,255,255,0.125);&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;i in 5&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;i&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md text-danger&quot;</span>&gt;</span>骑着蜗牛泡妞：<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md text-white&quot;</span>&gt;</span>小姐姐你好鸭<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>提取成组件barrage.vue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; bottom: 120rpx; left: 0; right: 0; height: 300rpx; width: 580rpx;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-y</span> <span class="attr">style</span>=<span class="string">&quot;height: 300rpx;&quot;</span> <span class="attr">scroll-with-animation</span> <span class="attr">class</span>=<span class="string">&quot;pl-3&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">				<span class="attr">:scroll-into-view</span>=<span class="string">&quot;scrollInToView&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex justify-start align-start rounded mb-2&quot;</span> <span class="attr">style</span>=<span class="string">&quot;background-color: rgba(255,255,255,0.125)&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">					<span class="attr">v-for</span>=<span class="string">&quot;item in barrageList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span> <span class="attr">:id</span>=<span class="string">&quot;&#x27;danmu&#x27;+ item.id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">						<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md text-white flex flex-wrap&quot;</span> <span class="attr">style</span>=<span class="string">&quot;word-break: break-all; width: 580rpx;&quot;</span>&gt;</span>&#123;&#123;item.username&#125;&#125;：&#123;&#123;item.brrage&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">scrollInToView</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">barrageList</span>: [&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">id</span>: <span class="number">1</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">username</span>: <span class="string">&#x27;骑着蜗牛泡妞&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">content</span>: <span class="string">&#x27;小姐姐你好鸭&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">id</span>: <span class="number">2</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">username</span>: <span class="string">&#x27;河南吴彦祖&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">content</span>: <span class="string">&#x27;小姐姐单身吗&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">id</span>: <span class="number">3</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">username</span>: <span class="string">&#x27;京城彭于晏&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="attr">content</span>: <span class="string">&#x27;小姐姐处对象吗&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;]</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">let</span> id = <span class="number">3</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">barrageList</span>.<span class="title function_">push</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            id,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">username</span>: <span class="string">&#x27;河南匿名吴彦祖&#x27;</span> + id,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">content</span>: <span class="string">&#x27;讲真的老许比老何帅!&#x27;</span> + id</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// 置于底部</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="title function_">toBottom</span>()</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        id++</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;, <span class="number">3000</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">toBottom</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">let</span> len = <span class="variable language_">this</span>.<span class="property">barrageList</span>.<span class="property">length</span> - <span class="number">1</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">if</span> (len &gt; <span class="number">0</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">barrageList</span>[len]) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">             <span class="variable language_">this</span>.<span class="property">scrollInToView</span> = <span class="string">&#x27;danmu&#x27;</span> + <span class="variable language_">this</span>.<span class="property">barrageList</span>[len].<span class="property">id</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;, <span class="number">300</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最后将sendBarrage方法暴露给live.nvue使用即可</span></span><br></pre></td></tr></table></figure>
<h6 id="送礼物组件">送礼物组件</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 送礼物弹出层 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;giftPopup&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 550rpx;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex justify-between align-center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-main font-md ml-3&quot;</span>&gt;</span>礼物<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100rpx;height: 100rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;closeGift&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont&quot;</span>&gt;</span><span class="symbol">&amp;#xe607;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">swiper</span> <span class="attr">:indicator-dots</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:duration</span>=<span class="string">&quot;500&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 350rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;border-bottom border-top&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-wrap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 187.5rpx;height: 175rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column justify-center align-center&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in gifts&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;giftActiveId === item.id ? &#x27;border border-main&#x27; : &#x27;&#x27;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    @<span class="attr">click</span>=<span class="string">&quot;giftActiveId = item.id&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.image&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100rpx;height: 100rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex mt-1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning font mr-1&quot;</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-secondary font&quot;</span>&gt;</span>&#123;&#123;item.coin&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">swiper</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-end&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 mr-3 rounded bg-warning&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openCoin&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font&quot;</span>&gt;</span>充值<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 mr-3 rounded bg-main&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;sendGift&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-white&quot;</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">gifts</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/1.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;鸡蛋&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/2.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;666&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/3.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;雪糕&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/4.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;龙虾&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">4</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/5.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;精灵球&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">5</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/6.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">6</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;胶囊&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">6</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/7.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">7</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;爱心&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">7</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: <span class="string">&quot;/static/gift/8.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;花&quot;</span>,</span><br><span class="line">        <span class="string">&quot;coin&quot;</span>: <span class="number">8</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">giftActiveId</span>: <span class="number">0</span>,</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>&#123;</span><br><span class="line"><span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">back</span>(<span class="params"></span>) &#123;</span><br><span class="line">        uni.<span class="title function_">navigateBack</span>(&#123;</span><br><span class="line">            <span class="attr">delta</span>: <span class="number">1</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">openGift</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">giftPopup</span>.<span class="title function_">open</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">sendGift</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">giftActiveId</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;请选择要发送的礼物&#x27;</span>,</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="variable language_">this</span>.<span class="property">gifts</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span> === <span class="variable language_">this</span>.<span class="property">giftActiveId</span>)</span><br><span class="line">        <span class="keyword">if</span> (index === -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> g = <span class="variable language_">this</span>.<span class="property">gifts</span>[index]</span><br><span class="line">        <span class="comment">// 发送礼物</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">giftCom</span>.<span class="title function_">sendGift</span>(&#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(-<span class="number">8</span>),</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&quot;小姐姐&quot;</span>,</span><br><span class="line">            <span class="attr">avatar</span>: <span class="string">&quot;/static/img/2.jpg&quot;</span>,</span><br><span class="line">            <span class="attr">gift</span>: g.<span class="property">name</span>,</span><br><span class="line">            <span class="attr">giftImg</span>: g.<span class="property">image</span>,</span><br><span class="line">            <span class="attr">giftNum</span>: <span class="number">1</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">giftActiveId</span> = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">closeGift</span>(<span class="string">&#x27;giftPopup&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="充值金币页">充值金币页</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;border-top border-light-secondary p-3&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded py-4 flex flex-column align-center justify-center bg-main&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm mb-2&quot;</span>&gt;</span>当前金币<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-weight-bold text-white&quot;</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 60rpx;&quot;</span>&gt;</span>&#123;&#123;currentPrice&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;border-top border-light-secondary my-3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-sm text-muted&quot;</span>&gt;</span>请选择充值金币<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: -20rpx;margin-right: -20rpx; display: flex; flex-wrap: wrap;&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 33.3%;box-sizing: border-box;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;p-2&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">				@<span class="attr">click</span>=<span class="string">&quot;chooseCoin(index)&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">view</span> <span class="attr">v-if</span>=<span class="string">&quot;item.price &gt; 0&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 130rpx;&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">class</span>=<span class="string">&quot;border rounded flex flex-column align-center justify-center&quot;</span></span></span><br><span class="line"><span class="tag">					<span class="attr">:class</span>=<span class="string">&quot; activeIndex === index ? &#x27;border-main&#x27; : &#x27;&#x27; &quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-warning mr-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe631;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md font-weight-bold&quot;</span>&gt;</span>&#123;&#123;item.coin&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-light-muted&quot;</span>&gt;</span>￥&#123;&#123;item.price&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">				<span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else</span> <span class="attr">style</span>=<span class="string">&quot;height: 130rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;border rounded flex flex-column align-center justify-center&quot;</span></span></span><br><span class="line"><span class="tag">					@<span class="attr">click</span>=<span class="string">&quot;openCoinPopup&quot;</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-light-muted&quot;</span>&gt;</span>自定义<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;position-fixed left-0 bottom-0 right-0 border-top flex px-3 align-center&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">style</span>=<span class="string">&quot;height: 100rpx; justify-content: space-between;&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-warning mr-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe631;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md font-weight-bold&quot;</span>&gt;</span>&#123;&#123;price&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-main rounded flex align-center justify-center ml-auto&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 150rpx;height: 70rpx;&quot;</span></span></span><br><span class="line"><span class="tag">				@<span class="attr">click</span>=<span class="string">&quot;recharge&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-md&quot;</span>&gt;</span>去充值<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 自定义充值弹出层 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">ref</span>=<span class="string">&quot;coinPopup&quot;</span> <span class="attr">type</span>=<span class="string">&quot;dialog&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">uni-popup-dialog</span> <span class="attr">mode</span>=<span class="string">&quot;input&quot;</span> <span class="attr">title</span>=<span class="string">&quot;自定义充值&quot;</span> <span class="attr">:duration</span>=<span class="string">&quot;2000&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;充值金额&quot;</span> <span class="attr">inputType</span>=<span class="string">&quot;number&quot;</span></span></span><br><span class="line"><span class="tag">				@<span class="attr">confirm</span>=<span class="string">&quot;confirm&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">uni-popup-dialog</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">			<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="attr">list</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">coin</span>: <span class="number">10</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">10</span></span></span><br><span class="line"><span class="language-javascript">				&#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">coin</span>: <span class="number">20</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">20</span></span></span><br><span class="line"><span class="language-javascript">				&#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">coin</span>: <span class="number">30</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">30</span></span></span><br><span class="line"><span class="language-javascript">				&#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">coin</span>: <span class="number">50</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">50</span></span></span><br><span class="line"><span class="language-javascript">				&#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">coin</span>: <span class="number">100</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">100</span></span></span><br><span class="line"><span class="language-javascript">				&#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">price</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">				&#125;],</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 选中的金币索引</span></span></span><br><span class="line"><span class="language-javascript">				<span class="attr">activeIndex</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 需要充值的金币</span></span></span><br><span class="line"><span class="language-javascript">				<span class="attr">price</span>: <span class="number">10</span>,</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 当前金币</span></span></span><br><span class="line"><span class="language-javascript">				<span class="attr">currentPrice</span>: <span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">coin</span></span></span><br><span class="line"><span class="language-javascript">			&#125;</span></span><br><span class="line"><span class="language-javascript">		&#125;,</span></span><br><span class="line"><span class="language-javascript">		<span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">			<span class="comment">// 选中金币</span></span></span><br><span class="line"><span class="language-javascript">			<span class="title function_">chooseCoin</span>(<span class="params">index</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">this</span>.<span class="property">activeIndex</span> = index</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 修改左下角价格</span></span></span><br><span class="line"><span class="language-javascript">				<span class="keyword">let</span> p = <span class="variable language_">this</span>.<span class="property">list</span>[index].<span class="property">price</span></span></span><br><span class="line"><span class="language-javascript">				<span class="keyword">if</span> (p &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="variable language_">this</span>.<span class="property">price</span> = p</span></span><br><span class="line"><span class="language-javascript">				&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="comment">// 自定义价格</span></span></span><br><span class="line"><span class="language-javascript">					<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">coinPopup</span>.<span class="title function_">open</span>()</span></span><br><span class="line"><span class="language-javascript">				&#125;</span></span><br><span class="line"><span class="language-javascript">			&#125;,</span></span><br><span class="line"><span class="language-javascript">			<span class="comment">// 打开弹出层</span></span></span><br><span class="line"><span class="language-javascript">			<span class="title function_">openCoinPopup</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">coinPopup</span>.<span class="title function_">open</span>(<span class="string">&quot;center&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">			&#125;,</span></span><br><span class="line"><span class="language-javascript">			<span class="comment">// 确认充值</span></span></span><br><span class="line"><span class="language-javascript">			<span class="title function_">confirm</span>(<span class="params">value</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 判断</span></span></span><br><span class="line"><span class="language-javascript">				<span class="keyword">if</span> (value - <span class="number">0</span> &lt;= <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">					uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">						<span class="attr">icon</span>: <span class="string">&quot;error&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">						<span class="attr">title</span>: <span class="string">&quot;金币数量有误&quot;</span></span></span><br><span class="line"><span class="language-javascript">					&#125;)</span></span><br><span class="line"><span class="language-javascript">					<span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">				&#125;</span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">this</span>.<span class="property">price</span> = value - <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">			&#125;,</span></span><br><span class="line"><span class="language-javascript">			<span class="comment">// 去充值</span></span></span><br><span class="line"><span class="language-javascript">			<span class="title function_">recharge</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 充值</span></span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">this</span>.<span class="property">currentPrice</span> += <span class="variable language_">this</span>.<span class="property">price</span></span></span><br><span class="line"><span class="language-javascript">				<span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">coin</span> = <span class="variable language_">this</span>.<span class="property">currentPrice</span></span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">this</span>.<span class="property">price</span> = <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">				<span class="comment">// 提示</span></span></span><br><span class="line"><span class="language-javascript">				uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">icon</span>: <span class="string">&quot;success&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">					<span class="attr">title</span>: <span class="string">&quot;充值成功&quot;</span></span></span><br><span class="line"><span class="language-javascript">				&#125;)</span></span><br><span class="line"><span class="language-javascript">			&#125;</span></span><br><span class="line"><span class="language-javascript">		&#125;</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建nvue页面</span></span><br><span class="line"><span class="comment">// 修改page.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;path&quot;</span> : <span class="string">&quot;pages/clive/clive&quot;</span>,</span><br><span class="line">  <span class="string">&quot;style&quot;</span> : </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;app-plus&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;titleNView&quot;</span>: <span class="literal">false</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="创建直播页">创建直播页</h5>
<h6 id="直播推流组件">直播推流组件</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">live-pusher</span> <span class="attr">id</span>=<span class="string">&#x27;livePusher&#x27;</span> <span class="attr">ref</span>=<span class="string">&quot;livePusher&quot;</span> <span class="attr">class</span>=<span class="string">&quot;livePusher&quot;</span> <span class="attr">:url</span>=<span class="string">&quot;url&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;HD&quot;</span> <span class="attr">:muted</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:enable-camera</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:auto-focus</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:beauty</span>=<span class="string">&quot;5&quot;</span> <span class="attr">whiteness</span>=<span class="string">&quot;5&quot;</span> <span class="attr">aspect</span>=<span class="string">&quot;9:16&quot;</span> @<span class="attr">statechange</span>=<span class="string">&quot;statechange&quot;</span> @<span class="attr">netstatus</span>=<span class="string">&quot;netstatus&quot;</span> @<span class="attr">error</span>=<span class="string">&quot;error&quot;</span> <span class="attr">:style</span>=<span class="string">&quot;`height:$&#123;windowHeight&#125;px;`&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">live-pusher</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">		<span class="attr">context</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 窗口高度</span></span></span><br><span class="line"><span class="language-javascript">		<span class="attr">windowHeight</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 状态栏高度 </span></span></span><br><span class="line"><span class="language-javascript">		<span class="attr">statusBarHeight</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">onLoad</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">let</span> res = uni.<span class="title function_">getSystemInfoSync</span>()</span></span><br><span class="line"><span class="language-javascript">	<span class="variable language_">this</span>.<span class="property">windowHeight</span> = res.<span class="property">windowHeight</span></span></span><br><span class="line"><span class="language-javascript">	<span class="variable language_">this</span>.<span class="property">statusBarHeight</span> = res.<span class="property">statusBarHeight</span></span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">onReady</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="variable language_">this</span>.<span class="property">context</span> = uni.<span class="title function_">createLivePusherContext</span>(<span class="string">&#x27;livePusher&#x27;</span>, <span class="variable language_">this</span>)</span></span><br><span class="line"><span class="language-javascript">	<span class="variable language_">this</span>.<span class="title function_">startPreview</span>()</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">// 开启直播预览</span></span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">startPreview</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">startPreview</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">			<span class="attr">success</span>: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">				<span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span></span><br><span class="line"><span class="language-javascript">			&#125;</span></span><br><span class="line"><span class="language-javascript">		&#125;)</span></span><br><span class="line"><span class="language-javascript">	&#125;,</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">// 直播状态变化</span></span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">statechange</span>(<span class="params">e</span>) &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">// 直播网络变化</span></span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">netstatus</span>(<span class="params">e</span>) &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">// 错误</span></span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">error</span>(<span class="params">e</span>) &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">	<span class="title function_">back</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">	  uni.<span class="title function_">navigateBack</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">		<span class="attr">delta</span>: <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">	  &#125;);</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="直播页布局">直播页布局</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;right: 0;height: 500rpx;&quot;</span> <span class="attr">:style</span>=<span class="string">&quot;`top:$&#123;statusBarHeight&#125;px`&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 90rpx;height: 90rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;back&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white&quot;</span>&gt;</span><span class="symbol">&amp;#xeaf2;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;position-absolute rounded p-2 flex align-center&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;left: 90rpx;right: 100rpx;height: 160rpx;background-color: rgba(0,0,0,0.2);&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 120rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;position-relative rounded&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/gift/3.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 120rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white position-absolute font&quot;</span> <span class="attr">style</span>=<span class="string">&quot;left: 0;right: 0;bottom: 0;&quot;</span>&gt;</span>更换封面<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 ml-2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入直播标题&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mb-2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-md&quot;</span>&gt;</span>#请选择分类<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;position-absolute right-0 flex flex-column &quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100rpx;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;switchCamera&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white mb-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe605;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>翻转<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openPopup(&#x27;mode&#x27;)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white mb-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe60c;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>画质<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openPopup(&#x27;beauty&#x27;)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white mb-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe632;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>美颜<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;width: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openPopup(&#x27;whiteness&#x27;)&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white mb-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe631;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>美白<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;position-fixed bg-main flex align-center justify-center rounded-circle&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;left: 100rpx;right: 100rpx;bottom: 100rpx;height: 120rpx;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-md&quot;</span>&gt;</span>开始视频直播<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="镜头翻转">镜头翻转</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 切换摄像头</span></span><br><span class="line"><span class="title function_">switchCamera</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">switchCamera</span>(&#123;</span><br><span class="line">        <span class="attr">success</span>:<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="property">position</span> === <span class="string">&#x27;back&#x27;</span> ? <span class="string">&#x27;front&#x27;</span> : <span class="string">&#x27;back&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h6 id="画质切换">画质切换</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;popup&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center border-bottom&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 90rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>&#123;&#123;popupTitle&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 画质选择 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-if</span>=<span class="string">&quot;popupType === &#x27;mode&#x27;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in modeList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;mode === item.type ? &#x27;bg-main&#x27; : &#x27;&#x27;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;chooseMode(item)&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;mode === item.type ? &#x27;text-white&#x27; : &#x27;&#x27;&quot;</span>&gt;</span>&#123;&#123;item.desc&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;f-divider&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>  <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 90rpx;&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-light&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;closePopup&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">context</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">windowHeight</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">statusBarHeight</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">modeList</span>:[&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>:<span class="string">&quot;SD&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">desc</span>:<span class="string">&quot;标清&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>:<span class="string">&quot;HD&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">desc</span>:<span class="string">&quot;高清&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>:<span class="string">&quot;FHD&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">desc</span>:<span class="string">&quot;超清&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;],</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">popupTitle</span>: <span class="string">&#x27;画质选择&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">popupType</span>:<span class="string">&quot;mode&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"> &#125;,</span></span><br><span class="line"><span class="language-javascript"> <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 画质选择</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">chooseMode</span>(<span class="params">item</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">mode</span> = item.<span class="property">type</span></span></span><br><span class="line"><span class="language-javascript">      uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">title</span>: <span class="string">&#x27;画质切换为&#x27;</span> + item.<span class="property">desc</span>,</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="title function_">closePopup</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openPopup</span>(<span class="params">type</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">popupType</span> = type</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">open</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">closePopup</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;   </span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	</span><br></pre></td></tr></table></figure>
<h6 id="美颜美白">美颜美白</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else-if</span>=<span class="string">&quot;popupType === &#x27;beauty&#x27;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slider</span> <span class="attr">:min</span>=<span class="string">&quot;0&quot;</span> <span class="attr">:max</span>=<span class="string">&quot;9&quot;</span> <span class="attr">:step</span>=<span class="string">&quot;1&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;beauty&quot;</span> <span class="attr">:block-size</span>=<span class="string">&quot;18&quot;</span> <span class="attr">show-value</span> @<span class="attr">change</span>=<span class="string">&quot;handleSliderChange&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">slider</span> <span class="attr">:min</span>=<span class="string">&quot;0&quot;</span> <span class="attr">:max</span>=<span class="string">&quot;9&quot;</span> <span class="attr">:step</span>=<span class="string">&quot;1&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;whiteness&quot;</span> <span class="attr">:block-size</span>=<span class="string">&quot;18&quot;</span> <span class="attr">show-value</span></span></span><br><span class="line"><span class="tag">@<span class="attr">change</span>=<span class="string">&quot;handleSliderChange&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 美颜</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">beauty</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 美白</span></span></span><br><span class="line"><span class="language-javascript">    <span class="attr">whiteness</span>:<span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"> &#125;,</span></span><br><span class="line"><span class="language-javascript"> <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">handleSliderChange</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">	   <span class="variable language_">this</span>[<span class="variable language_">this</span>.<span class="property">popupType</span>] = e.<span class="property">detail</span>.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;   </span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>	</span><br></pre></td></tr></table></figure>
<h6 id="退出黑边问题">退出黑边问题</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v-<span class="keyword">if</span>控制data中的showBars</span><br><span class="line">在返回的生命中修改状态即可</span><br><span class="line"><span class="title function_">onBackPress</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">showBars</span> = <span class="literal">false</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h5 id="主播直播间">主播直播间</h5>
<h6 id="携带参数跳转">携带参数跳转</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">openLiveRoom</span>(<span class="params"></span>)&#123;</span><br><span class="line">  uni.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/pages/liveroom/liveroom?options=&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">        <span class="attr">mode</span>: <span class="variable language_">this</span>.<span class="property">mode</span>,</span><br><span class="line">        <span class="attr">position</span>: <span class="variable language_">this</span>.<span class="property">position</span>,</span><br><span class="line">        <span class="attr">beauty</span>: <span class="variable language_">this</span>.<span class="property">beauty</span>,</span><br><span class="line">        <span class="attr">whiteness</span>: <span class="variable language_">this</span>.<span class="property">whiteness</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="直播间布局">直播间布局</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- live.nuve、clive内容修改 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 底部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;bottom: 0;right: 0;height: 120rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-between&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column align-center justify-center&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in btns&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">click</span>=<span class="string">&quot;handleBottomEvent(item)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-white mb-1&quot;</span>&gt;</span>&#123;&#123;item.icon&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;popup&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center border-bottom&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 90rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>&#123;&#123;popupTitle&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 画质选择 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-if</span>=<span class="string">&quot;popupType === &#x27;mode&#x27;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in modeList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;mode === item.type ? &#x27;bg-main&#x27; : &#x27;&#x27;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;chooseMode(item)&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;mode === item.type ? &#x27;text-white&#x27; : &#x27;&#x27;&quot;</span>&gt;</span>&#123;&#123;item.desc&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 美颜 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else-if</span>=<span class="string">&quot;popupType === &#x27;beauty&#x27;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slider</span> <span class="attr">:min</span>=<span class="string">&quot;0&quot;</span> <span class="attr">:max</span>=<span class="string">&quot;9&quot;</span> <span class="attr">:step</span>=<span class="string">&quot;1&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;beauty&quot;</span> <span class="attr">:block-size</span>=<span class="string">&quot;18&quot;</span> <span class="attr">show-value</span> @<span class="attr">change</span>=<span class="string">&quot;handleSliderChange&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 美白 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else-if</span>=<span class="string">&quot;popupType === &#x27;whiteness&#x27;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slider</span> <span class="attr">:min</span>=<span class="string">&quot;0&quot;</span> <span class="attr">:max</span>=<span class="string">&quot;9&quot;</span> <span class="attr">:step</span>=<span class="string">&quot;1&quot;</span> <span class="attr">:value</span>=<span class="string">&quot;whiteness&quot;</span> <span class="attr">:block-size</span>=<span class="string">&quot;18&quot;</span> <span class="attr">show-value</span> @<span class="attr">change</span>=<span class="string">&quot;handleSliderChange&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 更多 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-wrap&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 150rpx;height: 150rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;pauseOrPlay&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont mb-1&quot;</span>&gt;</span>&#123;&#123; isPause ? &#x27;<span class="symbol">&amp;#xe667;</span>&#x27;: &#x27;<span class="symbol">&amp;#xe662;</span>&#x27;  &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font&quot;</span>&gt;</span>&#123;&#123; isPause ? &#x27;继续&#x27; : &#x27;暂停&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 150rpx;height: 150rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;back&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont mb-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe630;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font&quot;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;f-divider&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span>  <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;height: 90rpx;&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-light&quot;</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">click</span>=<span class="string">&quot;closePopup&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>取消<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">btns</span>: [&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;翻转&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;\ue605&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">event</span>: <span class="string">&quot;switchCamera&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;画质&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;\ue60c&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">event</span>: <span class="string">&quot;openPopup&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: <span class="string">&quot;mode&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;美颜&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;\ue619&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">event</span>: <span class="string">&quot;openPopup&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: <span class="string">&quot;beauty&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;美白&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;\ue60b&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">event</span>: <span class="string">&quot;openPopup&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: <span class="string">&quot;whiteness&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;, &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;更多&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;\ue620&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">event</span>: <span class="string">&quot;openPopup&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">params</span>: <span class="string">&quot;more&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;],</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">mode</span>: <span class="string">&quot;HD&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">enableCamera</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">position</span>: <span class="string">&quot;front&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">beauty</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">whiteness</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">windowHeight</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">statusBarHeight</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">isPause</span>:<span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">onLoad</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> res = uni.<span class="title function_">getSystemInfoSync</span>()</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="property">statusBarHeight</span> = res.<span class="property">statusBarHeight</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (e.<span class="property">options</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> options = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">options</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">mode</span> = options.<span class="property">mode</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">position</span> = options.<span class="property">position</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">beauty</span> = options.<span class="property">beauty</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">whiteness</span> = options.<span class="property">whiteness</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">onReady</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="property">context</span> = uni.<span class="title function_">createLivePusherContext</span>(<span class="string">&#x27;livePusher&#x27;</span>, <span class="variable language_">this</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">startPreview</span>()</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">handleBottomEvent</span>(<span class="params">item</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>[item.<span class="property">event</span>](item.<span class="property">params</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openPopup</span>(<span class="params">type</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">popupType</span> = type</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">open</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 切换摄像头</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">switchCamera</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">switchCamera</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>:<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">position</span> = <span class="variable language_">this</span>.<span class="property">position</span> === <span class="string">&#x27;back&#x27;</span> ? <span class="string">&#x27;front&#x27;</span> : <span class="string">&#x27;back&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">handleSliderChange</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>[<span class="variable language_">this</span>.<span class="property">popupType</span>] = e.<span class="property">detail</span>.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">pauseOrPlay</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">isPause</span> = !<span class="variable language_">this</span>.<span class="property">isPause</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">back</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      uni.<span class="title function_">showModal</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">content</span>: <span class="string">&#x27;是否要退出直播间？&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="function">(<span class="params">res</span>)=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (res.<span class="property">cancel</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          uni.<span class="title function_">navigateBack</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="attr">delta</span>: <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">          &#125;);</span></span><br><span class="line"><span class="language-javascript">          uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="attr">title</span>: <span class="string">&#x27;退出直播间成功&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">              <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span></span><br><span class="line"><span class="language-javascript">          &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 开启预览</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">startPreview</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">startPreview</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>:<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">// console.log(e);</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="个人中心">个人中心</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">v-if</span>=<span class="string">&quot;!user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">style</span>=<span class="string">&quot;width: 180rpx;height: 180rpx;&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/img/2.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 105rpx;height: 105rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>未登录<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-muted&quot;</span>&gt;</span>登录体验更多功能<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;ml-auto mr-3&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;border border-main rounded flex align-center justify-center p-2&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-light&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openLogin&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-main font&quot;</span>&gt;</span>立即登录<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">style</span>=<span class="string">&quot;width: 180rpx;height: 180rpx;&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/img/2.jpg&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 105rpx;height: 105rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>昵称<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-muted&quot;</span>&gt;</span>个签<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;ml-auto mr-3&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;border border-main rounded flex align-center justify-center p-2&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-light&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-main font&quot;</span>&gt;</span>编辑资料<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;f-divider&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">f-list-item</span> <span class="attr">icon</span>=<span class="string">&quot;iconfaxian&quot;</span> <span class="attr">title</span>=<span class="string">&quot;我的金币&quot;</span> <span class="attr">:showRight</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-muted font&quot;</span>&gt;</span>50金币 立即充值<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">f-list-item</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">f-list-item</span> <span class="attr">icon</span>=<span class="string">&quot;iconfaxian&quot;</span> <span class="attr">title</span>=<span class="string">&quot;我的直播&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-muted font&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">f-list-item</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">f-list-item</span> <span class="attr">icon</span>=<span class="string">&quot;iconfaxian&quot;</span> <span class="attr">title</span>=<span class="string">&quot;我的关注&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-muted font&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">f-list-item</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">f-list-item</span> <span class="attr">icon</span>=<span class="string">&quot;iconfaxian&quot;</span> <span class="attr">title</span>=<span class="string">&quot;历史记录&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">f-list-item</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> fListItem <span class="keyword">from</span> <span class="string">&#x27;@/components/common/f-list-item.vue&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">components</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    fListItem</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">user</span>: <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;,</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openLogin</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      uni.<span class="title function_">navigateTo</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="list-item-vue">list-item.vue</h6>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p-3 flex align-center&quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-light&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;$emit(&#x27;click&#x27;)&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont mr-3&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;icon&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-md&quot;</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;ml-auto&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">v-if</span>=<span class="string">&quot;showRight&quot;</span> <span class="attr">class</span>=<span class="string">&quot;text-muted font ml-2&quot;</span>&gt;</span>&gt;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">props</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="title class_">String</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">title</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="title class_">String</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">default</span>: <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">showRight</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="title class_">Boolean</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">default</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="后端项目创建">后端项目创建</h4>
<h5 id="egg基础讲解">egg基础讲解</h5>
<p><a target="_blank" rel="noopener" href="https://www.eggjs.org/zh-CN">egg官网</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">创建项目</span><br><span class="line">mkdir egg-example &amp;&amp; cd egg-example</span><br><span class="line">npm init egg --type=simple</span><br><span class="line">npm i</span><br><span class="line"></span><br><span class="line">启动项目</span><br><span class="line">npm run dev</span><br><span class="line">open <span class="attr">http</span>:<span class="comment">//localhost:7001</span></span><br></pre></td></tr></table></figure>
<h5 id="创建控制器">创建控制器</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Controller</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HomeController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hi, egg&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">HomeController</span>;</span><br></pre></td></tr></table></figure>
<h5 id="路由编写接口">路由编写接口</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controll/home.js</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">   <span class="attr">msg</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">   <span class="attr">data</span>: [</span><br><span class="line">     &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;,</span><br><span class="line">     &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">     &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">&quot;王五&quot;</span>, <span class="attr">age</span>: <span class="number">16</span> &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.js</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/list&#x27;</span>, controller.<span class="property">home</span>.<span class="property">list</span>);</span><br></pre></td></tr></table></figure>
<h6 id="路由传参两种方式">路由传参两种方式</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controll/user.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 用户列表</span></span><br><span class="line">  <span class="keyword">let</span> userList = [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&quot;小明&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">&quot;小红&quot;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">&quot;小王&quot;</span>, <span class="attr">age</span>: <span class="number">16</span> &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Controller</span> <span class="keyword">extends</span> <span class="title class_ inherited__">app.Controller</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">userlist</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: userList</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserById</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 获取params传参</span></span><br><span class="line">      <span class="comment">// let id = this.ctx.params.id</span></span><br><span class="line">      <span class="comment">// 获取query传参 =&gt; 注意路由不需要添加占位符</span></span><br><span class="line">      <span class="keyword">let</span> id = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">query</span>.<span class="property">id</span></span><br><span class="line">      <span class="comment">// 查询</span></span><br><span class="line">      <span class="keyword">let</span> user = userList.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span> == id)</span><br><span class="line">      <span class="comment">// 修改状态码</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">201</span></span><br><span class="line">      <span class="comment">// 响应</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">        <span class="attr">data</span>: user</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Controller</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="comment">// 获取用户列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, controller.<span class="property">user</span>.<span class="property">userlist</span>);</span><br><span class="line"><span class="comment">// 获取某个用户的信息</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/user/:id&#x27;</span>, controller.<span class="property">user</span>.<span class="property">getUserById</span>);</span><br></pre></td></tr></table></figure>
<h6 id="关闭csrf开启跨域">关闭csrf开启跨域</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params"></span>)&#123;</span><br><span class="line">  userList.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">name</span>: <span class="string">&quot;小黑&quot;</span>, <span class="attr">age</span>: <span class="number">16</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 修改状态码</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">201</span></span><br><span class="line">  <span class="comment">// 响应</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: userList</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// post请求 创建用户</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/user/create&#x27;</span>, controller.<span class="property">user</span>.<span class="property">createUser</span>)</span><br></pre></td></tr></table></figure>
<p>安装<code>npm i egg-cors --save</code></p>
<p>配置插件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line"><span class="attr">cors</span>: &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-cors&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>config/config.default.js</code> 配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">security</span> = &#123;</span><br><span class="line">  <span class="comment">// 关闭 csrf</span></span><br><span class="line">  <span class="attr">csrf</span>: &#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 跨域白名单</span></span><br><span class="line">  <span class="attr">domainWhiteList</span>: [<span class="string">&quot;http://localhost:3000&quot;</span>],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 允许跨域的方法</span></span><br><span class="line">config.<span class="property">cors</span> = &#123;</span><br><span class="line">  <span class="attr">origin</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">allowMethods</span>: <span class="string">&quot;GET, PUT, POST, DELETE, PATCH&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="资源路由">资源路由</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.<span class="title function_">resources</span>(<span class="string">&#x27;/posts&#x27;</span>, <span class="string">&#x27;/api/posts&#x27;</span>, controller.<span class="property">posts</span>)</span><br><span class="line">  router.<span class="title function_">resources</span>(<span class="string">&#x27;/users&#x27;</span>, <span class="string">&#x27;/api/v1/users&#x27;</span>, controller.<span class="property">v1</span>.<span class="property">users</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码就在/posts路径上部署了一组CRUD 路径结构，对应的Controller为 <code>app/controller/posts.js</code> 接下来,你只需要在<code>posts.is</code>里面实现对应的函数就可以了。</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Path</th>
<th>Route Name</th>
<th>Controller.Action</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/posts</td>
<td>posts</td>
<td>app.controllers.posts.index</td>
</tr>
<tr>
<td>GET</td>
<td>/posts/new</td>
<td>new_post</td>
<td>app.controllers.posts.new</td>
</tr>
<tr>
<td>GET</td>
<td>/posts/:id</td>
<td>post</td>
<td>app.controllers.posts.show</td>
</tr>
<tr>
<td>GET</td>
<td>/posts/:id/edit</td>
<td>edit_post</td>
<td>app.controllers.posts.edit</td>
</tr>
<tr>
<td>POST</td>
<td>/posts</td>
<td>posts</td>
<td>app.controllers.posts.create</td>
</tr>
<tr>
<td>PUT</td>
<td>/posts/:id</td>
<td>post</td>
<td>app.controllers.posts.update</td>
</tr>
<tr>
<td>DELETE</td>
<td>/posts/:id</td>
<td>post</td>
<td>app.controllers.posts.destory</td>
</tr>
</tbody>
</table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/posts.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 列表页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;列表页&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 新增表单页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">new</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;新增表单页&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 新增逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;新增逻辑&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 详情页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;详情页&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 编辑表单页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">edit</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;编辑表单页&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更新逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;更新逻辑&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 删除逻辑</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">destory</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="string">&#x27;删除逻辑&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="路由分组">路由分组</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;./router/new&#x27;</span>)(app)</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;./router/admin&#x27;</span>)(app)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/news.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&#x27;/news/list&#x27;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">list</span>),</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&#x27;/news/detail&#x27;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">detail</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/admin.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&#x27;/admin/user&#x27;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">user</span>),</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&#x27;/admin/log&#x27;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">log</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="数据库迁移"><a target="_blank" rel="noopener" href="https://www.eggjs.org/zh-CN/tutorials/sequelize">数据库迁移</a></h5>
<ul>
<li>安装并配置<a href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx上）和<a href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&quot;egg-sequelize&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>config/config.default.js</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&quot;egg-video&quot;</span>,</span><br><span class="line">  <span class="comment">// 中国时区</span></span><br><span class="line">  <span class="attr">timezone</span>: <span class="string">&quot;+08:00&quot;</span>,</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 取消数据表名复数</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">    <span class="comment">// paranoid: true,</span></span><br><span class="line">    <span class="attr">createdAt</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;updated_at&quot;</span>,</span><br><span class="line">    <span class="comment">// deletedAt: &#x27;deleted_time&#x27;,</span></span><br><span class="line">    <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">    <span class="attr">underscored</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="初始化数据库和Migrations">初始化数据库和Migrations</h6>
<p>接下来我们先暂时离开 egg 项目的代码，设计和初始化一下我们的数据库。首先我们通过 MySQL 命令在本地快速创建数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不执行: mysql -u root -e &#x27;CREATE DATABASE IF NOT EXISTS `egg-sequelize-doc-default`;&#x27;</span><br></pre></td></tr></table></figure>
<p>然后我们开始设计 <code>users</code> 表，它有如下的数据结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">不执行: <span class="variable constant_">CREATE</span> <span class="variable constant_">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="title function_">INT</span>(<span class="number">11</span>) <span class="variable constant_">NOT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">AUTO_INCREMENT</span> <span class="variable constant_">COMMENT</span> <span class="string">&#x27;primary key&#x27;</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="title function_">VARCHAR</span>(<span class="number">30</span>) <span class="variable constant_">DEFAULT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">COMMENT</span> <span class="string">&#x27;user name&#x27;</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="title function_">INT</span>(<span class="number">11</span>) <span class="variable constant_">DEFAULT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">COMMENT</span> <span class="string">&#x27;user age&#x27;</span>,</span><br><span class="line">  <span class="string">`created_at`</span> <span class="variable constant_">DATETIME</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">COMMENT</span> <span class="string">&#x27;created time&#x27;</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> <span class="variable constant_">DATETIME</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">NULL</span> <span class="variable constant_">COMMENT</span> <span class="string">&#x27;updated time&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">PRIMARY</span> <span class="variable constant_">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="variable constant_">ENGINE</span>=<span class="title class_">InnoDB</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">CHARSET</span>=utf8mb4 <span class="variable constant_">COMMENT</span>=<span class="string">&#x27;user&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以直接通过 MySQL 命令将表直接建好，但是这并不是一个对多人协作非常友好的开发模式。在项目的演进过程中，每一个迭代都有可能对数据库数据结构做变更，怎样跟踪每一个迭代的数据变更，并在不同的环境（开发、测试、CI）和迭代切换中，快速变更数据结构呢？这时候我们就需要 <code>Migrations</code> 来帮我们管理数据结构的变更了。</p>
<p>sequelize 提供了 <code>sequelize-cli</code> 工具来实现 <code>Migrations</code>，我们也可以在 egg 项目中引入 sequelize-cli。</p>
<ul>
<li>安装 <a target="_blank" rel="noopener" href="https://sequelize.org/docs/v6/">sequelize-cli</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>
<p>在 egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在 <code>database</code> 目录下，所以我们在项目根目录下新建一个 <code>.sequelizerc</code> 配置文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="string">&quot;config&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;database/config.json&#x27;</span>),</span><br><span class="line">  <span class="string">&quot;migrations-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;database/migrations&#x27;</span>),</span><br><span class="line">  <span class="string">&quot;seeders-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;database/seeders&#x27;</span>),</span><br><span class="line">  <span class="string">&quot;models-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;app/model&#x27;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化 Migrations 配置文件和目录</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">init</span>:config</span><br><span class="line">npx sequelize <span class="attr">init</span>:migrations</span><br></pre></td></tr></table></figure>
<p>执行完后会生成 <code>database/config.json</code> 文件和 <code>database/migrations</code> 目录，我们修改一下 <code>database/config.json</code> 中的内容，将其改成我们项目中使用的数据库配置：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;development&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;自己填&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;egg-sequelize-doc-default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建数据库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:create</span><br></pre></td></tr></table></figure>
<p>此时 sequelize-cli 和相关的配置也都初始化好了，我们可以开始编写项目的第一个 Migration 文件来创建我们的一个 <code>users</code> 表了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">migration</span>:generate --name=init-users</span><br></pre></td></tr></table></figure>
<p>执行完后会在 <code>database/migrations</code> 目录下生成一个 migration 文件（<code>$&#123;timestamp&#125;-init-users.js</code>），我们修改它来处理初始化 <code>users</code> 表：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">import(&#x27;sequelize-cli&#x27;).Migration</span>&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="keyword">async</span> (queryInterface, <span class="title class_">Sequelize</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="comment">// 创建表await </span></span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>).<span class="property">UNSIGNED</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">username</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户名称&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">      <span class="attr">avatar_url</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">      <span class="attr">sex</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">ENUM</span>, <span class="attr">values</span>: [<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;保密&#x27;</span>], <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;男&#x27;</span>, <span class="attr">comment</span>: <span class="string">&quot;用户性别&quot;</span> &#125;,</span><br><span class="line">      <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在执行数据库降级时调用的函数，删除 users 表</span></span><br><span class="line">  <span class="attr">down</span>: <span class="keyword">async</span> (queryInterface) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&#x27;users&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行 migrate 进行数据库变更</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 升级数据库</span><br><span class="line">npx sequelize <span class="attr">db</span>:migrate</span><br><span class="line"></span><br><span class="line"># 如果有问题需要回滚，可以通过 <span class="string">`db:migrate:undo`</span> 回退一个变更</span><br><span class="line"></span><br><span class="line"># npx sequelize <span class="attr">db</span>:<span class="attr">migrate</span>:undo</span><br><span class="line"></span><br><span class="line"># 可以通过 <span class="string">`db:migrate:undo:all`</span> 回退到初始状态</span><br></pre></td></tr></table></figure>
<h5 id="模型">模型</h5>
<h6 id="创建模型">创建模型</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>).<span class="property">UNSIGNED</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">username</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户名称&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">avatar_url</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">    <span class="attr">sex</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">ENUM</span>, <span class="attr">values</span>: [<span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>, <span class="string">&#x27;保密&#x27;</span>], <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;男&#x27;</span>, <span class="attr">comment</span>: <span class="string">&quot;用户性别&quot;</span> &#125;,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>, <span class="comment">// 是否自动写入时间戳</span></span><br><span class="line">    <span class="attr">tableName</span>: <span class="string">&#x27;user&#x27;</span> <span class="comment">// 自定义数据库表名称</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个Model就可以在Controll和Service中通过app.model.User或者ctx.model.User访问到了，例如，我们编写 <code>app/controller/users.js</code></p>
<h6 id="创建用户">创建用户</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">// 获取User模型</span></span><br><span class="line">  <span class="comment">// app.model.User</span></span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="comment">// 获取请求体提交的数据</span></span><br><span class="line">  <span class="keyword">let</span> body = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">  <span class="comment">// 加密场景</span></span><br><span class="line">  <span class="comment">// 1、获取body中的password字段 加密 body.password = jsonwebtoken(body.password)</span></span><br><span class="line">  <span class="comment">// 2、使用数据模型的set修改器</span></span><br><span class="line">  <span class="comment">// 创建用户</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> user.<span class="title function_">create</span>(body)</span><br><span class="line">  <span class="comment">// 如果创建失败</span></span><br><span class="line">  <span class="keyword">if</span>(!res) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;<span class="attr">msg</span>: <span class="string">&quot;创建用户失败&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 设置状态码</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">201</span></span><br><span class="line">  <span class="comment">// 响应</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="修改器">修改器</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 密码</span></span><br><span class="line"><span class="attr">password</span>: &#123; </span><br><span class="line">  <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), </span><br><span class="line">  <span class="attr">allowNull</span>: <span class="literal">false</span>, </span><br><span class="line">  <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="comment">// 修改器</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params">val</span>)&#123;</span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    <span class="keyword">let</span> hash = val + <span class="string">&#x27;token&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setDataValue</span>(<span class="string">&#x27;password&#x27;</span>, hash);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="获取器">获取器</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建时间</span></span><br><span class="line"><span class="attr">created_at</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>:<span class="variable constant_">DATE</span>,</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> created_at = <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&#x27;created_at&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(created_at).<span class="title function_">getTime</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="批量创建">批量创建</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">bulkCreate</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> user.<span class="title function_">bulkCreate</span>([</span><br><span class="line">    &#123;<span class="attr">username</span>: <span class="string">&quot;用户7&quot;</span>, <span class="attr">password</span>: <span class="string">&quot;333&quot;</span>, <span class="attr">sex</span>: <span class="string">&quot;0&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">username</span>: <span class="string">&quot;用户8&quot;</span>, <span class="attr">password</span>: <span class="string">&quot;333&quot;</span>, <span class="attr">sex</span>: <span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">username</span>: <span class="string">&quot;用户9&quot;</span>, <span class="attr">password</span>: <span class="string">&quot;333&quot;</span>, <span class="attr">sex</span>: <span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">username</span>: <span class="string">&quot;用户10&quot;</span>, <span class="attr">password</span>: <span class="string">&quot;333&quot;</span>, <span class="attr">sex</span>: <span class="string">&quot;0&quot;</span>&#125;</span><br><span class="line">  ])</span><br><span class="line">  <span class="comment">// 设置状态码</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">201</span></span><br><span class="line">  <span class="comment">// 响应</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="主键查询">主键查询</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主键查询</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findById</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="comment">// 接收前端传来的id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> user.<span class="title function_">findByPk</span>(id)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="查询单个用户">查询单个用户</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询单个用户 =&gt; where查询</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">findOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="comment">// 接收前端传来的gender</span></span><br><span class="line">  <span class="keyword">let</span> sex = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">params</span>.<span class="property">gender</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询符合条件的第一个元素</span></span><br><span class="line">  <span class="comment">// let res = await user.findOne(&#123;</span></span><br><span class="line">  <span class="comment">//   where: &#123; sex &#125;</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询符合条件的所有元素</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> user.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123; sex &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="查询多个用户">查询多个用户</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="comment">// 查询多个</span></span><br><span class="line">  <span class="comment">// let res = await user.findAll()</span></span><br><span class="line">  <span class="comment">// 查询多个并统计</span></span><br><span class="line">  res = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAndCountAll</span>();</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="分页查询">分页查询</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findByPaging</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span></span><br><span class="line">  <span class="comment">// page: 第几页</span></span><br><span class="line">  <span class="comment">// limit: 每页几条</span></span><br><span class="line">  <span class="comment">// offset: 偏移量</span></span><br><span class="line">  <span class="comment">// 第一页: 0 - 4</span></span><br><span class="line">  <span class="comment">// 第二页: 5 - 9</span></span><br><span class="line">  <span class="comment">// 第三页: 10 - 14</span></span><br><span class="line">  <span class="keyword">let</span> &#123;limit = <span class="number">3</span>, page&#125; = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">query</span></span><br><span class="line">  <span class="comment">// 计算偏移量</span></span><br><span class="line">  <span class="keyword">let</span> offset = (page - <span class="number">1</span>) * limit</span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> user.<span class="title function_">findAll</span>(&#123;<span class="attr">limit</span>: limit - <span class="number">0</span>, <span class="attr">offset</span>: offset - <span class="number">0</span> &#125;)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="where操作符">where操作符</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findByWhere</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">// 拿到数据</span></span><br><span class="line"><span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Op</span> = <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"><span class="comment">// 查询多个</span></span><br><span class="line">result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line"><span class="comment">// where 查询条件</span></span><br><span class="line">   <span class="attr">where</span>:&#123;</span><br><span class="line">      <span class="attr">sex</span>:<span class="string">&#x27;男&#x27;</span>,</span><br><span class="line">      <span class="attr">username</span>:&#123;</span><br><span class="line">          [<span class="title class_">Op</span>.<span class="property">like</span>]:<span class="string">&quot;%张三%&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">id</span>:&#123;</span><br><span class="line">          [<span class="title class_">Op</span>.<span class="property">gt</span>]:<span class="number">6</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">Op</span> = <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">Sequelize</span>.<span class="property">Op</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">and</span>]: [&#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">b</span>: <span class="number">6</span> &#125;],            <span class="comment">// (a = 5) AND (b = 6)</span></span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">b</span>: <span class="number">6</span> &#125;],             <span class="comment">// (a = 5) OR (b = 6)</span></span><br><span class="line">    <span class="attr">someAttribute</span>: &#123;</span><br><span class="line">      <span class="comment">// 基本</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="number">3</span>,                              <span class="comment">// = 3</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>,                             <span class="comment">// != 20</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">is</span>]: <span class="literal">null</span>,                           <span class="comment">// IS NULL</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">true</span>,                          <span class="comment">// IS NOT TRUE</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [<span class="number">5</span>, <span class="number">6</span>],                         <span class="comment">// (someAttribute = 5) OR (someAttribute = 6)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 使用方言特定的列标识符 (以下示例中使用 PG):</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">col</span>]: <span class="string">&#x27;user.organization_id&#x27;</span>,        <span class="comment">// = &quot;user&quot;.&quot;organization_id&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数字比较</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>,                              <span class="comment">// &gt; 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>,                             <span class="comment">// &gt;= 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>,                             <span class="comment">// &lt; 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>,                            <span class="comment">// &lt;= 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>],                   <span class="comment">// BETWEEN 6 AND 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>],               <span class="comment">// NOT BETWEEN 11 AND 15</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 其它操作符</span></span><br><span class="line"></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">all</span>]: sequelize.<span class="title function_">literal</span>(<span class="string">&#x27;SELECT 1&#x27;</span>), <span class="comment">// &gt; ALL (SELECT 1)</span></span><br><span class="line"></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>],                         <span class="comment">// IN [1, 2]</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>],                      <span class="comment">// NOT IN [1, 2]</span></span><br><span class="line"></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%hat&#x27;</span>,                       <span class="comment">// LIKE &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&#x27;%hat&#x27;</span>,                    <span class="comment">// NOT LIKE &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">startsWith</span>]: <span class="string">&#x27;hat&#x27;</span>,                  <span class="comment">// LIKE &#x27;hat%&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">endsWith</span>]: <span class="string">&#x27;hat&#x27;</span>,                    <span class="comment">// LIKE &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">substring</span>]: <span class="string">&#x27;hat&#x27;</span>,                   <span class="comment">// LIKE &#x27;%hat%&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%hat&#x27;</span>,                      <span class="comment">// ILIKE &#x27;%hat&#x27; (不区分大小写) (仅 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&#x27;%hat&#x27;</span>,                   <span class="comment">// NOT ILIKE &#x27;%hat&#x27;  (仅 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">regexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>,                 <span class="comment">// REGEXP/~ &#x27;^[h|a|t]&#x27; (仅 MySQL/PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>,              <span class="comment">// NOT REGEXP/!~ &#x27;^[h|a|t]&#x27; (仅 MySQL/PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">iRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>,                <span class="comment">// ~* &#x27;^[h|a|t]&#x27; (仅 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notIRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>,             <span class="comment">// !~* &#x27;^[h|a|t]&#x27; (仅 PG)</span></span><br><span class="line"></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>, <span class="number">3</span>],                        <span class="comment">// ANY ARRAY[2, 3]::INTEGER (仅 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">match</span>]: <span class="title class_">Sequelize</span>.<span class="title function_">fn</span>(<span class="string">&#x27;to_tsquery&#x27;</span>, <span class="string">&#x27;fat &amp; rat&#x27;</span>) <span class="comment">// 匹配文本搜索字符串 &#x27;fat&#x27; 和 &#x27;rat&#x27; (仅 PG)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在 Postgres 中, Op.like/Op.iLike/Op.notLike 可以结合 Op.any 使用:</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: &#123; [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;hat&#x27;</span>] &#125;  <span class="comment">// LIKE ANY ARRAY[&#x27;cat&#x27;, &#x27;hat&#x27;]</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h6 id="字段限制-排序">字段限制&amp;排序</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findByWhere</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">// 拿到数据</span></span><br><span class="line"><span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Op</span> = <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"><span class="comment">// 查询多个</span></span><br><span class="line">result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line"><span class="comment">// where 查询条件</span></span><br><span class="line">   <span class="attr">where</span>:&#123;</span><br><span class="line">      <span class="attr">sex</span>:<span class="string">&#x27;男&#x27;</span>,</span><br><span class="line">      <span class="attr">username</span>:&#123;</span><br><span class="line">          [<span class="title class_">Op</span>.<span class="property">like</span>]:<span class="string">&quot;%张三%&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">id</span>:&#123;</span><br><span class="line">          [<span class="title class_">Op</span>.<span class="property">gt</span>]:<span class="number">6</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// attributes:[&#x27;id&#x27;,&#x27;username&#x27;,&#x27;sex&#x27;]</span></span><br><span class="line">    <span class="attr">attributes</span>:&#123;</span><br><span class="line">     <span class="comment">// 排除</span></span><br><span class="line">       <span class="attr">exclude</span>:[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">     <span class="comment">// 排序</span></span><br><span class="line">    <span class="attr">order</span>:[</span><br><span class="line">       <span class="comment">// id 降序</span></span><br><span class="line">       [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">     ],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="修改和限制字段">修改和限制字段</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> id = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">params</span>.<span class="property">id</span> ? <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">params</span>.<span class="property">id</span>) : <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 拿到这条记录</span></span><br><span class="line">  <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">  <span class="keyword">if</span>(!data)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span>=&#123;</span><br><span class="line">          <span class="attr">msg</span>:<span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">          <span class="attr">data</span>:<span class="string">&#x27;该记录不存在&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//   data.username = &#x27;被修改了&#x27;;</span></span><br><span class="line">  <span class="comment">//   let res = await data.save(&#123;</span></span><br><span class="line">  <span class="comment">//       // 限制字段</span></span><br><span class="line">  <span class="comment">//       fields:[&#x27;username&#x27;]</span></span><br><span class="line">  <span class="comment">//   &#125;);</span></span><br><span class="line"><span class="keyword">let</span> params = <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"><span class="keyword">let</span> res = <span class="keyword">await</span> data.<span class="title function_">update</span>(params,&#123;</span><br><span class="line">    <span class="attr">fields</span>:[<span class="string">&#x27;username&#x27;</span>] <span class="comment">// 限制字段</span></span><br><span class="line">&#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span>=&#123;</span><br><span class="line">          <span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">          <span class="attr">data</span>:res</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="删除和批量删除">删除和批量删除</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">deleted</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">//   let id = this.ctx.params.id ? parseInt(this.ctx.params.id) : 0;</span></span><br><span class="line"><span class="comment">//   let data = await this.app.model.User.findByPk(id);</span></span><br><span class="line"><span class="comment">//   if(!data)&#123;</span></span><br><span class="line"><span class="comment">//       return this.ctx.body=&#123;</span></span><br><span class="line"><span class="comment">//           msg:&#x27;fail&#x27;,</span></span><br><span class="line"><span class="comment">//           data:&#x27;该记录不存在&#x27;</span></span><br><span class="line"><span class="comment">//       &#125;</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">//   // 删除单个</span></span><br><span class="line"><span class="comment">//   let res = await data.destroy();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//   return this.ctx.body=&#123;</span></span><br><span class="line"><span class="comment">//           msg:&#x27;ok&#x27;,</span></span><br><span class="line"><span class="comment">//           data:res</span></span><br><span class="line"><span class="comment">//       &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量删除</span></span><br><span class="line"><span class="keyword">let</span> <span class="title class_">Op</span> = <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"><span class="keyword">let</span> res = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">   <span class="attr">where</span>:&#123;</span><br><span class="line">       <span class="attr">id</span>:&#123;</span><br><span class="line">           [<span class="title class_">Op</span>.<span class="property">lte</span>]:<span class="number">10</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span>=&#123;</span><br><span class="line">      <span class="attr">msg</span>:<span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">      <span class="attr">data</span>:res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="错误和异常处理">错误和异常处理</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/errorHandle.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">errorHandle</span>(<span class="params">ctx,next</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(error)&#123;</span><br><span class="line">            <span class="comment">// 错误日志</span></span><br><span class="line">            <span class="comment">// 所有异常都在app上触发一个error事件 框架会记录一条错误日志</span></span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>,err,ctx);</span><br><span class="line">            <span class="keyword">const</span> status = err.<span class="property">status</span> || <span class="number">500</span></span><br><span class="line">            <span class="comment">// 生产环境时 500 错误的详细错误内容不返回给客户端 因为可能包含敏感信息</span></span><br><span class="line">            <span class="keyword">const</span> error = status === <span class="number">500</span> &amp;&amp; ctx.<span class="property">app</span>.<span class="property">config</span>.<span class="property">env</span> === <span class="string">&#x27;prod&#x27;</span> ? <span class="string">&#x27;Internal Server Error&#x27;</span> : err.<span class="property">message</span>;</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;error&#125;</span><br><span class="line">            <span class="keyword">if</span>(status === <span class="number">422</span>)&#123;</span><br><span class="line">               ctx.<span class="property">body</span>.<span class="property">detail</span> = err.<span class="property">errors</span>;</span><br><span class="line">           &#125;</span><br><span class="line">            ctx.<span class="property">status</span> = status</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用中间件之前需要到config/config.defult.js中注册</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add your middleware config here &#x27;errorHandle&#x27;</span></span><br><span class="line">config.<span class="property">middleware</span> = [<span class="string">&#x27;errorHandle&#x27;</span>];</span><br></pre></td></tr></table></figure>
<p><strong>页面中调用</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="keyword">throw</span>(<span class="number">500</span>,<span class="string">&#x27;故意出错&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="中间件配置">中间件配置</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js中修改的</span></span><br><span class="line"><span class="comment">// add your middleware config here &#x27;errorHandle&#x27;</span></span><br><span class="line">config.<span class="property">middleware</span> = [<span class="string">&#x27;errorHandle&#x27;</span>];</span><br><span class="line">config.<span class="property">errorHandle</span>=&#123;</span><br><span class="line">  <span class="comment">//   enable:false, // 是否开启中间件</span></span><br><span class="line">  <span class="attr">ignore</span>:[<span class="string">&#x27;/index&#x27;</span>], <span class="comment">// 除了这个其他需要</span></span><br><span class="line">  <span class="attr">match</span>:[<span class="string">&#x27;/create&#x27;</span>]   <span class="comment">// 需要用中间件的路由</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="参数验证">参数验证</h5>
<p><a href="https://github.com/D780/egg-valparams">我们需要先下载一个插件：参数验证参考</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-valparams || npm i egg-validate --save</span><br></pre></td></tr></table></figure>
<p>其次我们修改config中的两个文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加一个</span></span><br><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">valparams</span> = &#123;</span><br><span class="line">  enable : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-valparams&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.defult.js</span></span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">valparams</span> = &#123;</span><br><span class="line">  locale : <span class="string">&#x27;zh-cn&#x27;</span>,</span><br><span class="line">  <span class="attr">throwError</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/module/error_handle.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">errorHandle</span>(<span class="params">ctx,next</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(error)&#123;</span><br><span class="line">        <span class="comment">// 错误日志</span></span><br><span class="line">        <span class="comment">// ctx.app.emit(&#x27;error&#x27;,error,ctx);</span></span><br><span class="line"></span><br><span class="line">        ctx.<span class="property">status</span> = error.<span class="property">status</span>;</span><br><span class="line">        <span class="comment">// 判断参数类型</span></span><br><span class="line">        <span class="keyword">if</span>(ctx.<span class="property">status</span> === <span class="number">422</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">msg</span>:<span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>:error.<span class="property">errors</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.<span class="property">body</span>=&#123;</span><br><span class="line">            <span class="attr">msg</span>:<span class="string">&#x27;fail&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>:error.<span class="property">mssage</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app/controller/user.<span class="property">js</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;ctx&#125; = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">//   ctx.validate(&#123;</span></span><br><span class="line">  <span class="comment">//   username  : &#123;type: &#x27;string&#x27;, required: false, defValue: &#x27;account&#x27;, desc: &#x27;系统名称&#x27;&#125;,</span></span><br><span class="line">  <span class="comment">//   password   : &#123;type: &#x27;string&#x27;, required: true, desc: &#x27;token 验证&#x27;&#125;,</span></span><br><span class="line">  <span class="comment">//   sex: &#123;type: &#x27;string&#x27;, required: false, desc: &#x27;登录跳转&#x27;&#125;</span></span><br><span class="line">  <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> params = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// 验证参数</span></span><br><span class="line">  ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">  username  : &#123;<span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">desc</span>: <span class="string">&#x27;用户名&#x27;</span>&#125;,</span><br><span class="line">  password   : &#123;<span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">desc</span>: <span class="string">&#x27;密码&#x27;</span>&#125;,</span><br><span class="line">  <span class="attr">sex</span>: &#123;<span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">desc</span>: <span class="string">&#x27;性别&#x27;</span>&#125;</span><br><span class="line">&#125;);</span><br><span class="line">  <span class="comment">// 写入数据库</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="直播后台编写">直播后台编写</h4>
<h5 id="创建项目">创建项目</h5>
<blockquote>
<p>参照egg官网</p>
</blockquote>
<h5 id="跨域配置">跨域配置</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-cors --save</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line"><span class="attr">cors</span>: &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-cors&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">config.<span class="property">security</span> = &#123;</span><br><span class="line">  <span class="comment">// 关闭 csrf</span></span><br><span class="line">  <span class="attr">csrf</span>: &#123;</span><br><span class="line">    <span class="attr">headerName</span>: <span class="string">&#x27;x-csrf-token&#x27;</span>,</span><br><span class="line">    <span class="attr">ignore</span>: <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="title function_">startsWith</span>(<span class="string">&#x27;/api&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 跨域白名单</span></span><br><span class="line">  <span class="comment">// domainWhiteList: [&quot;http://localhost:3000&quot;],</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 允许跨域的方法</span></span><br><span class="line">config.<span class="property">cors</span> = &#123;</span><br><span class="line">  <span class="attr">origin</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">allowMethods</span>: <span class="string">&quot;GET, PUT, POST, DELETE, PATCH&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="全局相关">全局相关</h5>
<h6 id="封装api返回格式扩展">封装api返回格式扩展</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 成功提示</span></span><br><span class="line">  <span class="title function_">apiSuccess</span>(<span class="params">data = <span class="string">&quot;&quot;</span>, msg = <span class="string">&quot;ok&quot;</span>, code = <span class="number">200</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">body</span> = &#123; msg, data &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = code;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 失败提示</span></span><br><span class="line">  <span class="title function_">apiFail</span>(<span class="params">data = <span class="string">&quot;&quot;</span>, msg = <span class="string">&quot;fail&quot;</span>, code = <span class="number">400</span></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">body</span> = &#123; msg, data &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = code;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 删除密码</span></span><br><span class="line">  <span class="title function_">deletePwd</span>(<span class="params">res</span>) &#123;</span><br><span class="line">    <span class="comment">// 将数据库对象转成普通对象</span></span><br><span class="line">    res = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(res));</span><br><span class="line">    <span class="comment">// 如果是数组</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(res)) &#123;</span><br><span class="line">      <span class="comment">// 循环删除</span></span><br><span class="line">      res.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> item.<span class="property">password</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">delete</span> res.<span class="property">password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;,  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="全局抛出异常处理">全局抛出异常处理</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/error_handler.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">errorHandler</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">      <span class="comment">// 404 处理</span></span><br><span class="line">      <span class="keyword">if</span> (ctx.<span class="property">status</span> === <span class="number">404</span> &amp;&amp; !ctx.<span class="property">body</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">          <span class="attr">msg</span>: <span class="string">&quot;fail&quot;</span>,</span><br><span class="line">          <span class="attr">data</span>: <span class="string">&quot;404 错误&quot;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="comment">// 记录一条错误日志</span></span><br><span class="line">      app.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, err, ctx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> status = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">      <span class="comment">// 生产环境时 500 错误的详细错误内容不返回给客户端，因为可能包含敏感信息</span></span><br><span class="line">      <span class="keyword">const</span> error = status === <span class="number">500</span> &amp;&amp; app.<span class="property">config</span>.<span class="property">env</span> === <span class="string">&quot;prod&quot;</span></span><br><span class="line">        ? <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">        : err.<span class="property">message</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 从 error 对象上读出各个属性，设置到响应中</span></span><br><span class="line">      ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&quot;fail&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: error,</span><br><span class="line">      &#125;;</span><br><span class="line">      ctx.<span class="property">status</span> = status;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="sequelize数据库配置">sequelize数据库配置</h6>
<p>安装并配置<a href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx上）和<a href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在config/plugin.js中引入 egg-sequelize 插件</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&quot;egg-sequelize&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在config/config.default.js</span></span><br><span class="line">config.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&quot;egg-video&quot;</span>,</span><br><span class="line">  <span class="comment">// 中国时区</span></span><br><span class="line">  <span class="attr">timezone</span>: <span class="string">&quot;+08:00&quot;</span>,</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 取消数据表名复数</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">    <span class="comment">// paranoid: true,</span></span><br><span class="line">    <span class="attr">createdAt</span>: <span class="string">&quot;created_time&quot;</span>,</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;updated_time&quot;</span>,</span><br><span class="line">    <span class="comment">// deletedAt: &#x27;deleted_time&#x27;,</span></span><br><span class="line">    <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">    <span class="attr">underscored</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="数据库迁移配置">数据库迁移配置</h6>
<p>sequelize 提供了<a href="https://github.com/sequelize/cli">sequelize-cli</a>工具来实现<a target="_blank" rel="noopener" href="http://docs.sequelizejs.com/manual/tutorial/migrations.html">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>
<p>egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">config</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/config.json&quot;</span>),</span><br><span class="line">  <span class="string">&quot;migrations-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/migrations&quot;</span>),</span><br><span class="line">  <span class="string">&quot;seeders-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/seeders&quot;</span>),</span><br><span class="line">  <span class="string">&quot;models-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;app/model&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>初始化 Migrations 配置文件和目录</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize init:config</span><br><span class="line">npx sequelize init:migrations</span><br><span class="line"># npx sequelize init:models</span><br></pre></td></tr></table></figure>
<p>执行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;development&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;database&quot;</span>: <span class="string">&quot;egg-video&quot;</span>,</span><br><span class="line">    <span class="string">&quot;host&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dialect&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timezone&quot;</span>: <span class="string">&quot;+08:00&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>创建数据库</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:create</span><br><span class="line"></span><br><span class="line"># 升级数据库</span><br><span class="line">npx sequelize db:migrate</span><br><span class="line"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span><br><span class="line"># npx sequelize db:migrate:undo</span><br><span class="line"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span><br><span class="line"># npx sequelize db:migrate:undo:all</span><br></pre></td></tr></table></figure>
<h6 id="模型关联">模型关联</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">  <span class="comment">// 关联用户资料 一对一</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  <span class="comment">// 反向一对一关联</span></span><br><span class="line">  <span class="comment">// Userinfo.belongsTo(app.model.User);</span></span><br><span class="line">  <span class="comment">// 一对多关联</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="title function_">hasMany</span>(app.<span class="property">model</span>.<span class="property">Post</span>);</span><br><span class="line">  <span class="comment">// 反向一对多关联</span></span><br><span class="line">  <span class="comment">// Post.belongsTo(app.model.User);</span></span><br><span class="line">  <span class="comment">// 多对多</span></span><br><span class="line">  <span class="comment">// User.belongsToMany(Project, &#123; as: &#x27;Tasks&#x27;, through: &#x27;worker_tasks&#x27;, foreignKey: &#x27;userId&#x27; &#125;)</span></span><br><span class="line">  <span class="comment">// 反向多对多</span></span><br><span class="line">  <span class="comment">// Project.belongsToMany(User, &#123; as: &#x27;Workers&#x27;, through: &#x27;worker_tasks&#x27;, foreignKey: &#x27;projectId&#x27; &#125;)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="模板引擎">模板引擎</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-view-nunjucks --save</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://nunjucks.bootcss.com/templating.html">Nunjuck文档</a></p>
<p><strong>配置插件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line"><span class="attr">nunjucks</span>: &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-view-nunjucks&#x27;</span>, </span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><code>config/config.default.js</code> 目录下配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">view</span> = &#123;</span><br><span class="line">  <span class="attr">mapping</span>: &#123;</span><br><span class="line">    <span class="string">&quot;.html&quot;</span>: <span class="string">&quot;nunjucks&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="参数验证-2">参数验证</h6>
<p><strong>安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-valparams --save || npm i egg-validate --save</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line">valparams : &#123;</span><br><span class="line">  enable : <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-valparams&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">config.<span class="property">valparams</span> = &#123;</span><br><span class="line">  locale : <span class="string">&#x27;zh-cn&#x27;</span>,</span><br><span class="line">  <span class="attr">throwError</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>中间件：app/middleware/errorHandler.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">errorHandler</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">      <span class="comment">// 404 处理</span></span><br><span class="line">      <span class="keyword">if</span> (ctx.<span class="property">status</span> === <span class="number">404</span> &amp;&amp; !ctx.<span class="property">body</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">          <span class="attr">msg</span>: <span class="string">&quot;fail&quot;</span>,</span><br><span class="line">          <span class="attr">data</span>: <span class="string">&quot;404 错误&quot;</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="comment">// 记录一条错误日志</span></span><br><span class="line">      app.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, err, ctx);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> status = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">      <span class="comment">// 生产环境时 500 错误的详细错误内容不返回给客户端，因为可能包含敏感信息</span></span><br><span class="line">      <span class="keyword">let</span> error =</span><br><span class="line">        status === <span class="number">500</span> &amp;&amp; app.<span class="property">config</span>.<span class="property">env</span> === <span class="string">&quot;prod&quot;</span></span><br><span class="line">          ? <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">          : err.<span class="property">message</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数验证异常</span></span><br><span class="line">      <span class="keyword">if</span> (status === <span class="number">422</span> &amp;&amp; err.<span class="property">message</span> === <span class="string">&quot;Validation Failed&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (err.<span class="property">errors</span> &amp;&amp; <span class="title class_">Array</span>.<span class="title function_">isArray</span>(err.<span class="property">errors</span>)) &#123;</span><br><span class="line">          error = err.<span class="property">errors</span>[<span class="number">0</span>].<span class="property">message</span></span><br><span class="line">            ? err.<span class="property">errors</span>[<span class="number">0</span>].<span class="property">message</span></span><br><span class="line">            : <span class="string">&#x27;参数验证失败&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ctx.<span class="property">status</span> = status;</span><br><span class="line">      <span class="comment">// 从 error 对象上读出各个属性，设置到响应中</span></span><br><span class="line">      ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&quot;fail&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: error,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>在控制器里使用</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XXXController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">app.Controller</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">XXX</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">      <span class="attr">system</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">        <span class="attr">required</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defValue</span>: <span class="string">&quot;account&quot;</span>,</span><br><span class="line">        <span class="attr">desc</span>: <span class="string">&quot;系统名称&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">token</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">desc</span>: <span class="string">&quot;token 验证&quot;</span> &#125;,</span><br><span class="line">      <span class="attr">redirect</span>: &#123; <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>, <span class="attr">required</span>: <span class="literal">false</span>, <span class="attr">desc</span>: <span class="string">&quot;登录跳转&quot;</span> &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// if (config.throwError === false)</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">paramErrors</span>) &#123;</span><br><span class="line">      <span class="comment">// get error infos from `ctx.paramErrors`;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> params = ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="keyword">let</span> &#123; query, body &#125; = ctx.<span class="property">request</span>;</span><br><span class="line">    <span class="comment">// ctx.params        = validater.ret.params;</span></span><br><span class="line">    <span class="comment">// ctx.request.query = validater.ret.query;</span></span><br><span class="line">    <span class="comment">// ctx.request.body  = validater.ret.body;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ctx.<span class="property">body</span> = query;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>参数验证处理</strong></p>
<p>Valparams.setParams(req, params, options);</p>
<p><a href="https://github.com/D780/valparams/blob/master/doc/api.md#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81%E5%A4%84%E7%90%86">具体参数验证处理</a></p>
<h5 id="管理员模块">管理员模块</h5>
<h6 id="创建管理员">创建管理员</h6>
<p><strong>创建数据迁移表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=manager</span><br></pre></td></tr></table></figure>
<p>执行完命令后，会在 <code>database/migrations/</code> 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// database/migrations//manager.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;manager&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">username</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;manager&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>执行 migrate 进行数据库变更</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 升级数据库</span><br><span class="line">npx sequelize <span class="attr">db</span>:migrate</span><br><span class="line"></span><br><span class="line"># 如果有问题需要回滚，可以通过 <span class="string">`db:migrate:undo`</span> 回退一个变更</span><br><span class="line"></span><br><span class="line"># npx sequelize <span class="attr">db</span>:<span class="attr">migrate</span>:undo</span><br><span class="line"></span><br><span class="line"># 可以通过 <span class="string">`db:migrate:undo:all`</span> 回退到初始状态</span><br></pre></td></tr></table></figure>
<p><strong>安装 crypto 模块</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install crypto-js</span><br></pre></td></tr></table></figure>
<p>配置文件配置 config / config.default.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">crypto</span> = &#123;</span><br><span class="line">  <span class="attr">secret</span>: <span class="string">&quot;qhdgw@45ncashdaksh2!#@3nxjdas*_672&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/model/manager.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Manager</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;manager&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">username</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> hmac = crypto.<span class="title function_">createHash</span>(<span class="string">&quot;sha256&quot;</span>, app.<span class="property">config</span>.<span class="property">crypto</span>.<span class="property">secret</span>);</span><br><span class="line">        hmac.<span class="title function_">update</span>(val);</span><br><span class="line">        <span class="keyword">let</span> hash = hmac.<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setDataValue</span>(<span class="string">&quot;password&quot;</span>, hash);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> app.<span class="title function_">formatTime</span>(<span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;created_time&quot;</span>));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Manager</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>封装格式化时间方法</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/application.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="title function_">formatTime</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(time);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Month</span> = (d.<span class="title function_">getMonth</span>() + <span class="number">1</span>) &gt;= <span class="number">10</span></span><br><span class="line">      ? (d.<span class="title function_">getMonth</span>() + <span class="number">1</span>)</span><br><span class="line">      : <span class="string">&quot;0&quot;</span> + (d.<span class="title function_">getMonth</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Day</span> = d.<span class="title function_">getDate</span>() &gt;= <span class="number">10</span> ? d.<span class="title function_">getDate</span>() : <span class="string">&quot;0&quot;</span> + d.<span class="title function_">getDate</span>();</span><br><span class="line">    <span class="keyword">const</span> h = d.<span class="title function_">getHours</span>() &gt;= <span class="number">10</span> ? d.<span class="title function_">getHours</span>() : <span class="string">&quot;0&quot;</span> + d.<span class="title function_">getHours</span>();</span><br><span class="line">    <span class="keyword">const</span> m = d.<span class="title function_">getMinutes</span>() &gt;= <span class="number">10</span> ? d.<span class="title function_">getMinutes</span>() : <span class="string">&quot;0&quot;</span> + d.<span class="title function_">getMinutes</span>();</span><br><span class="line">    <span class="keyword">const</span> s = d.<span class="title function_">getSeconds</span>() &gt;= <span class="number">10</span> ? d.<span class="title function_">getSeconds</span>() : <span class="string">&quot;0&quot;</span> + d.<span class="title function_">getSeconds</span>();</span><br><span class="line">    <span class="keyword">return</span> d.<span class="title function_">getFullYear</span>() + <span class="string">&quot;-&quot;</span> + <span class="title class_">Month</span> + <span class="string">&quot;-&quot;</span> + <span class="title class_">Day</span> + <span class="string">&quot; &quot;</span> + h + <span class="string">&quot;:&quot;</span> + m + <span class="string">&quot;:&quot;</span> +</span><br><span class="line">      s;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 展示创建管理员页</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/manager/create&quot;</span>, controller.<span class="property">manager</span>.<span class="property">showCreate</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建管理员</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/manager&quot;</span>, controller.<span class="property">manager</span>.<span class="property">create</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/manager.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 展示创建页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">showCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&quot;manager/create.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建管理员</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 获取管理员模型</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Manager</span> = ctx.<span class="property">model</span>.<span class="property">Manager</span>;</span><br><span class="line">  <span class="comment">// 获取前端提交的请求体</span></span><br><span class="line">  <span class="keyword">let</span> body = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数验证</span></span><br><span class="line">  ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">    <span class="attr">username</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">desc</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">desc</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 查询该用户是否已经存在</span></span><br><span class="line">  <span class="keyword">let</span> manager = <span class="keyword">await</span> <span class="title class_">Manager</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">username</span>: body.<span class="property">username</span> &#125; &#125;);</span><br><span class="line">  <span class="comment">// 如果存在则报错</span></span><br><span class="line">  <span class="keyword">if</span> (manager) &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;该用户已存在&quot;</span>, <span class="number">400</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果不存在则创建</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title class_">Manager</span>.<span class="title function_">create</span>(body);</span><br><span class="line">  <span class="comment">// 删除密码</span></span><br><span class="line">  res = ctx.<span class="title function_">deletePwd</span>(res);</span><br><span class="line">  <span class="comment">// 响应</span></span><br><span class="line">  ctx.<span class="title function_">apiSuccess</span>(res, <span class="string">&quot;创建成功&quot;</span>, <span class="number">201</span>);</span><br><span class="line">  <span class="comment">// 重定向</span></span><br><span class="line">  ctx.<span class="title function_">redirect</span>(<span class="string">&quot;/manager/index&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>context扩展</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"><span class="comment">// 消息提示</span></span><br><span class="line"><span class="title function_">toast</span>(<span class="params">msg,type = <span class="string">&#x27;danger&#x27;</span></span>)&#123;</span><br><span class="line"><span class="comment">// 设置消息提示到cookie中</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&#x27;toast&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">       msg,type</span><br><span class="line">   &#125;),&#123;</span><br><span class="line">    <span class="comment">// 过期时间</span></span><br><span class="line">       <span class="attr">maxAge</span>: <span class="number">1500</span>, </span><br><span class="line">    <span class="comment">// 中文需要加密</span></span><br><span class="line">       <span class="attr">encrypt</span>: <span class="literal">true</span></span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>模板部分（公共布局）</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 公共的页面 可复用 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0, user-scalable=0&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 后端传数据的写法 --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;title&gt;直播后台 - &#123;&#123;title&#125;&#125;&lt;/title&gt; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 前端传数据的写法 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>直播后台 - &#123;&#123;subtitle&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Favicon --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;shortcut icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/x-icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/public/assets/img/favicon.png&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Bootstrap CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://cdn.bootstrapmb.com/bootstrap/4.3.1/css/bootstrap.min.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Fontawesome CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/public/assets/css/font-awesome.min.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Feathericon CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/public/assets/css/feathericon.min.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/public/assets/plugins/morris/morris.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Main CSS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/public/assets/css/style.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.alert</span> &#123;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">top</span>: <span class="number">80px</span>;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">right</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Main Wrapper --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-wrapper&quot;</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Header --&gt;</span></span><br><span class="line">    &#123;% include &quot;./header.html&quot; %&#125;</span><br><span class="line">    <span class="comment">&lt;!-- /Header --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Sidebar --&gt;</span></span><br><span class="line">    &#123;% include &quot;./slider.html&quot; %&#125;</span><br><span class="line">    <span class="comment">&lt;!-- /Sidebar --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Page Wrapper --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-wrapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 删除成功的弹窗 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">alert</span> <span class="attr">ref</span>=<span class="string">&quot;alert&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">alert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- 确认删除的弹窗 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">modal</span> <span class="attr">ref</span>=<span class="string">&quot;modal&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">modal</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content container-fluid&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row align-items-center&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;page-title&quot;</span>&gt;</span>&#123;&#123;subtitle&#125;&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;breadcrumb&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;breadcrumb-item&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;index.html&quot;</span>&gt;</span>后台首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;breadcrumb-item active&quot;</span>&gt;</span>&#123;&#123;subtitle&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 留个坑 --&gt;</span></span><br><span class="line">        &#123;% block body %&#125;我是默认的&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /Page Wrapper --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- /Main Wrapper --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- jQuery --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/jquery-3.2.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Bootstrap Core JS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/popper.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://cdn.bootstrapmb.com/bootstrap/4.3.1/js/bootstrap.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Slimscroll JS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/plugins/slimscroll/jquery.slimscroll.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Custom JS --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/script.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 引入vue --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 引入公共的组件 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/common-components.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 共用的js --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 通过混入配置项的方式</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title class_">Vue</span>.<span class="title function_">mixin</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 改变纯文本插入分隔符</span></span></span><br><span class="line"><span class="language-javascript">      <span class="attr">delimiters</span>: [<span class="string">&#x27;%&#123;&#x27;</span>, <span class="string">&#x27;&#125;%&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 挖个坑 给每个页面编写自己的js逻辑 --&gt;</span></span><br><span class="line">  &#123;% block script %&#125;&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>模板部分（公共头部）</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span> <span class="attr">id</span>=<span class="string">&quot;headerapp&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Logo --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header-left&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;index.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/img/logo.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Logo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;index.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;logo logo-small&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/img/logo-small.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Logo&quot;</span> <span class="attr">width</span>=<span class="string">&quot;30&quot;</span> <span class="attr">height</span>=<span class="string">&quot;30&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- /Logo --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:void(0);&quot;</span> <span class="attr">id</span>=<span class="string">&quot;toggle_btn&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fe fe-text-align-left&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;top-nav-search&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Search here&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-search&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Mobile Menu Toggle --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;mobile_btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;mobile_btn&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-bars&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- /Mobile Menu Toggle --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- Header Right Menu --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;nav user-menu&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- User Menu --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item dropdown has-arrow&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;dropdown-toggle nav-link&quot;</span> <span class="attr">data-toggle</span>=<span class="string">&quot;dropdown&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;user-img&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/img/profiles/avatar-01.jpg&quot;</span> <span class="attr">width</span>=<span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">alt</span>=<span class="string">&quot;Ryan Taylor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;dropdown-menu&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-header&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;avatar avatar-sm&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/img/profiles/avatar-01.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;User Image&quot;</span> <span class="attr">class</span>=<span class="string">&quot;avatar-img rounded-circle&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;user-text&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h6</span>&gt;</span>%&#123; user.username &#125;%<span class="tag">&lt;/<span class="name">h6</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;text-muted mb-0&quot;</span>&gt;</span>超级管理员<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;dropdown-item&quot;</span> <span class="attr">href</span>=<span class="string">&quot;profile.html&quot;</span>&gt;</span>修改资料<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;dropdown-item&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/admin/logout&quot;</span>&gt;</span>退出登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- /User Menu --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- /Header Right Menu --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/js/vue.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">el</span>: <span class="string">&#x27;#headerapp&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">delimiters</span>: [<span class="string">&#x27;%&#123;&#x27;</span>, <span class="string">&#x27;&#125;%&#x27;</span>],</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">user</span>: &#123;&#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">this</span>.<span class="property">user</span> = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;user&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">user</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">  &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>模板部分（公共侧边）</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar-inner slimscroll&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;sidebar-menu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sidebar-menu&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 动态渲染侧边栏 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;% for item in ctx.locals.sidebar %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;&#123;&#123; item.active &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123;item.url&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fe &#123;&#123;item.icon&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="管理员列表">管理员列表</h6>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/manager&quot;</span>, controller.<span class="property">admin</span>.<span class="property">manager</span>.<span class="property">index</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制层</span></span><br><span class="line"><span class="comment">// app/controller/manager.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line"><span class="comment">// 获取所有管理员的数据</span></span><br><span class="line"><span class="keyword">let</span> data = <span class="keyword">await</span> ctx.<span class="title function_">paging</span>(</span><br><span class="line">  <span class="string">&quot;Manager&quot;</span>,</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 排序</span></span><br><span class="line">    <span class="attr">order</span>: [</span><br><span class="line">      <span class="comment">// id 降序</span></span><br><span class="line">      [<span class="string">&quot;created_time&quot;</span>, <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    ],</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 删除密码</span></span><br><span class="line">data = ctx.<span class="title function_">deletePwd</span>(data);</span><br><span class="line"><span class="comment">// 渲染</span></span><br><span class="line"><span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&quot;manager/index.html&quot;</span>, &#123;</span><br><span class="line">  data,</span><br><span class="line">  <span class="attr">subtitle</span>: <span class="string">&quot;管理员管理&quot;</span>,</span><br><span class="line"> &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>扩展</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">page</span>(<span class="params">modelName, where, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> page = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="property">page</span> ? <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">query</span>.<span class="property">page</span>) : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> limit = <span class="variable language_">this</span>.<span class="property">query</span>.<span class="property">limit</span> ? <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">query</span>.<span class="property">limit</span>) : <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">let</span> offset = (page - <span class="number">1</span>) * limit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!options.<span class="property">order</span>) &#123;</span><br><span class="line">        options.<span class="property">order</span> = [</span><br><span class="line">            [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>[modelName].<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">        where,</span><br><span class="line">        offset,</span><br><span class="line">        limit,</span><br><span class="line">        ...options</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 总共有多少页</span></span><br><span class="line">    <span class="keyword">let</span> totalPage = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(res.<span class="property">count</span> / limit)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他参数</span></span><br><span class="line">    <span class="keyword">let</span> query = &#123; ...<span class="variable language_">this</span>.<span class="property">query</span> &#125;</span><br><span class="line">    <span class="keyword">if</span> (query.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;page&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">delete</span> query.<span class="property">page</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (query.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;limit&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">delete</span> query.<span class="property">limit</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象转&amp;拼接字符串</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">urlEncode</span> = (<span class="params">param, key, encode</span>)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span> (param==<span class="literal">null</span>) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> paramStr = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> t = <span class="keyword">typeof</span> (param);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="string">&#x27;string&#x27;</span> || t == <span class="string">&#x27;number&#x27;</span> || t == <span class="string">&#x27;boolean&#x27;</span>) &#123;</span><br><span class="line">            paramStr += <span class="string">&#x27;&amp;&#x27;</span> + key + <span class="string">&#x27;=&#x27;</span>  + ((encode==<span class="literal">null</span>||encode) ? <span class="built_in">encodeURIComponent</span>(param) : param); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> param) &#123;</span><br><span class="line">                <span class="keyword">var</span> k = key == <span class="literal">null</span> ? i : key + (param <span class="keyword">instanceof</span> <span class="title class_">Array</span> ? <span class="string">&#x27;[&#x27;</span> + i + <span class="string">&#x27;]&#x27;</span> : <span class="string">&#x27;.&#x27;</span> + i)</span><br><span class="line">                paramStr += <span class="title function_">urlEncode</span>(param[i], k, encode)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> paramStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    query = <span class="title function_">urlEncode</span>(query)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pageEl = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">1</span>; index &lt;= totalPage; index++) &#123;</span><br><span class="line">        <span class="comment">// 当前页码</span></span><br><span class="line">        <span class="keyword">let</span> active = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(index === page)&#123;</span><br><span class="line">            active = <span class="string">&#x27;active&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pageEl += <span class="string">`&lt;li class=&quot;page-item <span class="subst">$&#123;active&#125;</span>&quot;&gt;&lt;a class=&quot;page-link&quot; href=&quot;?page=<span class="subst">$&#123;index&#125;</span>&amp;limit=<span class="subst">$&#123;limit&#125;</span><span class="subst">$&#123;query&#125;</span>&quot;&gt;<span class="subst">$&#123;index&#125;</span>&lt;/a&gt;&lt;/li&gt;`</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> preDisabled = page &lt;= <span class="number">1</span> ? <span class="string">&#x27;disabled&#x27;</span> : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> nextDisabled = page &gt;= totalPage ? <span class="string">&#x27;disabled&#x27;</span> : <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> pageRender = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;ul class=&quot;pagination&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;li class=&quot;page-item <span class="subst">$&#123;preDisabled&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;a class=&quot;page-link&quot; href=&quot;?page=<span class="subst">$&#123;page - <span class="number">1</span>&#125;</span>&amp;limit=<span class="subst">$&#123;limit&#125;</span><span class="subst">$&#123;query&#125;</span>&quot; aria-label=&quot;Previous&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;</span></span><br><span class="line"><span class="string">                &lt;span class=&quot;sr-only&quot;&gt;Previous&lt;/span&gt;</span></span><br><span class="line"><span class="string">            &lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;/li&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;pageEl&#125;</span></span></span><br><span class="line"><span class="string">        &lt;li class=&quot;page-item <span class="subst">$&#123;nextDisabled&#125;</span>&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;a class=&quot;page-link&quot; href=&quot;?page=<span class="subst">$&#123;page + <span class="number">1</span>&#125;</span>&amp;limit=<span class="subst">$&#123;limit&#125;</span><span class="subst">$&#123;query&#125;</span>&quot; aria-label=&quot;Next&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;</span></span><br><span class="line"><span class="string">                &lt;span class=&quot;sr-only&quot;&gt;Next&lt;/span&gt;</span></span><br><span class="line"><span class="string">            &lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">        `</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">locals</span>.<span class="property">pageRender</span> = pageRender</span><br><span class="line">    <span class="keyword">return</span> res.<span class="property">rows</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h6 id="修改管理员">修改管理员</h6>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router/manager.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;manager/edit/:id&quot;</span>, controller.<span class="property">manager</span>.<span class="property">edit</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;manager/:id&quot;</span>, controller.<span class="property">manager</span>.<span class="property">update</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/manager.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 显示修改管理员页</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">showEdit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Manager</span> = ctx.<span class="property">model</span>.<span class="property">Manager</span>;</span><br><span class="line">    <span class="keyword">let</span> &#123; id &#125; = ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 查询管理员是否存在</span></span><br><span class="line">    <span class="keyword">let</span> manager = <span class="keyword">await</span> <span class="title class_">Manager</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="comment">// 将查询出来的管理员保存到app上 =&gt; 为了确认修改</span></span><br><span class="line">    ctx.<span class="property">app</span>.<span class="property">manager</span> = manager;</span><br><span class="line">    <span class="keyword">if</span> (!manager) &#123;</span><br><span class="line">      <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;该用户不存在&quot;</span>, <span class="number">400</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&quot;manager/create.html&quot;</span>, &#123;</span><br><span class="line">      manager,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 修改管理员</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">editManager</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> body = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 查询管理员是否存在步骤省略 上面显示管理员页已查询</span></span><br><span class="line">    <span class="comment">// 修改 </span></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> ctx.<span class="property">app</span>.<span class="property">manager</span>.<span class="title function_">update</span>(body);</span><br><span class="line">    res &amp;&amp; ctx.<span class="title function_">apiSuccess</span>(res, <span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">&quot;/manager/index&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>扩展</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 页面失败提示</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">pageFail</span>(<span class="params">data = <span class="string">&#x27;&#x27;</span>, code = <span class="number">404</span></span>)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">render</span>(<span class="string">&#x27;admin/common/404.html&#x27;</span>, &#123;</span><br><span class="line">       data, code</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><strong>模板</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/view/admin/common/404.html</span></span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">extends</span> <span class="string">&quot;admin/layout/main.html&quot;</span> %&#125;</span><br><span class="line">&#123;% block title %&#125;<span class="number">404</span>&#123;% endblock %&#125;</span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;error-page&quot;</span>&gt;	</span><br><span class="line">    &lt;!-- <span class="title class_">Main</span> <span class="title class_">Wrapper</span> --&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-wrapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;error-box&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123; code &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;h2 mb-3&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-warning&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> &#123;&#123; data &#125;&#125; <span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/admin&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>返回后台首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h6 id="删除管理员">删除管理员</h6>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/manager/delete/:id&quot;</span>, controller.<span class="property">manager</span>.<span class="property">delete</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/admin/manager.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">delete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Manager</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="title function_">toast</span>(<span class="string">&#x27;删除成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/manager`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>扩展</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">toast</span>(<span class="params">msg,type = <span class="string">&#x27;danger&#x27;</span></span>)&#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&#x27;toast&#x27;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">       msg,type</span><br><span class="line">   &#125;),&#123;</span><br><span class="line">       <span class="attr">maxAge</span>: <span class="number">1500</span>, </span><br><span class="line">       <span class="attr">encrypt</span>: <span class="literal">true</span></span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="登录模块">登录模块</h5>
<p><strong>配置session</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">session</span> = &#123;</span><br><span class="line">  <span class="comment">// 在有些场景下，我们希望用户如果长时间都在访问我们的站点，则延长他们的 Session 有效期，不让用户退出登录态</span></span><br><span class="line">  <span class="attr">renew</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// key 代表了存储 Session 的 Cookie 键值对的 key 是什么</span></span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;EGG_SESS&quot;</span>,</span><br><span class="line">  <span class="comment">// 最长保存时间（毫秒）</span></span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span> * <span class="number">30</span>, <span class="comment">// 30 天</span></span><br><span class="line">  <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// 加密</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/login&quot;</span>, controller.<span class="property">admin</span>.<span class="property">login</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/admin/loginevent&quot;</span>, controller.<span class="property">admin</span>.<span class="property">loginevent</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/home.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入crypto</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="comment">// 登录页</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> toast = ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&#x27;toast&#x27;</span>,&#123; <span class="attr">encrypt</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    toast = toast ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(toast) : <span class="literal">null</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;admin/home/login.html&#x27;</span>,&#123;</span><br><span class="line">        toast</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">let</span> manager = ctx.<span class="property">model</span>.<span class="property">Manager</span>;</span><br><span class="line">  <span class="keyword">let</span> &#123; username, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  <span class="comment">// 验证用户名是否存在</span></span><br><span class="line">  <span class="keyword">let</span> m = <span class="keyword">await</span> manager.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; username &#125; &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="keyword">throw</span>(<span class="string">&quot;用户不存在或已禁用&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 验证密码是否正确</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">checkPassword</span>(m.<span class="property">password</span>, password);</span><br><span class="line">  <span class="comment">// 删除密码</span></span><br><span class="line">  m = ctx.<span class="title function_">deletePwd</span>(m);</span><br><span class="line">  <span class="comment">// 将用户信息保存到session一份</span></span><br><span class="line">  ctx.<span class="property">session</span>.<span class="property">manager</span> = m;</span><br><span class="line">  <span class="comment">// 响应</span></span><br><span class="line">  ctx.<span class="title function_">apiSuccess</span>(m, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 验证密码</span></span><br><span class="line">  <span class="title function_">checkPassword</span>(<span class="params">oldPwd, newPwd</span>) &#123;</span><br><span class="line">    <span class="comment">// 将用户提交的密码进行hash创建</span></span><br><span class="line">    newPwd = crypto</span><br><span class="line">      .<span class="title function_">createHash</span>(<span class="string">&quot;sha256&quot;</span>, <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">config</span>.<span class="property">crypto</span>.<span class="property">secret</span>)</span><br><span class="line">      .<span class="title function_">update</span>(newPwd)</span><br><span class="line">      .<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">    <span class="comment">// 再和数据的密码进行比对</span></span><br><span class="line">    <span class="keyword">if</span> (oldPwd !== newPwd) &#123;</span><br><span class="line">      <span class="comment">// this.ctx.throw(400, &#x27;密码输入错误&#x27;)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="keyword">throw</span>(<span class="string">&quot;密码输入错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>模板</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">// app/view/admin/home/login.html</span><br><span class="line"></span><br><span class="line">&#123;% extends &quot;admin/layout/main.html&quot; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125; 后台登录 &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block body %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-wrapper login-body&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-wrapper&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;loginbox&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-left&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;img-fluid&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/public/assets/img/logo (1).png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;Logo&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-right&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;login-right-wrap&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>登 录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;account-subtitle&quot;</span>&gt;</span>Access to our dashboard<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">&lt;!-- Form --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;输入用户名...&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.username&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;输入密码...&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.password&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary btn-block&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> @<span class="attr">click.stop.prevent</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>登 录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block js %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>: <span class="string">&#x27;#vueapp&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">form</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">username</span>:<span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">password</span>:<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            &#123;% <span class="keyword">if</span> toast %&#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">toast</span>.<span class="title function_">show</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="language-javascript">                    msg: <span class="string">&quot;&#123;&#123;toast.msg&#125;&#125;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="language-javascript">                    type: <span class="string">&quot;&#123;&#123;toast.type&#125;&#125;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="language-javascript">                &#125;</span>)</span></span><br><span class="line"><span class="language-javascript">            &#123;% endif %&#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">submit</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> _t = <span class="variable language_">this</span></span></span><br><span class="line"><span class="language-javascript">                $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">contentType</span>: <span class="string">&quot;application/json;charset=UTF-8&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">url</span>: <span class="string">&quot;/admin/loginevent?_csrf=&#123;&#123;ctx.csrf|safe&#125;&#125;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">form</span>),</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">result</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        _t.<span class="property">$refs</span>.<span class="property">toast</span>.<span class="title function_">show</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">msg</span>: <span class="string">&quot;登录成功&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">type</span>:<span class="string">&quot;success&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&quot;/admin&quot;</span></span></span><br><span class="line"><span class="language-javascript">                            &#125;,</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">delay</span>:<span class="number">1000</span></span></span><br><span class="line"><span class="language-javascript">                        &#125;)</span></span><br><span class="line"><span class="language-javascript">                    &#125;,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        _t.<span class="property">$refs</span>.<span class="property">toast</span>.<span class="title function_">show</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                            <span class="attr">msg</span>: e.<span class="property">responseJSON</span>.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">                        &#125;)</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h6 id="权限验证">权限验证</h6>
<p><strong>中间件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/adminAuth.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ctx.<span class="property">session</span>.<span class="property">auth</span>) &#123;</span><br><span class="line">      ctx.<span class="title function_">toast</span>(<span class="string">&quot;请先登录&quot;</span>, <span class="string">&quot;danger&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/login`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx.<span class="property">status</span> === <span class="number">404</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> ctx.<span class="title function_">pageFail</span>(<span class="string">&quot;页面不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">middleware</span> = [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="string">&quot;adminAuth&quot;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">];</span><br><span class="line">config.<span class="property">adminAuth</span> = &#123;</span><br><span class="line">  <span class="attr">ignore</span>: [</span><br><span class="line">    <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/admin/login&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/admin/loginevent&quot;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="退出登录">退出登录</h6>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/logout&quot;</span>, controller.<span class="property">admin</span>.<span class="property">home</span>.<span class="property">logout</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/admin/home.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 退出登录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, service &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 清除session</span></span><br><span class="line">    ctx.<span class="property">session</span>.<span class="property">auth</span> = <span class="literal">null</span></span><br><span class="line">    ctx.<span class="title function_">toast</span>(<span class="string">&#x27;退出登录成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/login`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="公共模块">公共模块</h5>
<h6 id="侧边栏">侧边栏</h6>
<p><strong>中间件</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/admin_sidebar.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> menus = [&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;主面板&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-home&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/admin&quot;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;用户管理&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-user-plus&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/user&quot;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;直播间管理&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-document&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/live&quot;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;礼物管理&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-vector&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/gift&quot;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;订单管理&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-cart&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/order&quot;</span>,</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;管理员管理&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;fe-table&quot;</span>,</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/manager&quot;</span>,</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    ctx.<span class="property">locals</span>.<span class="property">sidebar</span> = menus.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// 请求路径是否 === /admin &amp;&amp; 当前项的url属性 === /admin || 请求的地址是否以当前项的url开头 &amp;&amp; 请求路径是否 != /admin &amp;&amp; 当前项地址 !== /admin</span></span><br><span class="line">        (ctx.<span class="property">request</span>.<span class="property">url</span> === <span class="string">&quot;/admin&quot;</span> &amp;&amp; item.<span class="property">url</span> === <span class="string">&quot;/admin&quot;</span>) || </span><br><span class="line">        (ctx.<span class="property">request</span>.<span class="property">url</span>.<span class="title function_">startsWith</span>(item.<span class="property">url</span>) &amp;&amp; ctx.<span class="property">request</span>.<span class="property">url</span> != <span class="string">&quot;/admin&quot;</span>) &amp;&amp; item.<span class="property">url</span> !== <span class="string">&quot;/admin&quot;</span>) &#123;</span><br><span class="line">         item.<span class="property">active</span> = <span class="string">&quot;active&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> item;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">middleware</span> = [</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="string">&quot;adminSidebar&quot;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">];</span><br><span class="line">config.<span class="property">adminSidebar</span> = &#123;</span><br><span class="line">  <span class="attr">ignore</span>: [</span><br><span class="line">    <span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/admin/login&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/admin/loginevent&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/public&quot;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>模板</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// app/view/admin/layout/slider.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sidebar-inner slimscroll&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;sidebar-menu&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sidebar-menu&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">                &#123;% for item in ctx.locals.sidebar %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;&#123;&#123; item.active &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;&#123;&#123;item.url&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fe &#123;&#123;item.icon&#125;&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="上传图片">上传图片</h6>
<p><strong>安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i await-stream-ready stream-wormhole dayjs --save</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">multipart</span> = &#123;</span><br><span class="line">  <span class="attr">fileSize</span>: <span class="string">&quot;50mb&quot;</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;stream&quot;</span>,</span><br><span class="line">  <span class="attr">fileExtensions</span>: [</span><br><span class="line">    <span class="string">&quot;.xls&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.jpg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.JPG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.png&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.PNG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.gif&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.GIF&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.jpeg&quot;</span>,</span><br><span class="line">    <span class="string">&quot;.JPEG&quot;</span>,</span><br><span class="line">  ], <span class="comment">// 扩展几种上传的文件格式</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router/user.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/user/upload&quot;</span>, controller.<span class="property">user</span>.<span class="property">upload</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为什么要需要流?</span></span><br><span class="line"><span class="comment">// 因为在node中读取文件的方式有两种，一个是利用fs模块，一个是利用流来读取。如果读取小文件，我们可以使用fs读取，fs读取文件的时候，是将文件一次性读取到本地内存。而如果读取一个大文件，一次性读取会占用大量内存，效率很低，这个时候需要用流来读取。流是将数据分割成段，一段一段的读取，可以控制速率,效率很高,不会占用太大的内存。gulp的task任务，文件压缩，和http中的请求和响应等功能的实现都是基于流来实现的。因此，系统学习下流还是很有必要的</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入文件系统模块</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="comment">// 引入路径处理的模块</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="comment">// 故名思意 异步二进制 写入流</span></span><br><span class="line"><span class="keyword">const</span> awaitWriteStream = <span class="built_in">require</span>(<span class="string">&quot;await-stream-ready&quot;</span>).<span class="property">write</span>;</span><br><span class="line"><span class="comment">// 管道读入一个虫洞。</span></span><br><span class="line"><span class="keyword">const</span> sendToWormhole = <span class="built_in">require</span>(<span class="string">&quot;stream-wormhole&quot;</span>);</span><br><span class="line"><span class="comment">// 格式化时间</span></span><br><span class="line"><span class="keyword">const</span> dayjs = <span class="built_in">require</span>(<span class="string">&quot;dayjs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传图片</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 获取文件流对象</span></span><br><span class="line">  <span class="keyword">const</span> stream = <span class="keyword">await</span> ctx.<span class="title function_">getFileStream</span>();</span><br><span class="line">  <span class="comment">// 基础的目录 =&gt; 指定文件上传到哪个目录</span></span><br><span class="line">  <span class="keyword">const</span> uploadBasePath = <span class="string">&quot;app/public/uploads&quot;</span>;</span><br><span class="line">  <span class="comment">// 生成文件名 =&gt; 17236452353.jpg</span></span><br><span class="line">  <span class="keyword">const</span> filename = <span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span><span class="subst">$&#123;<span class="built_in">Number</span>.<span class="built_in">parseInt</span>(<span class="built_in">Math</span>.random() * <span class="number">1000</span>)&#125;</span><span class="subst">$&#123;path</span></span></span><br><span class="line"><span class="subst"><span class="string">    .extname(stream.filename)</span></span></span><br><span class="line"><span class="subst"><span class="string">    .toLocaleLowerCase()&#125;</span>`</span>;</span><br><span class="line">  <span class="comment">// 目录名 =&gt; 2024/12/13</span></span><br><span class="line">  <span class="keyword">const</span> dirname = <span class="title function_">dayjs</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>()).<span class="title function_">format</span>(<span class="string">&quot;YYYY/MM/DD&quot;</span>);</span><br><span class="line">  <span class="comment">// 目录名 =&gt; 2024-12-13</span></span><br><span class="line">  <span class="comment">// dirname = dirname.replace(/\//g, &#x27;-&#x27;)</span></span><br><span class="line">  <span class="comment">// 创建目录的方法</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">mkdirsSync</span>(<span class="params">dirname</span>) &#123;</span><br><span class="line">    <span class="comment">// 判断目录名是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (fs.<span class="title function_">existsSync</span>(dirname)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 递归判断</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">mkdirsSync</span>(path.<span class="title function_">dirname</span>(dirname))) &#123;</span><br><span class="line">        fs.<span class="title function_">mkdirSync</span>(dirname);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// app/public/uploads/2024/12/13</span></span><br><span class="line">  <span class="title function_">mkdirsSync</span>(path.<span class="title function_">join</span>(uploadBasePath, dirname));</span><br><span class="line">  <span class="comment">// 生成写入路径 =&gt; app/public/uploads/2024/12/13/17236452353.jpg</span></span><br><span class="line">  <span class="keyword">const</span> target = path.<span class="title function_">join</span>(uploadBasePath, dirname, filename);</span><br><span class="line">  <span class="comment">// 写入流</span></span><br><span class="line">  <span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(target);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//异步把文件流 写入</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">awaitWriteStream</span>(stream.<span class="title function_">pipe</span>(writeStream));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">//如果出现错误，关闭管道</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">sendToWormhole</span>(stream);</span><br><span class="line">    ctx.<span class="keyword">throw</span>(<span class="number">500</span>, err);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 获取端口号和主机地址</span></span><br><span class="line">  <span class="keyword">const</span> &#123; protocol, host &#125; = ctx.<span class="property">request</span>;</span><br><span class="line">  <span class="comment">// console.log(protocol, host)</span></span><br><span class="line">  <span class="comment">// 将分隔符 // \\ 替换成 /</span></span><br><span class="line">  <span class="keyword">let</span> url = path.<span class="title function_">join</span>(<span class="string">&quot;/public/uploads&quot;</span>, dirname, filename).<span class="title function_">replace</span>(<span class="regexp">/\\|\//g</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  ctx.<span class="title function_">apiSuccess</span>(&#123; url &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="创建订单和微信支付">创建订单和微信支付</h5>
<p>安装插件：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-tenpay">egg-tenpay</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-tenpay --save</span><br></pre></td></tr></table></figure>
<p>配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="attr">tenpay</span>: &#123;</span><br><span class="line">	<span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">package</span>: <span class="string">&#x27;egg-tenpay&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//config/config.default.js</span></span><br><span class="line">config.<span class="property">webUrl</span> = <span class="string">&#x27;http://127.0.0.1:7001&#x27;</span></span><br><span class="line"><span class="comment">// 微信支付配置（最好改成你自己的）</span></span><br><span class="line">config.<span class="property">tenpay</span> = &#123;</span><br><span class="line"><span class="attr">client</span>: &#123;</span><br><span class="line">  <span class="attr">appid</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">mchid</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">partnerKey</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">notify_url</span>: config.<span class="property">webUrl</span> + <span class="string">&#x27;/api/gift/notify&#x27;</span>,</span><br><span class="line">  <span class="comment">// sandbox: true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/gift.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 微信支付</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">wxpay</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx,app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> user_id = ctx.<span class="property">authUser</span>.<span class="property">id</span></span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">price</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">            <span class="attr">required</span>:<span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>:<span class="string">&quot;充值费用&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> &#123; price &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">if</span>(price &lt; <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;至少充值1元&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建订单</span></span><br><span class="line">    <span class="keyword">let</span> no = ctx.<span class="title function_">randomString</span>(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">let</span> order = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Order</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        no,</span><br><span class="line">        user_id,</span><br><span class="line">        price</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span>(!order)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;创建订单失败&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 支付</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> app.<span class="property">tenpay</span>.<span class="title function_">getAppParams</span>(&#123;</span><br><span class="line">        <span class="attr">out_trade_no</span>:no,</span><br><span class="line">        <span class="attr">body</span>: <span class="string">&#x27;支付测试&#x27;</span>,</span><br><span class="line">        <span class="attr">total_fee</span>: price * <span class="number">100</span>,</span><br><span class="line">        <span class="attr">trade_type</span>: <span class="string">&quot;APP&quot;</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ctx.logger.error(&#x27;开始支付&#x27;);</span></span><br><span class="line">    <span class="comment">// ctx.logger.error(result);</span></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支付回调</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">notify</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx,app,service &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> info = ctx.<span class="property">request</span>.<span class="property">weixin</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!info || info.<span class="property">result_code</span> !== <span class="string">&#x27;SUCCESS&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">reply</span>(<span class="string">&#x27;支付失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询当前订单</span></span><br><span class="line">    <span class="keyword">let</span> order = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Order</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            <span class="attr">no</span>:info.<span class="property">out_trade_no</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!order)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">reply</span>(<span class="string">&#x27;订单不存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改订单状态</span></span><br><span class="line">    order.<span class="property">status</span> = <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    order.<span class="title function_">save</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改用户余额</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> service.<span class="property">user</span>.<span class="title function_">exist</span>(order.<span class="property">user_id</span>)</span><br><span class="line">    <span class="keyword">if</span>(user)&#123;</span><br><span class="line">        user.<span class="property">coin</span> += <span class="built_in">parseInt</span>(info.<span class="property">total_fee</span>)/<span class="number">100</span></span><br><span class="line">        user.<span class="title function_">save</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 回复消息(参数为空回复成功, 传值则为错误消息)</span></span><br><span class="line">    ctx.<span class="title function_">reply</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/gift/wxpay&quot;</span>, controller.<span class="property">api</span>.<span class="property">gift</span>.<span class="property">wxpay</span>);</span><br><span class="line">router.<span class="title function_">post</span>(</span><br><span class="line">  <span class="string">&quot;/api/gift/notify&quot;</span>,</span><br><span class="line">  app.<span class="property">middleware</span>.<span class="title function_">tenpay</span>(<span class="string">&quot;pay&quot;</span>, app),</span><br><span class="line">  controller.<span class="property">api</span>.<span class="property">gift</span>.<span class="property">notify</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="判断移动端还是pc端">判断移动端还是pc端</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展：app/extend/context.js</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">ismobile</span>(<span class="params">ctx</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> userAgent = <span class="variable language_">this</span>.<span class="property">request</span>.<span class="property">header</span>[<span class="string">&#x27;user-agent&#x27;</span>].<span class="title function_">toLowerCase</span>();</span><br><span class="line">    <span class="keyword">let</span> pat_phone = <span class="regexp">/ipad|iphone os|midp|rv:1.2.3.4|ucweb|android|windows ce|windows mobile/</span>;</span><br><span class="line">    <span class="keyword">return</span> pat_phone.<span class="title function_">test</span>(userAgent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="用户模块">用户模块</h5>
<h6 id="创建用户-2">创建用户</h6>
<p><strong>数据表迁移文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=user</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">username</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">avatar</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;头像&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">coin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>路由</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router/user.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/user/create&quot;</span>, controller.<span class="property">user</span>.<span class="property">create</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/user&quot;</span>, controller.<span class="property">user</span>.<span class="property">save</span>);</span><br></pre></td></tr></table></figure>
<p><strong>控制器</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/admin/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;创建用户&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;form&quot;</span>,</span><br><span class="line">        <span class="attr">form</span>: &#123;</span><br><span class="line">            <span class="comment">// 提交地址</span></span><br><span class="line">            <span class="attr">action</span>: <span class="string">&quot;/admin/user&quot;</span>,</span><br><span class="line">            <span class="attr">fields</span>:[&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;密码&quot;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;头像&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;avatar&quot;</span>,</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;coin&quot;</span>,</span><br><span class="line">                <span class="attr">default</span>: <span class="number">0</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 新增成功跳转路径</span></span><br><span class="line">        <span class="attr">successUrl</span>:<span class="string">&quot;/admin/user&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">save</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;用户名&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">avatar</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">coin</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password,avatar,coin &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证用户是否已经存在</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123; username &#125;</span><br><span class="line">    &#125;)) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;用户名已存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建用户</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        username,</span><br><span class="line">        password,</span><br><span class="line">        avatar,coin</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;创建用户失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="用户列表">用户列表</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> ctx.<span class="title function_">page</span>(<span class="string">&#x27;User&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;用户管理&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;table&quot;</span>,</span><br><span class="line">        <span class="attr">table</span>: &#123;</span><br><span class="line">            <span class="comment">// 按钮</span></span><br><span class="line">            <span class="attr">buttons</span>: &#123;</span><br><span class="line">                <span class="attr">add</span>: <span class="string">&quot;/admin/user/create&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 表头</span></span><br><span class="line">            <span class="attr">columns</span>: [&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;用户&#x27;</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> avatar = item.<span class="property">avatar</span> || <span class="string">&#x27;/public/assets/img/profiles/avatar-01.jpg&#x27;</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;h2 class=&quot;table-avatar&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;a class=&quot;avatar avatar-sm mr-2&quot;&gt;&lt;img class=&quot;avatar-img rounded-circle bg-light&quot; src=&quot;<span class="subst">$&#123;avatar&#125;</span>&quot;&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;a&gt;<span class="subst">$&#123;item.username&#125;</span>&lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;/h2&gt;`</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;金币&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;coin&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;时间&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&quot;操作&quot;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">                <span class="attr">action</span>:&#123;</span><br><span class="line">                    <span class="attr">edit</span>:<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">`/admin/user/edit/<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">delete</span>:<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">`/admin/user/delete/<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/user&quot;</span>, controller.<span class="property">admin</span>.<span class="property">user</span>.<span class="property">index</span>);</span><br></pre></td></tr></table></figure>
<h6 id="编辑用户">编辑用户</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">edit</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span>(!data)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> ctx.<span class="title function_">pageFail</span>(<span class="string">&#x27;该记录不存在&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data))</span><br><span class="line">    <span class="keyword">delete</span> data.<span class="property">password</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>:ctx.<span class="property">params</span>.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;修改用户&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;form&quot;</span>,</span><br><span class="line">        <span class="attr">form</span>: &#123;</span><br><span class="line">            <span class="comment">// 提交地址</span></span><br><span class="line">            <span class="attr">action</span>: <span class="string">&quot;/admin/user/&quot;</span> + ctx.<span class="property">params</span>.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">fields</span>:[&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;username&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;用户名&quot;</span>,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;密码&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;password&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;密码&quot;</span></span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;头像&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;avatar&quot;</span>,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;coin&quot;</span>,</span><br><span class="line">                <span class="attr">default</span>: <span class="number">0</span></span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 新增成功跳转路径</span></span><br><span class="line">        <span class="attr">successUrl</span>:<span class="string">&quot;/admin/user&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">            <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">username</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">avatar</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">coin</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; username,password,avatar,coin &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="comment">// 用户名是否被使用</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Op</span> = app.<span class="property">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            <span class="attr">id</span>:&#123;</span><br><span class="line">                [<span class="title class_">Op</span>.<span class="property">ne</span>]: id,</span><br><span class="line">            &#125;,</span><br><span class="line">            username</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;该用户名已存在&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当前管理员是否存在</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span>(!user)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;该记录不存在&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user.<span class="property">username</span> = username</span><br><span class="line">    user.<span class="property">avatar</span> = avatar</span><br><span class="line">    user.<span class="property">coin</span> = coin</span><br><span class="line">    <span class="keyword">if</span>(password)&#123;</span><br><span class="line">        user.<span class="property">password</span> = password</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(<span class="keyword">await</span> user.<span class="title function_">save</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/user/edit/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">user</span>.<span class="property">edit</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/admin/user/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">user</span>.<span class="property">update</span>);</span><br></pre></td></tr></table></figure>
<h6 id="删除用户">删除用户</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">delete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="title function_">toast</span>(<span class="string">&#x27;删除成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/user`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/user/delete/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">user</span>.<span class="property">delete</span>);</span><br></pre></td></tr></table></figure>
<h5 id="礼物模块">礼物模块</h5>
<h6 id="创建礼物">创建礼物</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=gift</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;gift&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">image</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;礼物图标&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">coin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;gift&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">模型：app/model/gift.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Gift</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;gift&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">image</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;礼物图标&quot;</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> ctx = app.<span class="title function_">createAnonymousContext</span>();</span><br><span class="line">        <span class="keyword">const</span> &#123; protocol, host &#125; = ctx.<span class="property">request</span>;</span><br><span class="line">        <span class="keyword">return</span> app.<span class="property">config</span>.<span class="property">webUrl</span> + <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;image&quot;</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">coin</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Gift</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">配置：config/config.<span class="property">default</span>.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">webUrl</span> = <span class="string">&quot;http://127.0.0.1:7001/&quot;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">控制器：app/controller/admin/gift.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;创建礼物&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;form&quot;</span>,</span><br><span class="line">        <span class="attr">form</span>: &#123;</span><br><span class="line">            <span class="comment">// 提交地址</span></span><br><span class="line">            <span class="attr">action</span>: <span class="string">&quot;/admin/gift&quot;</span>,</span><br><span class="line">            <span class="attr">fields</span>:[&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;礼物图标&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;image&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;coin&quot;</span>,</span><br><span class="line">                <span class="attr">default</span>: <span class="number">0</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 新增成功跳转路径</span></span><br><span class="line">        <span class="attr">successUrl</span>:<span class="string">&quot;/admin/gift&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">save</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;礼物名称&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">image</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">coin</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> &#123; name, image,coin &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建礼物</span></span><br><span class="line">    <span class="keyword">let</span> gift = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Gift</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        name,</span><br><span class="line">        image,</span><br><span class="line">        coin</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!gift) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;创建礼物失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(gift);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/gift/create&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">create</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/admin/gift&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">save</span>);</span><br></pre></td></tr></table></figure>
<h6 id="礼物列表">礼物列表</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">控制器：app/controller/admin/gift.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> ctx.<span class="title function_">page</span>(<span class="string">&#x27;Gift&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;礼物管理&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;table&quot;</span>,</span><br><span class="line">        <span class="attr">table</span>: &#123;</span><br><span class="line">            <span class="comment">// 按钮</span></span><br><span class="line">            <span class="attr">buttons</span>: &#123;</span><br><span class="line">                <span class="attr">add</span>: <span class="string">&quot;/admin/gift/create&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 表头</span></span><br><span class="line">            <span class="attr">columns</span>: [&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;礼物图标&#x27;</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;h2 class=&quot;table-avatar&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;a class=&quot;avatar avatar-sm mr-2&quot;&gt;&lt;img class=&quot;avatar-img rounded-circle bg-light&quot; src=&quot;<span class="subst">$&#123;item.image&#125;</span>&quot;&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;/h2&gt;`</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;礼物名称&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;金币&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;coin&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&quot;操作&quot;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">                <span class="attr">action</span>:&#123;</span><br><span class="line">                    <span class="attr">edit</span>:<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">`/admin/gift/edit/<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">delete</span>:<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">`/admin/gift/delete/<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/gift&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">index</span>);</span><br></pre></td></tr></table></figure>
<h6 id="修改礼物">修改礼物</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">控制器：app/controller/admin/gift.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">edit</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Gift</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span>(!data)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> ctx.<span class="title function_">pageFail</span>(<span class="string">&#x27;该记录不存在&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>:ctx.<span class="property">params</span>.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;修改礼物&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;form&quot;</span>,</span><br><span class="line">        <span class="attr">form</span>: &#123;</span><br><span class="line">            <span class="comment">// 提交地址</span></span><br><span class="line">            <span class="attr">action</span>: <span class="string">&quot;/admin/gift/&quot;</span> + ctx.<span class="property">params</span>.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">fields</span>:[&#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">placeholder</span>: <span class="string">&quot;礼物名称&quot;</span>,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;礼物图标&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;file&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;image&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">label</span>: <span class="string">&quot;金币&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&quot;coin&quot;</span>,</span><br><span class="line">                <span class="attr">default</span>: <span class="number">0</span></span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 新增成功跳转路径</span></span><br><span class="line">        <span class="attr">successUrl</span>:<span class="string">&quot;/admin/gift&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">            <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">name</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">image</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;string&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">coin</span>:&#123;</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;int&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">const</span> &#123; name,image,coin &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="comment">// 当前管理员是否存在</span></span><br><span class="line">    <span class="keyword">let</span> gift = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Gift</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123; id &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span>(!gift)&#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;该记录不存在&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gift.<span class="property">name</span> = name</span><br><span class="line">    gift.<span class="property">image</span> = image</span><br><span class="line">    gift.<span class="property">coin</span> = coin</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(<span class="keyword">await</span> gift.<span class="title function_">save</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/gift/edit/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">edit</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/admin/gift/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">update</span>);</span><br></pre></td></tr></table></figure>
<h6 id="删除礼物">删除礼物</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">控制器：app/controller/admin/gift.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">delete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Gift</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123; id &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="title function_">toast</span>(<span class="string">&#x27;删除成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/gift`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/gift/delete/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">gift</span>.<span class="property">delete</span>);</span><br></pre></td></tr></table></figure>
<h5 id="直播间模块">直播间模块</h5>
<h6 id="直播间列表">直播间列表</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=live</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;live&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">100</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间标题&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">cover</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间封面&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">look_count</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;总观看人数&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">coin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;总金币&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">key</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;唯一标识&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">status</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">1</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间状态 0未开播 1直播中 2暂停直播 3直播结束&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;live&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">模型：app/model/live.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Live</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;live&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">title</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">100</span>),</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间标题&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">cover</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间封面&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">look_count</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;总观看人数&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">coin</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;总金币&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">key</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;唯一标识&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间状态 0未开播 1直播中 2暂停直播 3直播结束&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> app.<span class="title function_">formatTime</span>(<span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;created_time&quot;</span>));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">Live</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联主播</span></span><br><span class="line">    <span class="title class_">Live</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Live</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">控制器：app/controller/admin/live.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> tabs = [&#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&quot;全部&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;/admin/live&quot;</span>,</span><br><span class="line">        <span class="attr">active</span>:<span class="literal">false</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&quot;直播中&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;?status=1&quot;</span>,</span><br><span class="line">        <span class="attr">status</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">active</span>:<span class="literal">false</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&quot;未开播&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;?status=0&quot;</span>,</span><br><span class="line">        <span class="attr">status</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">active</span>:<span class="literal">false</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&quot;直播结束&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;?status=3&quot;</span>,</span><br><span class="line">        <span class="attr">status</span>:<span class="number">3</span>,</span><br><span class="line">        <span class="attr">active</span>:<span class="literal">false</span></span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> where = (!ctx.<span class="property">query</span>.<span class="property">status</span> &amp;&amp; ctx.<span class="property">query</span>.<span class="property">status</span> != <span class="number">0</span>) ? &#123;&#125; : &#123; <span class="attr">status</span>:ctx.<span class="property">query</span>.<span class="property">status</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> ctx.<span class="title function_">page</span>(<span class="string">&#x27;Live&#x27;</span>,where,&#123;</span><br><span class="line">        <span class="attr">include</span>:[&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>:[<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    tabs = tabs.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((!ctx.<span class="property">query</span>.<span class="property">status</span> &amp;&amp; ctx.<span class="property">query</span>.<span class="property">status</span> != <span class="number">0</span> &amp;&amp; item.<span class="property">url</span> === <span class="string">&#x27;/admin/live&#x27;</span>) || item.<span class="property">status</span> == ctx.<span class="property">query</span>.<span class="property">status</span>)&#123;</span><br><span class="line">            item.<span class="property">active</span> = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;直播间管理&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;table&quot;</span>,</span><br><span class="line">        <span class="attr">table</span>: &#123;</span><br><span class="line">            tabs,</span><br><span class="line">            <span class="comment">// 表头</span></span><br><span class="line">            <span class="attr">columns</span>: [&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;直播间&#x27;</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;h2 class=&quot;table-avatar&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;a class=&quot;avatar mr-2&quot;&gt;&lt;img class=&quot;rounded&quot; src=&quot;<span class="subst">$&#123;item.cover&#125;</span>&quot;&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;a&gt;<span class="subst">$&#123;item.title&#125;</span> &lt;span&gt;创建人：ceshi&lt;/span&gt;&lt;/a&gt;	</span></span><br><span class="line"><span class="string">                    &lt;/h2&gt;</span></span><br><span class="line"><span class="string">                    `</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;观看人数&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;look_count&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;金币数&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;coin&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&quot;操作&quot;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> close = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span>(item.<span class="property">status</span> !== <span class="number">3</span>)&#123;</span><br><span class="line">                        close = <span class="string">`&lt;a @click=&quot;modal(&#x27;/admin/live/close/<span class="subst">$&#123;item.id&#125;</span>&#x27;,&#x27;是否要关闭该直播间？&#x27;)&quot; class=&quot;btn btn-sm bg-warning text-white&quot;&gt;关闭直播&lt;/a&gt;`</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;actions btn-group btn-group-sm&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;a @click=&quot;openInfo(&#x27;/admin/live/look/<span class="subst">$&#123;item.id&#125;</span>&#x27;,&#x27;观看记录&#x27;)&quot; class=&quot;btn btn-sm bg-primary text-white&quot;&gt;观看记录&lt;/a&gt;						&lt;a @click=&quot;openInfo(&#x27;/admin/live/gift/<span class="subst">$&#123;item.id&#125;</span>&#x27;,&#x27;礼物记录&#x27;)&quot; class=&quot;btn btn-sm bg-purple text-white&quot;&gt;礼物记录&lt;/a&gt;					</span></span><br><span class="line"><span class="string">                        &lt;a @click=&quot;openInfo(&#x27;/admin/live/comment/<span class="subst">$&#123;item.id&#125;</span>&#x27;,&#x27;弹幕记录&#x27;)&quot; class=&quot;btn btn-sm bg-success text-white&quot;&gt;弹幕记录&lt;/a&gt;			</span></span><br><span class="line"><span class="string">                        <span class="subst">$&#123;close&#125;</span>		</span></span><br><span class="line"><span class="string">                        &lt;a @click=&quot;del(&#x27;/admin/live/delete/<span class="subst">$&#123;item.id&#125;</span>&#x27;)&quot; class=&quot;btn btn-sm bg-danger text-white&quot;&gt;删除&lt;/a&gt;	</span></span><br><span class="line"><span class="string">                    &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    `</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/live&quot;</span>, controller.<span class="property">admin</span>.<span class="property">live</span>.<span class="property">index</span>);</span><br></pre></td></tr></table></figure>
<h6 id="直播间观看情况">直播间观看情况</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=live_user</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;live_user&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">live_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;live_user&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型：app/model/live_user.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">LiveUser</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;live_user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">live_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">LiveUser</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联用户</span></span><br><span class="line">    <span class="title class_">LiveUser</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">    <span class="comment">// 关联直播间</span></span><br><span class="line">    <span class="title class_">LiveUser</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">Live</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">LiveUser</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 观看记录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">look</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">LiveUser</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            <span class="attr">live_id</span>:id</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>:[&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>:[<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(&#123;</span><br><span class="line">        <span class="attr">ths</span>:[&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;观看时间&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">data</span>:res.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">id</span>:item.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">username</span>:item.<span class="property">user</span>.<span class="property">username</span>,</span><br><span class="line">                <span class="attr">avatar</span>:item.<span class="property">user</span>.<span class="property">avatar</span>,</span><br><span class="line">                <span class="attr">created_time</span>:app.<span class="title function_">formatTime</span>(item.<span class="property">created_time</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/live/look/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">live</span>.<span class="property">look</span>);</span><br></pre></td></tr></table></figure>
<h6 id="直播间礼物情况">直播间礼物情况</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=live_gift</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;live_gift&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">live_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">gift_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;礼物id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;gift&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;live_gift&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型：app/model/live_gift.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">LiveGift</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;live_gift&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">live_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">gift_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;礼物id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;gift&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">LiveGift</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联用户</span></span><br><span class="line">    <span class="title class_">LiveGift</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">    <span class="comment">// 关联直播间</span></span><br><span class="line">    <span class="title class_">LiveGift</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">Live</span>);</span><br><span class="line">    <span class="comment">// 关联礼物</span></span><br><span class="line">    <span class="title class_">LiveGift</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">Gift</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">LiveGift</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 礼物记录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">gift</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">LiveGift</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            <span class="attr">live_id</span>:id</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>:[&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>:[<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">Gift</span>,</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(&#123;</span><br><span class="line">        <span class="attr">ths</span>:[&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;礼物名称&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;gift_name&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;礼物图标&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;gift_image&#x27;</span>,</span><br><span class="line">            <span class="attr">type</span>:<span class="string">&quot;image&quot;</span></span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;礼物金币&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;gift_coin&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;赠送者&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;赠送时间&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">data</span>:res.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">created_time</span>:app.<span class="title function_">formatTime</span>(item.<span class="property">created_time</span>),</span><br><span class="line">                <span class="attr">gift_name</span>:item.<span class="property">gift</span>.<span class="property">name</span>,</span><br><span class="line">                <span class="attr">gift_coin</span>:item.<span class="property">gift</span>.<span class="property">coin</span>,</span><br><span class="line">                <span class="attr">gift_image</span>:item.<span class="property">gift</span>.<span class="property">image</span>,</span><br><span class="line">                <span class="attr">username</span>:item.<span class="property">user</span>.<span class="property">username</span>,</span><br><span class="line">                <span class="attr">avatar</span>:item.<span class="property">user</span>.<span class="property">avatar</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/live/gift/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">live</span>.<span class="property">gift</span>);</span><br></pre></td></tr></table></figure>
<h6 id="直播间评论情况">直播间评论情况</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=live_comment</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;live_comment&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">content</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">TEXT</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;评论内容&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">live_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;live_comment&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">模型：app/model/comment.<span class="property">js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">LiveComment</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;live_comment&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">content</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">TEXT</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;评论内容&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">live_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;直播间id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;live&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">LiveComment</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联发布人</span></span><br><span class="line">    <span class="title class_">LiveComment</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">    <span class="comment">// 关联直播间</span></span><br><span class="line">    <span class="title class_">LiveComment</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">Live</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">LiveComment</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 弹幕记录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">comment</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Comment</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            <span class="attr">live_id</span>:id</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>:[&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>:[<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(&#123;</span><br><span class="line">        <span class="attr">ths</span>:[&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;内容&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;content&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;发送人&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;发送时间&#x27;</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">data</span>:res.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">content</span>:item.<span class="property">content</span>,</span><br><span class="line">                <span class="attr">created_time</span>:app.<span class="title function_">formatTime</span>(item.<span class="property">created_time</span>),</span><br><span class="line">                <span class="attr">username</span>:item.<span class="property">user</span>.<span class="property">username</span>,</span><br><span class="line">                <span class="attr">avatar</span>:item.<span class="property">user</span>.<span class="property">avatar</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/live/comment/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">live</span>.<span class="property">comment</span>);</span><br></pre></td></tr></table></figure>
<h6 id="关闭直播间">关闭直播间</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">close</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> live = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!live) &#123;</span><br><span class="line">        ctx.<span class="title function_">toast</span>(<span class="string">&#x27;该直播间不存在&#x27;</span>,<span class="string">&#x27;danger&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(live.<span class="property">status</span> === <span class="number">3</span>) &#123;</span><br><span class="line">        ctx.<span class="title function_">toast</span>(<span class="string">&#x27;该直播间已结束&#x27;</span>,<span class="string">&#x27;danger&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        live.<span class="property">status</span> = <span class="number">3</span></span><br><span class="line">        <span class="keyword">await</span> live.<span class="title function_">save</span>()</span><br><span class="line">        ctx.<span class="title function_">toast</span>(<span class="string">&#x27;关闭成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/live`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/live/close/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">live</span>.<span class="property">close</span>);</span><br></pre></td></tr></table></figure>
<h5 id="订单模块">订单模块</h5>
<h6 id="订单列表">订单列表</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=order</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">createTable</span>(<span class="string">&quot;order&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">        <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">no</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">100</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;订单号&quot;</span>,</span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">        <span class="attr">references</span>: &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">        <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">price</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;价格&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">status</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">ENUM</span>,</span><br><span class="line">        <span class="attr">values</span>: [<span class="string">&quot;pending&quot;</span>, <span class="string">&quot;success&quot;</span>, <span class="string">&quot;fail&quot;</span>],</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="string">&quot;pending&quot;</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&quot;支付状态&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型：app/model/order.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span>, <span class="variable constant_">TEXT</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Order</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;order&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>),</span><br><span class="line">      <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">no</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">100</span>),</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;订单号&quot;</span>,</span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;用户id&quot;</span>,</span><br><span class="line">      <span class="attr">references</span>: &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">      <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">price</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;价格&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">ENUM</span>,</span><br><span class="line">      <span class="attr">values</span>: [<span class="string">&quot;pending&quot;</span>, <span class="string">&quot;success&quot;</span>, <span class="string">&quot;fail&quot;</span>],</span><br><span class="line">      <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">defaultValue</span>: <span class="string">&quot;pending&quot;</span>,</span><br><span class="line">      <span class="attr">comment</span>: <span class="string">&quot;支付状态&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">Order</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联主播</span></span><br><span class="line">    <span class="title class_">Order</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Order</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/order.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> ctx.<span class="title function_">page</span>(<span class="string">&#x27;Order&#x27;</span>,&#123;&#125;,&#123;</span><br><span class="line">        <span class="attr">include</span>:[&#123;</span><br><span class="line">            <span class="attr">model</span>:app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>:[<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data))</span><br><span class="line"></span><br><span class="line">    data = data.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">        item.<span class="property">username</span> = item.<span class="property">user</span>.<span class="property">username</span></span><br><span class="line">        item.<span class="property">avatar</span> = item.<span class="property">user</span>.<span class="property">avatar</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">renderTemplate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;用户管理&quot;</span>,</span><br><span class="line">        <span class="attr">tempType</span>: <span class="string">&quot;table&quot;</span>,</span><br><span class="line">        <span class="attr">table</span>: &#123;</span><br><span class="line">            <span class="comment">// 表头</span></span><br><span class="line">            <span class="attr">columns</span>: [&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">60</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;订单号&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;no&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;用户&#x27;</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">let</span> avatar = item.<span class="property">avatar</span> || <span class="string">&#x27;/public/assets/img/profiles/avatar-01.jpg&#x27;</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;h2 class=&quot;table-avatar&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;a class=&quot;avatar avatar-sm mr-2&quot;&gt;&lt;img class=&quot;avatar-img rounded-circle bg-light&quot; src=&quot;<span class="subst">$&#123;avatar&#125;</span>&quot;&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">                        &lt;a&gt;<span class="subst">$&#123;item.username&#125;</span>&lt;/a&gt;</span></span><br><span class="line"><span class="string">                    &lt;/h2&gt;`</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;价格&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;price&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;订单状态&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">                <span class="title function_">render</span>(<span class="params">item</span>) &#123;</span><br><span class="line">                    <span class="keyword">const</span> o = &#123;</span><br><span class="line">                        <span class="attr">pending</span>:&#123;</span><br><span class="line">                            <span class="attr">text</span>:<span class="string">&quot;未支付&quot;</span>,</span><br><span class="line">                            <span class="attr">color</span>:<span class="string">&quot;warning&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">success</span>:&#123;</span><br><span class="line">                            <span class="attr">text</span>:<span class="string">&quot;支付成功&quot;</span>,</span><br><span class="line">                            <span class="attr">color</span>:<span class="string">&quot;success&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">fail</span>:&#123;</span><br><span class="line">                            <span class="attr">text</span>:<span class="string">&quot;支付失败&quot;</span>,</span><br><span class="line">                            <span class="attr">color</span>:<span class="string">&quot;danger&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">let</span> v = o[item.<span class="property">status</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">`</span></span><br><span class="line"><span class="string">                    &lt;span class=&quot;badge badge-<span class="subst">$&#123;v.color&#125;</span>&quot;&gt;<span class="subst">$&#123;v.text&#125;</span>&lt;/span&gt;</span></span><br><span class="line"><span class="string">                    `</span></span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">                <span class="attr">key</span>: <span class="string">&#x27;created_time&#x27;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">180</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line">            &#125;, &#123;</span><br><span class="line">                <span class="attr">title</span>: <span class="string">&quot;操作&quot;</span>,</span><br><span class="line">                <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">                <span class="attr">fixed</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">                <span class="attr">action</span>:&#123;</span><br><span class="line">                    <span class="attr">delete</span>:<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">`/admin/order/delete/<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;],</span><br><span class="line">            data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">路由：app/router.<span class="property">js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/order&quot;</span>, controller.<span class="property">admin</span>.<span class="property">order</span>.<span class="property">index</span>);</span><br></pre></td></tr></table></figure>
<h6 id="删除订单">删除订单</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/admin/order.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">delete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Order</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>:&#123;</span><br><span class="line">            id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx.<span class="title function_">toast</span>(<span class="string">&#x27;删除成功&#x27;</span>,<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">redirect</span>(<span class="string">`/admin/order`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/admin/order/delete/:id&quot;</span>, controller.<span class="property">admin</span>.<span class="property">order</span>.<span class="property">delete</span>);</span><br></pre></td></tr></table></figure>
<h5 id="Api开发-用户模块">Api开发-用户模块</h5>
<h6 id="用户注册">用户注册</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入模块</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">reg</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">range</span>: &#123;</span><br><span class="line">                <span class="attr">min</span>: <span class="number">5</span>,</span><br><span class="line">                <span class="attr">max</span>: <span class="number">20</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;用户名&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">repassword</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;确认密码&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">equals</span>: [</span><br><span class="line">            [<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;repassword&#x27;</span>]</span><br><span class="line">        ]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 验证用户是否已经存在</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            username,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;用户名已存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建用户</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        username,</span><br><span class="line">        password</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;创建用户失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户注册</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/reg&quot;</span>, controller.<span class="property">api</span>.<span class="property">user</span>.<span class="property">reg</span>);</span><br></pre></td></tr></table></figure>
<h6 id="用户登录">用户登录</h6>
<p>jwt 加密鉴权插件地址：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-jwt">https://www.npmjs.com/package/egg-jwt</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-jwt --save</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">jwt</span> = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&quot;egg-jwt&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;app_root&#125;/config/config.default.js</span></span><br><span class="line">config.<span class="property">jwt</span> = &#123;</span><br><span class="line">  <span class="attr">secret</span>: <span class="string">&quot;qhdgw@45ncashdaksh2!#@3nxjdas*_672&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>安装crypto模块</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i crypto --save</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/context.js</span></span><br><span class="line"><span class="comment">// 引入模块</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="comment">// 生成token</span></span><br><span class="line"><span class="title function_">getToken</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">jwt</span>.<span class="title function_">sign</span>(value, <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">config</span>.<span class="property">jwt</span>.<span class="property">secret</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 验证token</span></span><br><span class="line"><span class="title function_">checkToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">jwt</span>.<span class="title function_">verify</span>(token, <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">config</span>.<span class="property">jwt</span>.<span class="property">secret</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 验证密码</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">checkPassword</span>(<span class="params">password, hash_password</span>) &#123;</span><br><span class="line">	<span class="comment">// 先对需要验证的密码进行加密</span></span><br><span class="line">	<span class="keyword">const</span> hmac = crypto.<span class="title function_">createHash</span>(<span class="string">&quot;sha256&quot;</span>, <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">config</span>.<span class="property">crypto</span>.<span class="property">secret</span>);</span><br><span class="line">	hmac.<span class="title function_">update</span>(password);</span><br><span class="line">	password = hmac.<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">	<span class="keyword">let</span> res = password === hash_password;</span><br><span class="line">	<span class="keyword">if</span> (!res) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;密码错误&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>redis 缓存插件和封装 安装</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-redis --save</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">redis</span> = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&quot;egg-redis&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// redis存储</span></span><br><span class="line">config.<span class="property">redis</span> = &#123;</span><br><span class="line">  <span class="attr">client</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">6379</span>, <span class="comment">// Redis port</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>, <span class="comment">// Redis host</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">db</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>缓存库封装</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/service/cache.js</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Service</span> = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>).<span class="property">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheService</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Service</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取列表</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">boolean</span>&#125; isChildObject 元素是否为对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> array </span>&#125; 返回数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getList</span>(<span class="params">key, isChildObject = <span class="literal">false</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> redis.<span class="title function_">lrange</span>(key, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (isChildObject) &#123;</span><br><span class="line">      data = data.<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(item);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置列表</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">object|string</span>&#125; value 值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; type 类型：push和unshift</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; expir 过期时间 单位秒</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> Number </span>&#125; 返回索引</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setList</span>(<span class="params">key, value, type = <span class="string">&quot;push&quot;</span>, expir = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">if</span> (expir &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> redis.<span class="title function_">expire</span>(key, expir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">      value = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">&quot;push&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">rpush</span>(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">lpush</span>(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置 redis 缓存</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> String </span>&#125; key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String | Object | array</span>&#125; value 值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> Number </span>&#125; expir 过期时间 单位秒</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> String </span>&#125; 返回成功字符串OK</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">set</span>(<span class="params">key, value, expir = <span class="number">0</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">if</span> (expir === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">set</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(value));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">set</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(value), <span class="string">&quot;EX&quot;</span>, expir);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取 redis 缓存</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> String </span>&#125; key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> String | array | Object </span>&#125; 返回获取的数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">get</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> redis.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * redis 自增</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> String </span>&#125; key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> Number </span>&#125; value 自增的值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> Number </span>&#125; 返回递增值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">incr</span>(<span class="params">key, number = <span class="number">1</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">if</span> (number === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">incr</span>(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">incrby</span>(key, number);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询长度</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type"> String </span>&#125; <span class="variable">key</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type"> Number </span>&#125; 返回数据长度</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">strlen</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">strlen</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 删除指定key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; <span class="variable">key</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="variable language_">this</span>.<span class="property">app</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> redis.<span class="title function_">del</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 清空缓存</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">clear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">redis</span>.<span class="title function_">flushall</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">CacheService</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;用户名&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> &#123; username, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="comment">// 验证该用户是否存在|验证该用户状态是否启用</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            username,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;用户不存在或已被禁用&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 验证密码</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">checkPassword</span>(password, user.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">    user = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user));</span><br><span class="line">    <span class="comment">// 生成token</span></span><br><span class="line">    <span class="keyword">let</span> token = ctx.<span class="title function_">getToken</span>(user);</span><br><span class="line">    user.<span class="property">token</span> = token;</span><br><span class="line">    <span class="keyword">delete</span> user.<span class="property">password</span>;</span><br><span class="line">    <span class="comment">// 加入缓存中</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">service</span>.<span class="property">cache</span>.<span class="title function_">set</span>(<span class="string">&#x27;user_&#x27;</span> + user.<span class="property">id</span>, token)) &#123;</span><br><span class="line">        ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;登录失败&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回用户信息和token</span></span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="title function_">apiSuccess</span>(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/login&quot;</span>, controller.<span class="property">api</span>.<span class="property">user</span>.<span class="property">login</span>);</span><br></pre></td></tr></table></figure>
<h6 id="权限验证中间件">权限验证中间件</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中间件：app/middleware/auth.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">//1. 获取 header 头token</span></span><br><span class="line">    <span class="keyword">let</span> token = ctx.<span class="property">header</span>.<span class="property">token</span> || ctx.<span class="property">query</span>.<span class="property">token</span>;</span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&quot;您没有权限访问该接口!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. 根据token解密，换取用户信息</span></span><br><span class="line">    <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      user = ctx.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">let</span> fail = error.<span class="property">name</span> === <span class="string">&quot;TokenExpiredError&quot;</span></span><br><span class="line">        ? <span class="string">&quot;token 已过期! 请重新获取令牌&quot;</span></span><br><span class="line">        : <span class="string">&quot;Token 令牌不合法!&quot;</span>;</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>, fail);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. 判断当前用户是否登录</span></span><br><span class="line">    <span class="keyword">let</span> t = <span class="keyword">await</span> ctx.<span class="property">service</span>.<span class="property">cache</span>.<span class="title function_">get</span>(<span class="string">&quot;user_&quot;</span> + user.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (!t || t !== token) &#123;</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&quot;Token 令牌不合法!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 获取当前用户，验证当前用户是否被禁用</span></span><br><span class="line">    user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(user.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&quot;用户不存在或已被禁用&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5. 把 user 信息挂载到全局ctx上</span></span><br><span class="line">    ctx.<span class="property">authUser</span> = user;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置：config/config.default.js</span></span><br><span class="line"></span><br><span class="line">config.<span class="property">middleware</span> = [</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="string">&quot;auth&quot;</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">];</span><br><span class="line">config.<span class="property">auth</span> = &#123;</span><br><span class="line">  <span class="attr">match</span>: [</span><br><span class="line">    <span class="string">&quot;/api/logout&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api/live/create&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api/live/changestatus&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api/gift/wxpay&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/api/user/info&quot;</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="退出登录-2">退出登录</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 退出登录</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; ctx, service &#125; = <span class="variable language_">this</span>;</span><br><span class="line">   <span class="comment">// 拿到当前用户id</span></span><br><span class="line">   <span class="keyword">let</span> current_user_id = ctx.<span class="property">authUser</span>.<span class="property">id</span>;</span><br><span class="line">   <span class="comment">// 移除redis当前用户信息</span></span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">await</span> service.<span class="property">cache</span>.<span class="title function_">remove</span>(<span class="string">&#x27;user_&#x27;</span> + current_user_id)) &#123;</span><br><span class="line">       ctx.<span class="keyword">throw</span>(<span class="number">400</span>, <span class="string">&#x27;退出登录失败&#x27;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   ctx.<span class="title function_">apiSuccess</span>(<span class="string">&#x27;退出成功&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 退出登录</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/logout&quot;</span>, controller.<span class="property">api</span>.<span class="property">user</span>.<span class="property">logout</span>);</span><br></pre></td></tr></table></figure>
<h6 id="获取当前用户的信息">获取当前用户的信息</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前用户信息</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">info</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> &#123; ctx, service, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">   <span class="keyword">let</span> user = ctx.<span class="property">authUser</span></span><br><span class="line">   <span class="keyword">return</span> ctx.<span class="title function_">apiSuccess</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/user/info&quot;</span>, controller.<span class="property">api</span>.<span class="property">user</span>.<span class="property">info</span>);</span><br></pre></td></tr></table></figure>
<h5 id="Api开发-直播间模块">Api开发-直播间模块</h5>
<h6 id="创建直播间">创建直播间</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入模块</span></span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">&#x27;md5&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建直播间</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">save</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> user_id = ctx.<span class="property">authUser</span>.<span class="property">id</span>;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;直播间标题&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">cover</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;直播间封面&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123;</span><br><span class="line">        title, cover</span><br><span class="line">    &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成唯一key</span></span><br><span class="line">    <span class="keyword">let</span> key = ctx.<span class="title function_">randomString</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 直接创建</span></span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        title,</span><br><span class="line">        cover,</span><br><span class="line">        user_id,</span><br><span class="line">        key,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成签名</span></span><br><span class="line">    <span class="keyword">let</span> sign = <span class="variable language_">this</span>.<span class="title function_">sign</span>(key)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(&#123;</span><br><span class="line">        <span class="attr">data</span>: res,</span><br><span class="line">        sign</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成签名</span></span><br><span class="line"><span class="title function_">sign</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> secret = app.<span class="property">config</span>.<span class="property">mediaServer</span>.<span class="property">auth</span>.<span class="property">secret</span></span><br><span class="line">    <span class="keyword">const</span> expire = <span class="built_in">parseInt</span>((<span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">100000000</span>) / <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">const</span> hashValue = <span class="title function_">md5</span>(<span class="string">`/live/<span class="subst">$&#123;key&#125;</span>-<span class="subst">$&#123;expire&#125;</span>-<span class="subst">$&#123;secret&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;expire&#125;</span>-<span class="subst">$&#123;hashValue&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展：app/extend/context.js</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">randomString</span>(<span class="params">length</span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> chars = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">   <span class="keyword">var</span> result = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = length; i &gt; <span class="number">0</span>; --i) result += chars[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * chars.<span class="property">length</span>)];</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建直播间</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/live/create&quot;</span>, controller.<span class="property">api</span>.<span class="property">live</span>.<span class="property">save</span>);</span><br></pre></td></tr></table></figure>
<h6 id="修改直播间状态">修改直播间状态</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器:app/controller/api/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改直播间状态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">changestatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">let</span> user_id = ctx.<span class="property">authUser</span>.<span class="property">id</span>;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&#x27;直播间ID&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">type</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">range</span>: &#123;</span><br><span class="line">                <span class="attr">in</span>: [<span class="string">&#x27;play&#x27;</span>, <span class="string">&#x27;pause&#x27;</span>, <span class="string">&#x27;stop&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">let</span> &#123; id, type &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> live = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            id,</span><br><span class="line">            user_id</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!live) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;该直播间不存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (live.<span class="property">status</span> === <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;该直播间已结束&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = &#123;</span><br><span class="line">        <span class="attr">play</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">pause</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">stop</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    live.<span class="property">status</span> = status[type]</span><br><span class="line">    <span class="keyword">await</span> live.<span class="title function_">save</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="title function_">apiSuccess</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改直播间状态</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/api/live/changestatus&quot;</span>, controller.<span class="property">api</span>.<span class="property">live</span>.<span class="property">changestatus</span>);</span><br></pre></td></tr></table></figure>
<h6 id="直播间列表-2">直播间列表</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 直播间列表</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">let</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">   ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">       <span class="attr">page</span>: &#123;</span><br><span class="line">           <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">           <span class="attr">desc</span>: <span class="string">&quot;页码&quot;</span>,</span><br><span class="line">           <span class="attr">type</span>: <span class="string">&quot;int&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">let</span> rows = <span class="keyword">await</span> ctx.<span class="title function_">page</span>(<span class="string">&#x27;Live&#x27;</span>);</span><br><span class="line">   ctx.<span class="title function_">apiSuccess</span>(rows);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 直播间列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/live/list/:page&quot;</span>, controller.<span class="property">api</span>.<span class="property">live</span>.<span class="property">list</span>);</span><br></pre></td></tr></table></figure>
<h6 id="查看指定直播间">查看指定直播间</h6>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 控制器：app/controller/api/live.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看指定直播间</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">read</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 参数验证</span></span><br><span class="line">    ctx.<span class="title function_">validate</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">            <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">desc</span>: <span class="string">&quot;直播间ID&quot;</span>,</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&quot;int&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">params</span>.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> live = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            id,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="attr">model</span>: app.<span class="property">model</span>.<span class="property">User</span>,</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;avatar&#x27;</span>]</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!live) &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="title function_">apiFail</span>(<span class="string">&#x27;当前直播间不存在&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成签名</span></span><br><span class="line">    <span class="keyword">let</span> sign = <span class="variable language_">this</span>.<span class="title function_">sign</span>(live.<span class="property">key</span>);</span><br><span class="line"></span><br><span class="line">    live = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(live))</span><br><span class="line"></span><br><span class="line">    ctx.<span class="title function_">apiSuccess</span>(&#123;</span><br><span class="line">        <span class="attr">data</span>: live,</span><br><span class="line">        sign</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由：app/router.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看直播间</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/api/live/read/:id&quot;</span>, controller.<span class="property">api</span>.<span class="property">live</span>.<span class="property">read</span>);</span><br></pre></td></tr></table></figure>
<h6 id="搭建直播服务器">搭建直播服务器</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install node-media-server --save</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://github.com/illuspas/Node-Media-Server/blob/master/README_CN.md">https://github.com/illuspas/Node-Media-Server/blob/master/README_CN.md</a></p>
</blockquote>
<p><strong>配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 流媒体配置</span></span><br><span class="line">config.<span class="property">mediaServer</span> = &#123;</span><br><span class="line">  <span class="attr">rtmp</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">23480</span>,</span><br><span class="line">    <span class="attr">chunk_size</span>: <span class="number">60000</span>,</span><br><span class="line">    <span class="attr">gop_cache</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">ping</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">ping_timeout</span>: <span class="number">60</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">http</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">23481</span>,</span><br><span class="line">    <span class="attr">allow_origin</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">auth</span>: &#123;</span><br><span class="line">    <span class="attr">play</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">publish</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">secret</span>: <span class="string">&quot;nodemedia2017privatekey&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动流媒体服务：app.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">// 引入</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">NodeMediaServer</span> = <span class="built_in">require</span>(<span class="string">&quot;node-media-server&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppBootHook</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">app</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">app</span> = app;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">configWillLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 此时 config 文件已经被读取并合并，但是还并未生效</span></span><br><span class="line">    <span class="comment">// 这是应用层修改配置的最后时机</span></span><br><span class="line">    <span class="comment">// 注意：此函数只支持同步调用</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">didLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 所有的配置已经加载完毕</span></span><br><span class="line">    <span class="comment">// 可以用来加载应用自定义的文件，启动自定义的服务</span></span><br><span class="line">    <span class="comment">// 启动流媒体服务</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span> = <span class="keyword">new</span> <span class="title class_">NodeMediaServer</span>(<span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">config</span>.<span class="property">mediaServer</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">run</span>();</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;preConnect&quot;</span>, <span class="function">(<span class="params">id, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on preConnect]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// let session = nms.getSession(id);</span></span><br><span class="line">        <span class="comment">// session.reject();</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;postConnect&quot;</span>, <span class="function">(<span class="params">id, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on postConnect]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;doneConnect&quot;</span>, <span class="function">(<span class="params">id, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on doneConnect]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;prePublish&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on prePublish]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// let session = nms.getSession(id);</span></span><br><span class="line">        <span class="comment">// session.reject();</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;postPublish&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on postPublish]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;donePublish&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on donePublish]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;prePlay&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on prePlay]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// let session = nms.getSession(id);</span></span><br><span class="line">        <span class="comment">// session.reject();</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;postPlay&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on postPlay]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">nms</span>.<span class="title function_">on</span>(<span class="string">&quot;donePlay&quot;</span>, <span class="function">(<span class="params">id, StreamPath, args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;[NodeEvent on donePlay]&quot;</span>,</span><br><span class="line">          <span class="string">`id=<span class="subst">$&#123;id&#125;</span> StreamPath=<span class="subst">$&#123;StreamPath&#125;</span> args=<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(args)&#125;</span>`</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">willReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 所有的插件都已启动完毕，但是应用整体还未 ready</span></span><br><span class="line">    <span class="comment">// 可以做一些数据初始化等操作，这些操作成功才会启动应用</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">didReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 应用已经启动完毕</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">serverDidReady</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// http / https server 已启动，开始接受外部请求</span></span><br><span class="line">    <span class="comment">// 此时可以从 app.server 拿到 server 的实例</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// this.app.server.on(&#x27;timeout&#x27;, socket =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     // handle socket timeout</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">AppBootHook</span>;</span><br></pre></td></tr></table></figure>
<h6 id="socket-io安装和通讯">socket.io安装和通讯</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-socket.io --save</span><br></pre></td></tr></table></figure>
<blockquote>
<p>文档地址：<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/tutorials/socketio.html">https://eggjs.org/zh-cn/tutorials/socketio.html</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="attr">io</span>: &#123;</span><br><span class="line">	<span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="attr">package</span>: <span class="string">&#x27;egg-socket.io&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">config.<span class="property">io</span> = &#123;</span><br><span class="line">    <span class="attr">init</span>: &#123;</span><br><span class="line">      <span class="attr">wsEngine</span>: <span class="string">&#x27;ws&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">namespace</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">connectionMiddleware</span>: [</span><br><span class="line">          <span class="string">&#x27;auth&#x27;</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">packetMiddleware</span>: [],</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">redis</span>: &#123;</span><br><span class="line">      <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">      <span class="attr">port</span>: <span class="number">6379</span>,</span><br><span class="line">	  <span class="attr">db</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><strong>部署: package.json</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;egg-bin dev --sticky&quot;</span>,</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;egg-scripts start --sticky&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Nginx 配置</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  proxy_set_header <span class="title class_">Upgrade</span> $http_upgrade;</span><br><span class="line">  proxy_set_header <span class="title class_">Connection</span> <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">  proxy_set_header X-<span class="title class_">Forwarded</span>-<span class="title class_">For</span> $proxy_add_x_forwarded_for;</span><br><span class="line">  proxy_set_header <span class="title class_">Host</span> $host;</span><br><span class="line">  proxy_pass   <span class="attr">http</span>:<span class="comment">//127.0.0.1:7001;</span></span><br><span class="line"></span><br><span class="line">  # <span class="attr">http</span>:<span class="comment">//nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind</span></span><br><span class="line">  # proxy_bind       $remote_addr transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket.io插件控制器：app/io/controller/nsp.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>).<span class="property">Controller</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PREFIX</span> = <span class="string">&quot;room&quot;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NspController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">checkToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app, service, helper &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> nsp = app.<span class="property">io</span>.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> socket = ctx.<span class="property">socket</span>;</span><br><span class="line">    <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户验证</span></span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;您没有权限访问该接口!&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2. 根据token解密，换取用户信息</span></span><br><span class="line">    <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      user = ctx.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">let</span> fail = error.<span class="property">name</span> === <span class="string">&quot;TokenExpiredError&quot;</span></span><br><span class="line">        ? <span class="string">&quot;token 已过期! 请重新获取令牌&quot;</span></span><br><span class="line">        : <span class="string">&quot;Token 令牌不合法!&quot;</span>;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, fail));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3. 判断当前用户是否登录</span></span><br><span class="line">    <span class="keyword">let</span> t = <span class="keyword">await</span> ctx.<span class="property">service</span>.<span class="property">cache</span>.<span class="title function_">get</span>(<span class="string">&quot;user_&quot;</span> + user.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (!t || t !== token) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;Token 令牌不合法!&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 获取当前用户，验证当前用户是否被禁用</span></span><br><span class="line">    user = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(user.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;用户不存在或已被禁用&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 直播间发送消息</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">comment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app, service, helper &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> nsp = app.<span class="property">io</span>.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> message = ctx.<span class="property">args</span>[<span class="number">0</span>] || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> socket = ctx.<span class="property">socket</span>;</span><br><span class="line">    <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; live_id, data, token &#125; = message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 验证当前直播间是否存在且是否处于开播中</span></span><br><span class="line">      <span class="keyword">let</span> msg = <span class="keyword">await</span> service.<span class="property">live</span>.<span class="title function_">checkStatus</span>(live_id);</span><br><span class="line">      <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">        socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, msg));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> room = <span class="string">&quot;live_&quot;</span> + live_id;</span><br><span class="line">      <span class="comment">// 推送消息到直播间</span></span><br><span class="line">      nsp.<span class="title function_">to</span>(room).<span class="title function_">emit</span>(<span class="string">&quot;comment&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">user</span>: &#123;</span><br><span class="line">          <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">name</span>: user.<span class="property">nickname</span> || user.<span class="property">username</span>,</span><br><span class="line">          <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">content</span>: data,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      app.<span class="property">model</span>.<span class="property">Comment</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        <span class="attr">content</span>: data,</span><br><span class="line">        live_id,</span><br><span class="line">        <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      app.<span class="property">logger</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 进入直播间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">joinLive</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app, service, helper &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> nsp = app.<span class="property">io</span>.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> message = ctx.<span class="property">args</span>[<span class="number">0</span>] || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> socket = ctx.<span class="property">socket</span>;</span><br><span class="line">    <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; live_id, token &#125; = message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证当前直播间是否存在且是否处于开播中</span></span><br><span class="line">    <span class="keyword">let</span> msg = <span class="keyword">await</span> service.<span class="property">live</span>.<span class="title function_">checkStatus</span>(live_id);</span><br><span class="line">    <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, msg));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> room = <span class="string">&quot;live_&quot;</span> + live_id;</span><br><span class="line">    <span class="comment">// 用户加入</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;#join&quot;</span>, room);</span><br><span class="line">    socket.<span class="title function_">join</span>(room);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rooms = [room];</span><br><span class="line">    <span class="comment">// 在线列表</span></span><br><span class="line">    <span class="comment">// nsp.adapter.clients(rooms, (err, clients) =&gt; &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(&#x27;#online_join&#x27;, clients);</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入存储中</span></span><br><span class="line">    <span class="keyword">let</span> list = <span class="keyword">await</span> service.<span class="property">cache</span>.<span class="title function_">get</span>(<span class="string">&quot;userList_&quot;</span> + room);</span><br><span class="line">    list = list ? list : [];</span><br><span class="line">    list = list.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">id</span> !== user.<span class="property">id</span>);</span><br><span class="line">    list.<span class="title function_">unshift</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">name</span>: user.<span class="property">nickname</span> || user.<span class="property">username</span>,</span><br><span class="line">      <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    service.<span class="property">cache</span>.<span class="title function_">set</span>(<span class="string">&quot;userList_&quot;</span> + room, list);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新在线用户列表</span></span><br><span class="line">    nsp.<span class="property">adapter</span>.<span class="title function_">clients</span>(rooms, <span class="function">(<span class="params">err, clients</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;#online_join&quot;</span>, clients);</span><br><span class="line">      nsp.<span class="title function_">to</span>(room).<span class="title function_">emit</span>(<span class="string">&quot;online&quot;</span>, &#123;</span><br><span class="line">        clients,</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;join&quot;</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;</span><br><span class="line">          <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">name</span>: user.<span class="property">nickname</span> || user.<span class="property">username</span>,</span><br><span class="line">          <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">data</span>: list,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入播放历史记录</span></span><br><span class="line">    <span class="keyword">let</span> liveUser = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">LiveUser</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">        live_id,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!liveUser) &#123;</span><br><span class="line">      app.<span class="property">model</span>.<span class="property">LiveUser</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">        live_id,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 总观看人数+1</span></span><br><span class="line">      <span class="keyword">let</span> live = <span class="keyword">await</span> service.<span class="property">live</span>.<span class="title function_">exist</span>(live_id);</span><br><span class="line">      live.<span class="title function_">increment</span>(&#123;</span><br><span class="line">        <span class="attr">look_count</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 离开直播间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">leaveLive</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app, service, helper &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> nsp = app.<span class="property">io</span>.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> message = ctx.<span class="property">args</span>[<span class="number">0</span>] || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> socket = ctx.<span class="property">socket</span>;</span><br><span class="line">    <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; live_id, token &#125; = message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证当前直播间是否存在且是否处于开播中</span></span><br><span class="line">    <span class="keyword">let</span> msg = <span class="keyword">await</span> service.<span class="property">live</span>.<span class="title function_">checkStatus</span>(live_id);</span><br><span class="line">    <span class="keyword">if</span> (msg) &#123;</span><br><span class="line">      socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, msg));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> room = <span class="string">&quot;live_&quot;</span> + live_id;</span><br><span class="line">    <span class="comment">// 用户离开</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;#leave&quot;</span>, room);</span><br><span class="line">    socket.<span class="title function_">leave</span>(room);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rooms = [room];</span><br><span class="line">    <span class="comment">// 在线列表</span></span><br><span class="line">    nsp.<span class="property">adapter</span>.<span class="title function_">clients</span>(rooms, <span class="function">(<span class="params">err, clients</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;#online_join&quot;</span>, clients);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 更新在线用户列表</span></span><br><span class="line">      nsp.<span class="title function_">to</span>(room).<span class="title function_">emit</span>(<span class="string">&quot;online&quot;</span>, &#123;</span><br><span class="line">        clients,</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&quot;leave&quot;</span>,</span><br><span class="line">        <span class="attr">user</span>: &#123;</span><br><span class="line">          <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">          <span class="attr">name</span>: user.<span class="property">nickname</span> || user.<span class="property">username</span>,</span><br><span class="line">          <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> list = <span class="keyword">await</span> service.<span class="property">cache</span>.<span class="title function_">get</span>(<span class="string">&quot;userList_&quot;</span> + room);</span><br><span class="line">    <span class="keyword">if</span> (list) &#123;</span><br><span class="line">      list = list.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> item.<span class="property">id</span> !== user.<span class="property">id</span>);</span><br><span class="line">      service.<span class="property">cache</span>.<span class="title function_">set</span>(<span class="string">&quot;userList_&quot;</span> + room, list);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直播间送礼物</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">gift</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app, service, helper &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">const</span> nsp = app.<span class="property">io</span>.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> message = ctx.<span class="property">args</span>[<span class="number">0</span>] || &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> socket = ctx.<span class="property">socket</span>;</span><br><span class="line">    <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; live_id, gift_id, token &#125; = message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">checkToken</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 验证当前直播间是否存在且是否处于开播中</span></span><br><span class="line">      <span class="keyword">let</span> live = <span class="keyword">await</span> service.<span class="property">live</span>.<span class="title function_">checkStatus</span>(live_id, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> live === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, live));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 验证礼物是否存在</span></span><br><span class="line">      <span class="keyword">let</span> gift = <span class="keyword">await</span> app.<span class="property">model</span>.<span class="property">Gift</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123; <span class="attr">id</span>: gift_id &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (!gift) &#123;</span><br><span class="line">        socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;该礼物不存在&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 金币不足</span></span><br><span class="line">      <span class="keyword">if</span> (user.<span class="property">coin</span> &lt; gift.<span class="property">coin</span>) &#123;</span><br><span class="line">        socket.<span class="title function_">emit</span>(id, ctx.<span class="property">helper</span>.<span class="title function_">parseMsg</span>(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;金币不足，请先充值&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 扣除金币</span></span><br><span class="line">      user.<span class="property">coin</span> -= gift.<span class="property">coin</span>;</span><br><span class="line">      <span class="keyword">await</span> user.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 写入礼物记录表</span></span><br><span class="line">      app.<span class="property">model</span>.<span class="property">LiveGift</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">        live_id,</span><br><span class="line">        <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">        gift_id,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 直播间增加金币数</span></span><br><span class="line">      live.<span class="property">coin</span> += gift.<span class="property">coin</span>;</span><br><span class="line">      live.<span class="title function_">save</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> room = <span class="string">&quot;live_&quot;</span> + live_id;</span><br><span class="line">      <span class="comment">// 推送消息到直播间</span></span><br><span class="line">      nsp.<span class="title function_">to</span>(room).<span class="title function_">emit</span>(<span class="string">&quot;gift&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">        <span class="attr">username</span>: user.<span class="property">nickname</span> || user.<span class="property">username</span>,</span><br><span class="line">        <span class="attr">gift_image</span>: gift.<span class="property">image</span>,</span><br><span class="line">        <span class="attr">gift_name</span>: gift.<span class="property">name</span>,</span><br><span class="line">        <span class="attr">num</span>: <span class="number">1</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      app.<span class="property">logger</span>.<span class="title function_">error</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">NspController</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/service/live.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Service</span> <span class="keyword">extends</span> <span class="title class_ inherited__">app.Service</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">checkStatus</span>(<span class="params">live_id</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;ctx&#125; = <span class="variable language_">this</span></span><br><span class="line">      <span class="keyword">let</span> live = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">findByPk</span>(live_id);</span><br><span class="line">      <span class="keyword">if</span>(live.<span class="property">status</span> == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;主播还未开播&quot;</span></span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(live.<span class="property">status</span> == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;主播离开一会儿&quot;</span></span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(live.<span class="property">status</span> == <span class="number">3</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;直播已结束&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">exist</span>(<span class="params">live_id</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;ctx&#125; = <span class="variable language_">this</span></span><br><span class="line">      <span class="keyword">let</span> live = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">Live</span>.<span class="title function_">findByPk</span>(live_id);</span><br><span class="line">      <span class="keyword">if</span>(!live)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> live</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Service</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 扩展：app/extend/helper.js</span></span><br><span class="line"><span class="title function_">parseMsg</span>(<span class="params">action, payload = &#123;&#125;, metadata = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> meta = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, &#123;</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">    &#125;, metadata);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        meta,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            action,</span><br><span class="line">            payload,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插件路由：app/router.js</span></span><br><span class="line"></span><br><span class="line">io.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>).<span class="title function_">route</span>(<span class="string">&quot;comment&quot;</span>, io.<span class="property">controller</span>.<span class="property">nsp</span>.<span class="property">comment</span>);</span><br><span class="line">io.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>).<span class="title function_">route</span>(<span class="string">&quot;joinLive&quot;</span>, io.<span class="property">controller</span>.<span class="property">nsp</span>.<span class="property">joinLive</span>);</span><br><span class="line">io.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>).<span class="title function_">route</span>(<span class="string">&quot;leaveLive&quot;</span>, io.<span class="property">controller</span>.<span class="property">nsp</span>.<span class="property">leaveLive</span>);</span><br><span class="line">io.<span class="title function_">of</span>(<span class="string">&quot;/&quot;</span>).<span class="title function_">route</span>(<span class="string">&quot;gift&quot;</span>, io.<span class="property">controller</span>.<span class="property">nsp</span>.<span class="property">gift</span>);</span><br></pre></td></tr></table></figure>
<h5 id="uniapp-登录">uniapp-登录</h5>
<p><strong>结构</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 加载中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-if</span>=<span class="string">&quot;showLoading&quot;</span> <span class="attr">class</span>=<span class="string">&quot;position-fixed top-0 bottom-0 left-0 right-0 bg-light flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;z-index: 100;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-muted font&quot;</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 350rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">style</span>=<span class="string">&quot;font-size: 50rpx;&quot;</span>&gt;</span>YOU-LOGO<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;px-3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.username&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-light px-3 mb-3 font&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入用户名&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-light px-3 mb-3 font&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入密码&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-if</span>=<span class="string">&quot;type != &#x27;login&#x27;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.repassword&quot;</span> <span class="attr">class</span>=<span class="string">&quot;bg-light px-3 mb-3 font&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入确认密码&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p-3 flex align-center justify-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-main rounded p-3 flex align-center justify-center flex-1 &quot;</span> <span class="attr">hover-class</span>=<span class="string">&quot;bg-main-hover&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-md&quot;</span>&gt;</span>&#123;&#123; type === &#x27;login&#x27;?&#x27;登 录&#x27; : &#x27;注 册&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-light-muted font p-2&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;changeType&quot;</span>&gt;</span>&#123;&#123; type === &#x27;login&#x27;?&#x27;注册账号&#x27; : &#x27;去登录&#x27; &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>:<span class="string">&quot;login&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">form</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">username</span>:<span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">password</span>:<span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">repassword</span>:<span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">showLoading</span>:<span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">changeType</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">type</span> = <span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;login&#x27;</span> ? <span class="string">&#x27;reg&#x27;</span> : <span class="string">&#x27;login&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>登录实现</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;login&quot;</span>,</span><br><span class="line">        <span class="attr">form</span>:&#123;</span><br><span class="line">            <span class="attr">username</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">password</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">repassword</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">showLoading</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> token = uni.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(!token)&#123;</span><br><span class="line">        <span class="comment">// 用户未登录</span></span><br><span class="line">        uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;请先登录&#x27;</span>,</span><br><span class="line">            <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">showLoading</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 用户已登录</span></span><br><span class="line">    uni.<span class="title function_">switchTab</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;../index/index&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">changeType</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;login&#x27;</span> ? <span class="string">&#x27;reg&#x27;</span> : <span class="string">&#x27;login&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">submit</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> msg = <span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;login&#x27;</span> ? <span class="string">&#x27;登录&#x27;</span> : <span class="string">&#x27;注册&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$H</span>.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>+ <span class="variable language_">this</span>.<span class="property">type</span>,<span class="variable language_">this</span>.<span class="property">form</span>).<span class="title function_">then</span>( <span class="function"><span class="params">res</span> =&gt;</span>&#123;</span><br><span class="line">            uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">title</span>: msg + <span class="string">&#x27;成功&#x27;</span>,</span><br><span class="line">                <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">type</span> === <span class="string">&#x27;reg&#x27;</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">changeType</span>()</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">form</span> = &#123;</span><br><span class="line">                    <span class="attr">username</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="attr">password</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="attr">repassword</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;login&#x27;</span>,res)</span><br><span class="line">                uni.<span class="title function_">switchTab</span>(&#123;</span><br><span class="line">                  <span class="attr">url</span>:<span class="string">&quot;../index/index&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>request.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import $store from &#x27;@/store/index.js&#x27;;</span></span><br><span class="line"><span class="keyword">import</span> $C <span class="keyword">from</span> <span class="string">&#x27;./config.js&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"><span class="comment">// 全局配置</span></span><br><span class="line"><span class="attr">common</span>:&#123;</span><br><span class="line">    <span class="attr">baseUrl</span>:$C.<span class="property">baseUrl</span> +<span class="string">&quot;/api&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>:<span class="string">&#x27;application/json;charset=UTF-8&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">data</span>:&#123;&#125;,</span><br><span class="line">    <span class="attr">method</span>:<span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">dataType</span>:<span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">    <span class="attr">token</span>:<span class="literal">false</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 请求 返回promise</span></span><br><span class="line"><span class="title function_">request</span>(<span class="params">options = &#123;&#125;</span>)&#123;</span><br><span class="line">    <span class="comment">// 组织参数</span></span><br><span class="line">    options.<span class="property">url</span> = <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">baseUrl</span> + options.<span class="property">url</span></span><br><span class="line">    options.<span class="property">header</span> = options.<span class="property">header</span> || <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">header</span></span><br><span class="line">    options.<span class="property">data</span> = options.<span class="property">data</span> || <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">data</span></span><br><span class="line">    options.<span class="property">method</span> = options.<span class="property">method</span> || <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">method</span></span><br><span class="line">    options.<span class="property">dataType</span> = options.<span class="property">dataType</span> || <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">dataType</span></span><br><span class="line">    options.<span class="property">token</span> = options.<span class="property">token</span> === <span class="literal">true</span> ?  <span class="literal">true</span> : <span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">token</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res,rej</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 请求之前验证...</span></span><br><span class="line">    <span class="comment">// token验证</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">token</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> token = uni.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="comment">// 二次验证</span></span><br><span class="line">        <span class="keyword">if</span> (!token &amp;&amp; options.<span class="property">noJump</span> !== <span class="literal">true</span>) &#123;</span><br><span class="line">            uni.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;请先登录&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span> &#125;);</span><br><span class="line">            <span class="comment">// token不存在时跳转</span></span><br><span class="line">            uni.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">&#x27;/pages/login/login&#x27;</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">rej</span>(<span class="string">&quot;请先登录&quot;</span>) </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 往header头中添加token</span></span><br><span class="line">        options.<span class="property">header</span>.<span class="property">token</span> = token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求中...</span></span><br><span class="line">    uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">        ...options,</span><br><span class="line">        <span class="attr">success</span>: <span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 返回原始数据</span></span><br><span class="line">            <span class="keyword">if</span>(options.<span class="property">native</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">res</span>(result)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 服务端失败</span></span><br><span class="line">            <span class="keyword">if</span>(result.<span class="property">statusCode</span> !== <span class="number">200</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span> (options.<span class="property">toast</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                        <span class="attr">title</span>: result.<span class="property">data</span>.<span class="property">data</span> || <span class="string">&#x27;服务端失败&#x27;</span>,</span><br><span class="line">                        <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// token不合法，直接退出登录</span></span><br><span class="line">                <span class="keyword">if</span>(result.<span class="property">data</span>.<span class="property">data</span> === <span class="string">&#x27;Token 令牌不合法!&#x27;</span>)&#123;</span><br><span class="line">                    <span class="comment">// 退出登录操作</span></span><br><span class="line">                    <span class="comment">// $store.dispatch(&#x27;logout&#x27;)</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">rej</span>(result.<span class="property">data</span>) </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 其他验证...</span></span><br><span class="line">            <span class="comment">// 成功</span></span><br><span class="line">            <span class="keyword">let</span> data = result.<span class="property">data</span>.<span class="property">data</span></span><br><span class="line">            <span class="title function_">res</span>(data)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">fail</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">            uni.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: error.<span class="property">errMsg</span> || <span class="string">&#x27;请求失败&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span> &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">rej</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// get请求</span></span><br><span class="line"><span class="title function_">get</span>(<span class="params">url,options = &#123;&#125;</span>)&#123;</span><br><span class="line">    options.<span class="property">url</span> = url</span><br><span class="line">    options.<span class="property">data</span> = &#123;&#125;</span><br><span class="line">    options.<span class="property">method</span> = <span class="string">&#x27;GET&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(options)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// post请求</span></span><br><span class="line"><span class="title function_">post</span>(<span class="params">url,data = &#123;&#125;,options = &#123;&#125;</span>)&#123;</span><br><span class="line">    options.<span class="property">url</span> = url</span><br><span class="line">    options.<span class="property">data</span> = data</span><br><span class="line">    options.<span class="property">method</span> = <span class="string">&#x27;POST&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(options)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// delete请求</span></span><br><span class="line"><span class="title function_">del</span>(<span class="params">url,data = &#123;&#125;,options = &#123;&#125;</span>)&#123;</span><br><span class="line">    options.<span class="property">url</span> = url</span><br><span class="line">    options.<span class="property">data</span> = data</span><br><span class="line">    options.<span class="property">method</span> = <span class="string">&#x27;DELETE&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(options)</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 上传文件</span></span><br><span class="line"><span class="title function_">upload</span>(<span class="params">url,data,onProgress = <span class="literal">false</span></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">result,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 上传</span></span><br><span class="line">    <span class="keyword">let</span> token = uni.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">        uni.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&#x27;请先登录&#x27;</span>, <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span> &#125;);</span><br><span class="line">        <span class="comment">// token不存在时跳转</span></span><br><span class="line">        <span class="keyword">return</span> uni.<span class="title function_">reLaunch</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;/pages/login/login&#x27;</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uploadTask = uni.<span class="title function_">uploadFile</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="variable language_">this</span>.<span class="property">common</span>.<span class="property">baseUrl</span> + url,</span><br><span class="line">        <span class="attr">filePath</span>:data.<span class="property">filePath</span>,</span><br><span class="line">        <span class="attr">name</span>:data.<span class="property">name</span> || <span class="string">&quot;files&quot;</span>,</span><br><span class="line">        <span class="attr">header</span>:&#123; token &#125;,</span><br><span class="line">        <span class="attr">formData</span>:data.<span class="property">formData</span> || &#123;&#125;,</span><br><span class="line">        <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(res.<span class="property">statusCode</span> !== <span class="number">200</span>)&#123;</span><br><span class="line">                <span class="title function_">result</span>(<span class="literal">false</span>)</span><br><span class="line">                <span class="keyword">return</span> uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="string">&#x27;上传失败&#x27;</span>,</span><br><span class="line">                    <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> message = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(res.<span class="property">data</span>)</span><br><span class="line">            <span class="title function_">result</span>(message.<span class="property">data</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">            <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    uploadTask.<span class="title function_">onProgressUpdate</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> onProgress === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">            <span class="title function_">onProgress</span>(res.<span class="property">progress</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">baseUrl</span>:<span class="string">&quot;http://liveapi2.laoxu.cn&quot;</span>,</span><br><span class="line">  <span class="attr">socketUrl</span>:<span class="string">&quot;http://liveapi2.laoxu.cn&quot;</span>,</span><br><span class="line">  <span class="attr">imageUrl</span>:<span class="string">&quot;http://liveapi2.laoxu.cn&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拉流前缀</span></span><br><span class="line">  <span class="attr">livePlayBaseUrl</span>:<span class="string">&quot;http://liveapi2.laoxu.cn:23481&quot;</span>,</span><br><span class="line">  <span class="comment">// 推流前缀</span></span><br><span class="line">  <span class="attr">livePushBaseUrl</span>:<span class="string">&quot;rtmp://liveapi2.laoxu.cn:23480&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="退出登陆">退出登陆</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">logout</span>(<span class="params">&#123; commit &#125;</span>) &#123;</span><br><span class="line">    uni.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;提示&quot;</span>,</span><br><span class="line">      <span class="attr">content</span>: <span class="string">&quot;是否退出登录&quot;</span>,</span><br><span class="line">      <span class="attr">showCancel</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">cancelText</span>: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">      <span class="attr">confirmText</span>: <span class="string">&quot;确认&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">async</span> (res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">confirm</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> res = <span class="keyword">await</span> http.<span class="title function_">get</span>(<span class="string">&quot;/logout&quot;</span>, &#123; <span class="attr">token</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">          <span class="title function_">commit</span>(<span class="string">&quot;LOGOUT&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h5 id="权限验证-2">权限验证</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/index.js</span></span><br><span class="line"><span class="title function_">authJump</span>(<span class="params">&#123; state &#125;, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!state.<span class="property">token</span>) &#123;</span><br><span class="line">      uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&quot;请先登录&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      uni.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;/pages/login/login&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line"> &#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证场景比如: 进入直播间、发布弹幕</span></span><br></pre></td></tr></table></figure>
<h5 id="首页渲染">首页渲染</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 轮播图 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">swiper</span> <span class="attr">:indicator-dots</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:autoplay</span>=<span class="string">&quot;true&quot;</span> <span class="attr">:interval</span>=<span class="string">&quot;3000&quot;</span> <span class="attr">:duration</span>=<span class="string">&quot;200&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/img/banner/1.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;../../static/img/banner/2.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 250rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">swiper</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 列表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">v-for</span>=<span class="string">&quot;item in liveList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openLive(item.id)&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">style</span>=<span class="string">&quot;width: 375rpx; padding: 5rpx;box-sizing: border-box; position: relative;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.cover ? $C.baseURL + item.cover : &#x27;../../static/img/1.jpg&#x27;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;width: 365rpx; height: 365rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded&quot;</span> <span class="attr">mode</span>=<span class="string">&quot;aspectFill&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;position: absolute;left: 15rpx;top: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont text-warning mr-1&quot;</span>&gt;</span><span class="symbol">&amp;#xe631;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;position: absolute;right: 15rpx;top: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font-sm text-white&quot;</span>&gt;</span>人气：<span class="tag">&lt;/<span class="name">text</span>&gt;</span><span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>&#123;&#123;item.look_count&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;position: absolute;left: 15rpx;bottom: 15rpx;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>&#123;&#123;item.title&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle px-2 flex align-center&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;position: absolute;right: 15rpx;bottom: 15rpx;background-color: rgba(0,0,0,0.4);&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">style</span>=<span class="string">&quot;width: 20rpx;height: 20rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle mr-1&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">:class</span>=<span class="string">&quot;item.status == 1 ? &#x27;bg-success&#x27; : &#x27;bg-danger&#x27;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>&#123;&#123; item.status | statusText &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 加载更多 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;f-divider&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex text-center justify-center py-3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-secondary&quot;</span>&gt;</span>&#123;&#123;loadingText&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;@/common/request.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> $C <span class="keyword">from</span> <span class="string">&#x27;@/common/config.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">filters</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">statusText</span>(<span class="params">val</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> obj = &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="number">0</span>: <span class="string">&#x27;未开播&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="number">1</span>: <span class="string">&#x27;直播中&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="number">2</span>: <span class="string">&#x27;暂停直播&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="number">3</span>: <span class="string">&#x27;直播结束&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> obj[val]</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 直播间列表</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">liveList</span>: [],</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">page</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">limit</span>: <span class="number">6</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">totalPage</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">$C</span>: <span class="literal">null</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 上拉加载更多 加载中 加载完成</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">loadingText</span>: <span class="string">&quot;上拉加载更多&quot;</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 右上角按钮的监听事件</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onNavigationBarButtonTap</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// e.index 是你点击的按钮的索引</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// if (e.index === 0) &#123;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 	// 这里处理你的点击事件</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 	console.log(&#x27;左侧按钮被点击&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// &#125; else if (e.index === 1) &#123;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 	console.log(&#x27;右侧按钮被点击&#x27;);</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// &#125;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">index</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onShow</span>(<span class="params"></span>) &#123; </span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">getLiveList</span>()</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="property">$C</span> = $C</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 下拉刷新</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onPullDownRefresh</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">1</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">getLiveList</span>() </span></span><br><span class="line"><span class="language-javascript">    uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">title</span>: <span class="string">&#x27;刷新成功&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">icon</span>: <span class="string">&quot;success&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">complete</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            uni.<span class="title function_">stopPullDownRefresh</span>()</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 上拉触底</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onReachBottom</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">loadingText</span> == <span class="string">&#x27;上拉加载更多&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">loadingText</span> = <span class="string">&quot;加载中...&quot;</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">page</span>++</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="title function_">getLiveList</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 跳转到直播间</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openLive</span>(<span class="params">id</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        uni.<span class="title function_">navigateTo</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/pages/live/live?id=&quot;</span>+ id</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 获取直播间列表</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">async</span> <span class="title function_">getLiveList</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> res = <span class="keyword">await</span> http.<span class="title function_">get</span>(<span class="string">`/live/list?page=<span class="subst">$&#123;<span class="variable language_">this</span>.page&#125;</span>&amp;limit=<span class="subst">$&#123;<span class="variable language_">this</span>.limit&#125;</span>`</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 第一页直接赋值 其它页追加</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">liveList</span> = <span class="variable language_">this</span>.<span class="property">page</span> == <span class="number">1</span> ? res.<span class="property">list</span>.<span class="property">rows</span> : [...<span class="variable language_">this</span>.<span class="property">liveList</span>, ...res.<span class="property">list</span>.<span class="property">rows</span>]</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">loadingText</span> = <span class="variable language_">this</span>.<span class="property">page</span> &gt; res.<span class="property">totalPage</span> ? <span class="string">&quot;全部加载完成&quot;</span>: <span class="string">&quot;上拉加载更多&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">page</span> &gt; <span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">page</span>--</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">loadingText</span> = <span class="string">&quot;上拉加载更多&quot;</span>   </span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="直播间">直播间</h5>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;page&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">class</span>=<span class="string">&quot;flex-1&quot;</span> <span class="attr">:src</span>=<span class="string">&quot;url&quot;</span> <span class="attr">autoplay</span> <span class="attr">:is-live</span>=<span class="string">&quot;true&quot;</span> <span class="attr">controls</span> <span class="attr">style</span>=<span class="string">&quot;width: 100%;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 头部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed;left: 0;right: 0;&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 个人信息 观看详细信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;px-2 flex justify-between align-center&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 左边 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">&quot;flex flex-row justify-between align-center rounded-circle&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p flex-row&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">image</span> <span class="attr">src</span>=<span class="string">&quot;/static/tabbar/min.png&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>&#123;&#123;liveInfo.user &amp;&amp; liveInfo.user.username&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center justify-center bg-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white text-center&quot;</span>&gt;</span>+<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 右边 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 实时在线观看用户情况 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scroll-view</span> <span class="attr">scroll-x</span>=<span class="string">&quot;true&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;item in list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;i&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.avatar ? &#x27;http://192.168.1.197:7001&#x27;+item.avatar: &#x27;/static/tabbar/min.png&#x27;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">scroll-view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;rounded-circle flex align-center justify-center bg-danger&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 70rpx;height: 70rpx;&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 实时在线观看人数 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font-sm&quot;</span>&gt;</span>&#123;&#123; list.length &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 金币 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 金币 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;px-2 my-2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 325rpx;background-color: rgba(0,0,0,0.4);&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex rounded-circle align-center&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;p&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning&quot;</span>&gt;</span>金币<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex-1 flex flex-column justify-center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-white font&quot;</span>&gt;</span>&#123;&#123;coin&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 收到的礼物 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 500rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 发送礼物的组件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">gift</span> <span class="attr">ref</span>=<span class="string">&quot;gift&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">gift</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 弹幕 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;position: fixed; bottom: 120rpx; left: 0; right: 0; width: 520rpx; height: 300rpx;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">brrage</span> <span class="attr">ref</span>=<span class="string">&quot;brrage&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">brrage</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 底部 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bnav</span> @<span class="attr">showBrrage</span>=<span class="string">&quot;showBrrage&quot;</span> @<span class="attr">openGift</span>=<span class="string">&quot;openGift&quot;</span> @<span class="attr">openCoin</span>=<span class="string">&quot;openCoin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bnav</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 弹幕的弹出组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">ref</span>=<span class="string">&quot;popup&quot;</span> <span class="attr">background-color</span>=<span class="string">&quot;#fff&quot;</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white flex align-center px-3&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 120rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;content&quot;</span> <span class="attr">class</span>=<span class="string">&quot;border rounded flex-1 px-3 font-md&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;说点什么...&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;height: 80rpx;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 ml-3 rounded&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">:class</span>=<span class="string">&quot;content === &#x27;&#x27; ? &#x27;bg-main-disabled&#x27; : &#x27;bg-main&#x27;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;sendBrrage&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-white&quot;</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 送礼物弹出层 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uni-popup</span> <span class="attr">type</span>=<span class="string">&quot;bottom&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;giftPopup&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;bg-white&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 750rpx;height: 550rpx;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex justify-between align-center&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-main font-md ml-3&quot;</span>&gt;</span>礼物<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100rpx;height: 100rpx;&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;closeGift&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;iconfont&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: black;&quot;</span>&gt;</span><span class="symbol">&amp;#xeaf2;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">swiper</span> <span class="attr">:duration</span>=<span class="string">&quot;500&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 350rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;border-bottom border-top&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-wrap&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;width: 187.5rpx;height: 175rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex flex-column justify-center align-center&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">v-for</span>=<span class="string">&quot;(item,index) in gifts&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;index&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;giftActiveId === item.id ? &#x27;border border-main&#x27; : &#x27;&#x27;&quot;</span></span></span><br><span class="line"><span class="tag">                        @<span class="attr">click</span>=<span class="string">&quot;giftActiveId = item.id&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">image</span> <span class="attr">:src</span>=<span class="string">&quot;item.image&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 100rpx;height: 100rpx;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex mt-1&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-warning font mr-1&quot;</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;text-secondary font&quot;</span>&gt;</span>&#123;&#123;item.coin&#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">swiper-item</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">swiper</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">view</span> <span class="attr">style</span>=<span class="string">&quot;height: 100rpx;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-end&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 mr-3 rounded bg-warning&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;openCoin&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font&quot;</span>&gt;</span>充值<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;flex align-center justify-center py-2 px-2 mr-3 rounded bg-main&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;sendGift&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;font text-white&quot;</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">uni-popup</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> gifts <span class="keyword">from</span> <span class="string">&#x27;../../common/gifts.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&#x27;@/common/request.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> $C <span class="keyword">from</span> <span class="string">&#x27;@/common/config.js&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; mapState &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        gifts,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">giftActiveId</span>: <span class="number">1</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">coin</span>: <span class="number">0</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">liveInfo</span>: &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">sign</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">live_id</span>: <span class="string">&#x27;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 存储在线用户</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">list</span>: []</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">computed</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">url</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> $C.<span class="property">baseURL</span> + <span class="variable language_">this</span>.<span class="property">liveInfo</span>.<span class="property">key</span> + <span class="string">&#x27;.flv?sign=&#x27;</span> + <span class="variable language_">this</span>.<span class="property">sign</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    ...<span class="title function_">mapState</span>([<span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;token&#x27;</span>])</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">onLoad</span>(<span class="params">options</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="property">live_id</span> = options.<span class="property">id</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">getLiveInfo</span>(options.<span class="property">id</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 加入直播间</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">joinOrLeaveLive</span>(<span class="string">&#x27;join&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 监听所有的回调</span></span></span><br><span class="line"><span class="language-javascript">    uni.$on(<span class="string">&quot;eventHandler&quot;</span>, <span class="variable language_">this</span>.<span class="property">eventHandler</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">destroyed</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">this</span>.<span class="title function_">joinOrLeaveLive</span>(<span class="string">&#x27;leave&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">methods</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 加入直播间</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">joinOrLeaveLive</span>(<span class="params">type</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">socket</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">token</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(type + <span class="string">&#x27;Live&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">live_id</span>: <span class="variable language_">this</span>.<span class="property">live_id</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">token</span>: <span class="variable language_">this</span>.<span class="property">token</span></span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">eventHandler</span>(<span class="params">res</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> that = <span class="variable language_">this</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> data = res.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">switch</span> (res.<span class="property">action</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">&#x27;join&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">list</span> = data</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">coin</span> = res.<span class="property">user</span>.<span class="property">coin</span></span></span><br><span class="line"><span class="language-javascript">                uni.<span class="title function_">showToast</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">title</span>: res.<span class="property">user</span>.<span class="property">name</span> + <span class="string">&#x27;加入直播间&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">&#x27;leave&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">                that.<span class="property">$refs</span>.<span class="property">brrage</span>.<span class="title function_">sendBrrage</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">id</span>: res.<span class="property">user</span>.<span class="property">id</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">username</span>: res.<span class="property">user</span>.<span class="property">name</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">content</span>: res.<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 清空输入框</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">content</span> = <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 关闭弹幕弹出层</span></span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">case</span> <span class="string">&#x27;gift&#x27;</span>:</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">gift</span>.<span class="title function_">sendGift</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">id</span>: res.<span class="property">id</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">username</span>: res.<span class="property">username</span>, </span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">avatar</span>: $C.<span class="property">baseURL</span> + res.<span class="property">avatar</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">gift</span>: res.<span class="property">gift_name</span>, </span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">giftImg</span>: $C.<span class="property">baseURL</span> + res.<span class="property">gift_image</span>.<span class="title function_">replace</span>(<span class="string">&#x27;undefined&#x27;</span>, <span class="string">&#x27;&#x27;</span>), </span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">giftNum</span>: res.<span class="property">num</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">this</span>.<span class="title function_">closeGift</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">default</span>:</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">break</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 获取直播间信息</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">async</span> <span class="title function_">getLiveInfo</span>(<span class="params">id</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> res = <span class="keyword">await</span> http.<span class="title function_">get</span>(<span class="string">&#x27;/live/read/&#x27;</span> + id)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">liveInfo</span> = res.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">sign</span> = res.<span class="property">sign</span></span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 发送弹幕</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">sendBrrage</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">content</span>.<span class="title function_">trim</span>() == <span class="string">&#x27;&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 将用户输入的内容发送给服务端</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;comment&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">live_id</span>: <span class="variable language_">this</span>.<span class="property">live_id</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">token</span>: <span class="variable language_">this</span>.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 发送礼物</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">sendGift</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> gift = <span class="variable language_">this</span>.<span class="property">gifts</span>.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">id</span> == <span class="variable language_">this</span>.<span class="property">giftActiveId</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">emit</span>(<span class="string">&#x27;gift&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">live_id</span>: <span class="variable language_">this</span>.<span class="property">live_id</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">token</span>: <span class="variable language_">this</span>.<span class="property">token</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">gift_id</span>: gift.<span class="property">id</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 显示弹幕</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">showBrrage</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&#x27;authJump&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">popup</span>.<span class="title function_">open</span>(<span class="string">&#x27;bottom&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 显示送礼弹出层</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openGift</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">giftPopup</span>.<span class="title function_">open</span>(<span class="string">&#x27;bottom&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 关闭送礼</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">closeGift</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">giftPopup</span>.<span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">    &#125;,</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 打开充值</span></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">openCoin</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        uni.<span class="title function_">navigateTo</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/pages/coin/coin&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.page</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">flex</span>: <span class="number">1</span>;</span></span><br><span class="line"><span class="language-css">  <span class="comment">/* #ifdef H5 */</span></span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">100vh</span>;</span></span><br><span class="line"><span class="language-css">  <span class="comment">/* #endif */</span></span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="store-js">store.js</h5>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io <span class="keyword">from</span> <span class="string">&quot;@/common/uni-socket.io.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接socket</span></span><br><span class="line"><span class="title function_">connectSocket</span>(<span class="params">&#123; state &#125;</span>) &#123;</span><br><span class="line"><span class="keyword">let</span> socket = <span class="title function_">io</span>($C.<span class="property">baseURL</span>, &#123;</span><br><span class="line">  <span class="attr">query</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">transports</span>: [<span class="string">&quot;websocket&quot;</span>],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听在线人数的回调</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">onLineHandler</span> = (<span class="params">res</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// let &#123; user, data &#125; = res</span></span><br><span class="line">  <span class="comment">// console.log(res);</span></span><br><span class="line">  uni.$emit(<span class="string">&quot;eventHandler&quot;</span>, res);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听评论的回调</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">commentHandler</span> = (<span class="params">res</span>) =&gt; &#123;</span><br><span class="line">  uni.$emit(<span class="string">&quot;eventHandler&quot;</span>, res);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听礼物的回调</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">giftHandler</span> = (<span class="params">res</span>) =&gt; &#123;</span><br><span class="line">  uni.$emit(<span class="string">&quot;eventHandler&quot;</span>, res);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&quot;connect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = socket.<span class="property">id</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接成功&quot;</span>, id);</span><br><span class="line">  <span class="comment">// 保存socket实例</span></span><br><span class="line">  state.<span class="property">socket</span> = socket;</span><br><span class="line">  <span class="comment">// 监听直播间的错误提示</span></span><br><span class="line">  socket.<span class="title function_">on</span>(id, <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; data &#125; = msg;</span><br><span class="line">    <span class="comment">// 除了开播以外的状态 都提示</span></span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">action</span> == <span class="string">&quot;error&quot;</span>) &#123;</span><br><span class="line">      uni.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">        <span class="attr">icon</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="attr">title</span>: data.<span class="property">payload</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听在线人数</span></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&quot;online&quot;</span>, onLineHandler);</span><br><span class="line">  <span class="comment">// 监听评论</span></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&quot;comment&quot;</span>, commentHandler);</span><br><span class="line">  <span class="comment">// 监听礼物</span></span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&quot;gift&quot;</span>, giftHandler);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除事件监听</span></span><br><span class="line"><span class="keyword">const</span> remove = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  socket.<span class="title function_">removeEventListener</span>(<span class="string">&quot;online&quot;</span>, onLineHandler);</span><br><span class="line">  socket.<span class="title function_">removeEventListener</span>(<span class="string">&quot;comment&quot;</span>, commentHandler);</span><br><span class="line">  socket.<span class="title function_">removeEventListener</span>(<span class="string">&quot;gift&quot;</span>, giftHandler);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&quot;disconnect&quot;</span>, <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">  state.<span class="property">socket</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 移除所有监听的事件</span></span><br><span class="line">  <span class="title function_">remove</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;断开连接&quot;</span>, msg);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">socket.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接错误&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

     <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px; padding-top: 10px;"> <i class="fa fa-heart"></i>--------------------------------------- The End ---------------------------------------<i class="fa fa-heart"></i>  </div>
    
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>老许
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/" title="uniapp 学习">https://github.com/xuwanghui/blog.git/2024/11/27/uniapp/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/uniapp/" rel="tag"><i class="fa fa-tag"></i> uniapp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/11/27/ts/" rel="prev" title="ts 学习">
      <i class="fa fa-chevron-left"></i> ts 学习
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/11/27/vue2/" rel="next" title="vue2 学习">
      vue2 学习 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#uniapp%E7%9B%B4%E6%92%ADapp%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91"><span class="nav-number">1.</span> <span class="nav-text">uniapp直播app全栈开发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E5%A4%A7%E7%BA%B2"><span class="nav-number">2.</span> <span class="nav-text">课程大纲</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BE%E7%A8%8B%E7%89%B9%E8%89%B2"><span class="nav-number">3.</span> <span class="nav-text">课程特色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="nav-number">4.</span> <span class="nav-text">前端项目创建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.</span> <span class="nav-text">底部导航栏配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A6%96%E9%A1%B5%E5%BC%80%E5%8F%91"><span class="nav-number">4.2.</span> <span class="nav-text">首页开发</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E5%BC%80%E5%8F%91"><span class="nav-number">4.3.</span> <span class="nav-text">直播间开发</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%B8%83%E5%B1%80"><span class="nav-number">4.3.1.</span> <span class="nav-text">基础布局</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF%E5%92%8C%E8%A7%82%E7%9C%8B%E6%83%85%E5%86%B5"><span class="nav-number">4.3.2.</span> <span class="nav-text">个人信息和观看情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%87%91%E5%B8%81"><span class="nav-number">4.3.3.</span> <span class="nav-text">金币</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E7%A4%BC%E7%89%A9%E7%BB%84%E4%BB%B6"><span class="nav-number">4.3.4.</span> <span class="nav-text">接收礼物组件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B0%81%E8%A3%85%E6%8E%A5%E6%94%B6%E7%A4%BC%E7%89%A9%E7%BB%84%E4%BB%B6"><span class="nav-number">4.3.5.</span> <span class="nav-text">封装接收礼物组件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F"><span class="nav-number">4.3.6.</span> <span class="nav-text">底部导航栏</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AF%BC%E8%88%AA%E6%A0%8F%E5%85%B3%E9%97%AD%E6%8C%89%E9%92%AE"><span class="nav-number">4.3.7.</span> <span class="nav-text">导航栏关闭按钮</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%B9%E5%B9%95%E7%BB%84%E4%BB%B6"><span class="nav-number">4.3.8.</span> <span class="nav-text">弹幕组件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%81%E7%A4%BC%E7%89%A9%E7%BB%84%E4%BB%B6"><span class="nav-number">4.3.9.</span> <span class="nav-text">送礼物组件</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%85%E5%80%BC%E9%87%91%E5%B8%81%E9%A1%B5"><span class="nav-number">4.4.</span> <span class="nav-text">充值金币页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%B4%E6%92%AD%E9%A1%B5"><span class="nav-number">4.5.</span> <span class="nav-text">创建直播页</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E6%8E%A8%E6%B5%81%E7%BB%84%E4%BB%B6"><span class="nav-number">4.5.1.</span> <span class="nav-text">直播推流组件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%A1%B5%E5%B8%83%E5%B1%80"><span class="nav-number">4.5.2.</span> <span class="nav-text">直播页布局</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%95%9C%E5%A4%B4%E7%BF%BB%E8%BD%AC"><span class="nav-number">4.5.3.</span> <span class="nav-text">镜头翻转</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%94%BB%E8%B4%A8%E5%88%87%E6%8D%A2"><span class="nav-number">4.5.4.</span> <span class="nav-text">画质切换</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BE%8E%E9%A2%9C%E7%BE%8E%E7%99%BD"><span class="nav-number">4.5.5.</span> <span class="nav-text">美颜美白</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E9%BB%91%E8%BE%B9%E9%97%AE%E9%A2%98"><span class="nav-number">4.5.6.</span> <span class="nav-text">退出黑边问题</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BB%E6%92%AD%E7%9B%B4%E6%92%AD%E9%97%B4"><span class="nav-number">4.6.</span> <span class="nav-text">主播直播间</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%90%BA%E5%B8%A6%E5%8F%82%E6%95%B0%E8%B7%B3%E8%BD%AC"><span class="nav-number">4.6.1.</span> <span class="nav-text">携带参数跳转</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E5%B8%83%E5%B1%80"><span class="nav-number">4.6.2.</span> <span class="nav-text">直播间布局</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83"><span class="nav-number">4.7.</span> <span class="nav-text">个人中心</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#list-item-vue"><span class="nav-number">4.7.1.</span> <span class="nav-text">list-item.vue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="nav-number">5.</span> <span class="nav-text">后端项目创建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#egg%E5%9F%BA%E7%A1%80%E8%AE%B2%E8%A7%A3"><span class="nav-number">5.1.</span> <span class="nav-text">egg基础讲解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">5.2.</span> <span class="nav-text">创建控制器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%BC%96%E5%86%99%E6%8E%A5%E5%8F%A3"><span class="nav-number">5.3.</span> <span class="nav-text">路由编写接口</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E4%BC%A0%E5%8F%82%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">5.3.1.</span> <span class="nav-text">路由传参两种方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%B3%E9%97%ADcsrf%E5%BC%80%E5%90%AF%E8%B7%A8%E5%9F%9F"><span class="nav-number">5.3.2.</span> <span class="nav-text">关闭csrf开启跨域</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E8%B7%AF%E7%94%B1"><span class="nav-number">5.3.3.</span> <span class="nav-text">资源路由</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="nav-number">5.3.4.</span> <span class="nav-text">路由分组</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="nav-number">5.4.</span> <span class="nav-text">数据库迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8CMigrations"><span class="nav-number">5.4.1.</span> <span class="nav-text">初始化数据库和Migrations</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.5.</span> <span class="nav-text">模型</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="nav-number">5.5.1.</span> <span class="nav-text">创建模型</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-number">5.5.2.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="nav-number">5.5.3.</span> <span class="nav-text">修改器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8"><span class="nav-number">5.5.4.</span> <span class="nav-text">获取器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E5%88%9B%E5%BB%BA"><span class="nav-number">5.5.5.</span> <span class="nav-text">批量创建</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.5.6.</span> <span class="nav-text">主键查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8D%95%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="nav-number">5.5.7.</span> <span class="nav-text">查询单个用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%9A%E4%B8%AA%E7%94%A8%E6%88%B7"><span class="nav-number">5.5.8.</span> <span class="nav-text">查询多个用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="nav-number">5.5.9.</span> <span class="nav-text">分页查询</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#where%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">5.5.10.</span> <span class="nav-text">where操作符</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E9%99%90%E5%88%B6-%E6%8E%92%E5%BA%8F"><span class="nav-number">5.5.11.</span> <span class="nav-text">字段限制&amp;排序</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%92%8C%E9%99%90%E5%88%B6%E5%AD%97%E6%AE%B5"><span class="nav-number">5.5.12.</span> <span class="nav-text">修改和限制字段</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%92%8C%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="nav-number">5.5.13.</span> <span class="nav-text">删除和批量删除</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">5.6.</span> <span class="nav-text">错误和异常处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">5.7.</span> <span class="nav-text">中间件配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81"><span class="nav-number">5.8.</span> <span class="nav-text">参数验证</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E5%90%8E%E5%8F%B0%E7%BC%96%E5%86%99"><span class="nav-number">6.</span> <span class="nav-text">直播后台编写</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="nav-number">6.1.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%A8%E5%9F%9F%E9%85%8D%E7%BD%AE"><span class="nav-number">6.2.</span> <span class="nav-text">跨域配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E7%9B%B8%E5%85%B3"><span class="nav-number">6.3.</span> <span class="nav-text">全局相关</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%B0%81%E8%A3%85api%E8%BF%94%E5%9B%9E%E6%A0%BC%E5%BC%8F%E6%89%A9%E5%B1%95"><span class="nav-number">6.3.1.</span> <span class="nav-text">封装api返回格式扩展</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">6.3.2.</span> <span class="nav-text">全局抛出异常处理</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#sequelize%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="nav-number">6.3.3.</span> <span class="nav-text">sequelize数据库配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E9%85%8D%E7%BD%AE"><span class="nav-number">6.3.4.</span> <span class="nav-text">数据库迁移配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E5%85%B3%E8%81%94"><span class="nav-number">6.3.5.</span> <span class="nav-text">模型关联</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="nav-number">6.3.6.</span> <span class="nav-text">模板引擎</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E9%AA%8C%E8%AF%81-2"><span class="nav-number">6.3.7.</span> <span class="nav-text">参数验证</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E6%A8%A1%E5%9D%97"><span class="nav-number">6.4.</span> <span class="nav-text">管理员模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">6.4.1.</span> <span class="nav-text">创建管理员</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E5%88%97%E8%A1%A8"><span class="nav-number">6.4.2.</span> <span class="nav-text">管理员列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">6.4.3.</span> <span class="nav-text">修改管理员</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%AE%A1%E7%90%86%E5%91%98"><span class="nav-number">6.4.4.</span> <span class="nav-text">删除管理员</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97"><span class="nav-number">6.5.</span> <span class="nav-text">登录模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="nav-number">6.5.1.</span> <span class="nav-text">权限验证</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95"><span class="nav-number">6.5.2.</span> <span class="nav-text">退出登录</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97"><span class="nav-number">6.6.</span> <span class="nav-text">公共模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BE%A7%E8%BE%B9%E6%A0%8F"><span class="nav-number">6.6.1.</span> <span class="nav-text">侧边栏</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="nav-number">6.6.2.</span> <span class="nav-text">上传图片</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E5%92%8C%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98"><span class="nav-number">6.7.</span> <span class="nav-text">创建订单和微信支付</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E7%A7%BB%E5%8A%A8%E7%AB%AF%E8%BF%98%E6%98%AFpc%E7%AB%AF"><span class="nav-number">6.8.</span> <span class="nav-text">判断移动端还是pc端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="nav-number">6.9.</span> <span class="nav-text">用户模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7-2"><span class="nav-number">6.9.1.</span> <span class="nav-text">创建用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8"><span class="nav-number">6.9.2.</span> <span class="nav-text">用户列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E7%94%A8%E6%88%B7"><span class="nav-number">6.9.3.</span> <span class="nav-text">编辑用户</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="nav-number">6.9.4.</span> <span class="nav-text">删除用户</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A4%BC%E7%89%A9%E6%A8%A1%E5%9D%97"><span class="nav-number">6.10.</span> <span class="nav-text">礼物模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%A4%BC%E7%89%A9"><span class="nav-number">6.10.1.</span> <span class="nav-text">创建礼物</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BC%E7%89%A9%E5%88%97%E8%A1%A8"><span class="nav-number">6.10.2.</span> <span class="nav-text">礼物列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%A4%BC%E7%89%A9"><span class="nav-number">6.10.3.</span> <span class="nav-text">修改礼物</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%A4%BC%E7%89%A9"><span class="nav-number">6.10.4.</span> <span class="nav-text">删除礼物</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E6%A8%A1%E5%9D%97"><span class="nav-number">6.11.</span> <span class="nav-text">直播间模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E5%88%97%E8%A1%A8"><span class="nav-number">6.11.1.</span> <span class="nav-text">直播间列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E8%A7%82%E7%9C%8B%E6%83%85%E5%86%B5"><span class="nav-number">6.11.2.</span> <span class="nav-text">直播间观看情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E7%A4%BC%E7%89%A9%E6%83%85%E5%86%B5"><span class="nav-number">6.11.3.</span> <span class="nav-text">直播间礼物情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E8%AF%84%E8%AE%BA%E6%83%85%E5%86%B5"><span class="nav-number">6.11.4.</span> <span class="nav-text">直播间评论情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%85%B3%E9%97%AD%E7%9B%B4%E6%92%AD%E9%97%B4"><span class="nav-number">6.11.5.</span> <span class="nav-text">关闭直播间</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="nav-number">6.12.</span> <span class="nav-text">订单模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E5%88%97%E8%A1%A8"><span class="nav-number">6.12.1.</span> <span class="nav-text">订单列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E8%AE%A2%E5%8D%95"><span class="nav-number">6.12.2.</span> <span class="nav-text">删除订单</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Api%E5%BC%80%E5%8F%91-%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9D%97"><span class="nav-number">6.13.</span> <span class="nav-text">Api开发-用户模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C"><span class="nav-number">6.13.1.</span> <span class="nav-text">用户注册</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95"><span class="nav-number">6.13.2.</span> <span class="nav-text">用户登录</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">6.13.3.</span> <span class="nav-text">权限验证中间件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95-2"><span class="nav-number">6.13.4.</span> <span class="nav-text">退出登录</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-number">6.13.5.</span> <span class="nav-text">获取当前用户的信息</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Api%E5%BC%80%E5%8F%91-%E7%9B%B4%E6%92%AD%E9%97%B4%E6%A8%A1%E5%9D%97"><span class="nav-number">6.14.</span> <span class="nav-text">Api开发-直播间模块</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%B4%E6%92%AD%E9%97%B4"><span class="nav-number">6.14.1.</span> <span class="nav-text">创建直播间</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%9B%B4%E6%92%AD%E9%97%B4%E7%8A%B6%E6%80%81"><span class="nav-number">6.14.2.</span> <span class="nav-text">修改直播间状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4%E5%88%97%E8%A1%A8-2"><span class="nav-number">6.14.3.</span> <span class="nav-text">直播间列表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E7%9B%B4%E6%92%AD%E9%97%B4"><span class="nav-number">6.14.4.</span> <span class="nav-text">查看指定直播间</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E7%9B%B4%E6%92%AD%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">6.14.5.</span> <span class="nav-text">搭建直播服务器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#socket-io%E5%AE%89%E8%A3%85%E5%92%8C%E9%80%9A%E8%AE%AF"><span class="nav-number">6.14.6.</span> <span class="nav-text">socket.io安装和通讯</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#uniapp-%E7%99%BB%E5%BD%95"><span class="nav-number">6.15.</span> <span class="nav-text">uniapp-登录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E9%99%86"><span class="nav-number">6.16.</span> <span class="nav-text">退出登陆</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81-2"><span class="nav-number">6.17.</span> <span class="nav-text">权限验证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%A6%96%E9%A1%B5%E6%B8%B2%E6%9F%93"><span class="nav-number">6.18.</span> <span class="nav-text">首页渲染</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%9B%B4%E6%92%AD%E9%97%B4"><span class="nav-number">6.19.</span> <span class="nav-text">直播间</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#store-js"><span class="nav-number">6.20.</span> <span class="nav-text">store.js</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="老许"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">老许</p>
  <div class="site-description" itemprop="description">当学习成为了习惯<br/>知识也就变成了常识</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xuwanghui" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xuwanghui"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/xu_wang_hui@163.com" title="E-Mail → xu_wang_hui@163.com"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/yourname" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=110 src="//music.163.com/outchain/player?type=0&id=7515636986&auto=1&height=90"></iframe>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer" style="text-align:center">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">老许</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">997k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:07</span>
</div>

<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date(); 
    function createtime() { 
        var grt= new Date("03/12/2022 17:00:00");//在此处修改你的建站时间，格式：月/日/年 时:分:秒
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








        <a href="https://beian.miit.gov.cn/" target="_blank" style='color: #999999;text-decoration: none;'>京ICP备2021019190号-1</a>
      </div>
    </footer>
  </div>

  
  
  <script color='51,51,51' opacity='0.5' zIndex='-1' count='66' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '6mmQGNuthx4k1dsbW9UKhHGT-gzGzoHsz',
      appKey     : 'gXfUEGyEXIARBJjK2K53R51P',
      placeholder: "填写正确的邮箱可及时收到回复提醒哈 ~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

    </div>

</body>
</html>
<script type="text/javascript" src="/js/clicklove.js"></script>
